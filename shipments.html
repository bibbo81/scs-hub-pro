<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Registro Centrale Spedizioni</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    
    <link rel="stylesheet" href="/assets/css/solarium.css">
    
    <link rel="stylesheet" href="/core/modal-system.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <script type="module">
        // Import core modules IDENTICI a tracking.html
        import api from '/core/api-client.js';
        import headerComponent from '/core/header-component.js';
        import notificationSystem from '/core/notification-system.js';
        import modalSystem from '/core/modal-system.js';
        import organizationService from '/core/services/organization-service.js';
        import { supabase } from '/core/services/supabase-client.js';
        import supabaseShipmentsService from '/core/services/supabase-shipments-service.js';

        // Make modules available globally
        window.api = api;
        window.headerComponent = headerComponent;
        window.NotificationSystem = notificationSystem;
        window.ModalSystem = modalSystem;
        window.organizationService = organizationService;
        window.supabase = supabase;
        window.supabaseShipmentsService = supabaseShipmentsService;

        // Initialize header after globals are set
        headerComponent.init();
    </script>
    
    <script src="/core/product-sync.js"></script>

    <script src="/core/auth.js"></script>
    <script src="/core/auth-init.js"></script>
    <script src="/core/import-manager.js"></script>
    <script src="/core/export-manager.js"></script>
    <script src="/core/product-linking-system-v20-1-final.js"></script>
    <script src="/core/products-link-filters-fix.js"></script>
    <script src="/core/reset-button-visibility-fix.js"></script>
   <script src="/core/simple-rollback-fix.js"></script>
    <script type="module" src="/core/auto-sync-system.js"></script>
    <script src="/phase2-architecture.js"></script>
    <script src="/core/shipments-registry.js"></script>
    <script src="/pages/shipments/registry-core.js"></script>
    <script src="/pages/shipments/shipments-details.js"></script>
    <script src="/pages/shipments/cost-allocation.js"></script>
    <script src="/pages/shipments/carrier-performance.js"></script>
    <script src="/pages/shipments/executive-bi-dashboard.js"></script>

    <style>
        /* ===== FIX TABLE STYLES - ALLINEAMENTO CON SOLARIUM DESIGN SYSTEM ===== */
        #shipmentsTable {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1400px; /* Minimum width for horizontal scroll */
        }
        
        #shipmentsTable thead {
            background: var(--sol-gray-50);
            border-bottom: 2px solid var(--sol-gray-200);
        }
        
        #shipmentsTable th {
            padding: 1rem 1.25rem;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--sol-gray-600);
            text-align: left;
            white-space: nowrap;
            position: sticky;
            top: 0;
            background: var(--sol-gray-50);
            z-index: 10;
        }
        
        #shipmentsTable td {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid var(--sol-gray-100);
            vertical-align: middle;
        }
        
        #shipmentsTable tbody tr {
            transition: background-color var(--sol-transition-fast);
        }
        
        #shipmentsTable tbody tr:hover {
            background-color: var(--sol-gray-50);
        }
        
        #shipmentsTable tbody tr.selected {
            background-color: var(--sol-primary-light);
        }
        
        /* Stili specifici per colonne */
        .font-mono {
            font-family: var(--sol-font-mono);
            font-size: 0.875rem;
        }
        
        /* Fix button group spacing */
        .btn-group {
            display: flex;
            gap: 0.25rem;
        }
        
        /* Status badge improvements */
        .sol-badge {
            font-size: 0.6875rem;
            padding: 0.25rem 0.625rem;
            font-weight: 600;
            letter-spacing: 0.025em;
        }
        
        /* ===== TABLE WRAPPER CON SCROLL ORIZZONTALE ===== */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            background: white;
            border-radius: var(--sol-radius-lg);
            box-shadow: var(--sol-shadow-sm);
        }
        
        /* Sticky First Column */
        #shipmentsTable th:first-child,
        #shipmentsTable td:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        }
        
        #shipmentsTable th:first-child {
            background: var(--sol-gray-50);
            z-index: 11;
        }
        
        /* Sticky Last Column (Actions) */
        #shipmentsTable th:last-child,
        #shipmentsTable td:last-child {
            position: sticky;
            right: 0;
            background: white;
            z-index: 5;
            box-shadow: -2px 0 4px rgba(0,0,0,0.05);
        }
        
        #shipmentsTable th:last-child {
            background: var(--sol-gray-50);
            z-index: 11;
        }
        
        /* Scrollbar personalizzata */
        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: var(--sol-gray-100);
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--sol-gray-400);
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--sol-gray-500);
        }
        
        /* Mobile optimization */
        @media (max-width: 768px) {
            #shipmentsTable {
                font-size: 0.875rem;
            }
            
            #shipmentsTable th,
            #shipmentsTable td {
                padding: 0.625rem 0.875rem;
            }
            
            /* Hide less important columns on mobile */
            .hide-mobile {
                display: none;
            }
        }
        
        /* ===== COLUMN MANAGER STYLES ===== */
        .column-manager {
            padding: 1rem;
        }
        
        .columns-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
            background: var(--sol-gray-50);
            border-radius: var(--sol-radius-md);
        }
        
        .column-item {
            background: white;
            border: 1px solid var(--sol-gray-200);
            border-radius: var(--sol-radius-md);
            padding: 0.75rem 1rem;
            transition: all var(--sol-transition-fast);
        }
        
        .column-item:hover {
            border-color: var(--sol-primary);
            box-shadow: var(--sol-shadow-sm);
        }
        
        .column-item.locked {
            background: var(--sol-gray-50);
            opacity: 0.7;
        }
        
        .column-item label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            margin: 0;
        }
        
        .column-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Enhanced Documents Integration Styles */
        .documents-btn {
            position: relative;
            transition: all var(--sol-transition-fast);
        }
        
        .documents-btn .doc-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--sol-primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .documents-btn.empty .doc-count {
            background: var(--sol-gray-400);
        }
        
        .documents-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--sol-shadow-md);
        }
        
        /* Commercial Status Indicators */
        .commercial-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: var(--sol-radius-sm);
        }
        
        .commercial-status.complete {
            background: var(--sol-success-light);
            color: var(--sol-success);
        }
        
        .commercial-status.partial {
            background: var(--sol-warning-light);
            color: var(--sol-warning);
        }
        
        .commercial-status.missing {
            background: var(--sol-gray-200);
            color: var(--sol-gray-600);
        }
        
        /* Enhanced Import Modal Styles */
        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .import-option {
            background: var(--sol-gray-50);
            border: 2px solid var(--sol-gray-200);
            border-radius: var(--sol-radius-lg);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--sol-transition-fast);
        }
        
        .import-option:hover {
            border-color: var(--sol-primary);
            background: var(--sol-primary-light);
            transform: translateY(-2px);
            box-shadow: var(--sol-shadow-md);
        }
        
        .import-option i {
            color: var(--sol-primary);
            margin-bottom: 1rem;
        }
        
        .import-option h4 {
            margin: 0 0 0.5rem;
            color: var(--sol-gray-800);
        }
        
        .import-option p {
            margin: 0;
            color: var(--sol-gray-600);
            font-size: 0.875rem;
        }

        /* Enhanced Commercial Workflow Styles */
        .workflow-progress {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--sol-gray-200);
        }

        .workflow-progress-bar {
            width: 100%;
            height: 12px;
            background: var(--sol-gray-200);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .workflow-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--sol-primary), var(--sol-success));
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .workflow-progress-text {
            text-align: center;
            font-size: 0.875rem;
            color: var(--sol-gray-600);
            font-weight: 500;
        }

        .step-status {
            font-size: 0.75rem;
            color: var(--sol-gray-500);
            margin-top: 0.25rem;
            text-align: center;
        }

        .workflow-step.completed .step-status {
            color: var(--sol-success);
            font-weight: 600;
        }

        .workflow-step.partial .step-status {
            color: var(--sol-warning);
            font-weight: 600;
        }

        /* Commercial Quick Actions */
        .commercial-quick-actions {
            background: white;
            padding: 1.5rem;
            border-radius: var(--sol-radius-lg);
            border: 1px solid var(--sol-gray-200);
            margin-top: 1.5rem;
        }

        .commercial-quick-actions h4 {
            margin: 0 0 1rem;
            color: var(--sol-gray-800);
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .quick-actions-grid .sol-btn {
            padding: 1rem;
            text-align: center;
            flex-direction: column;
            gap: 0.5rem;
            height: auto;
        }

        .quick-actions-grid .sol-btn i {
            font-size: 1.25rem;
        }

        /* Validation Summary Styles */
        .validation-summary {
            text-align: center;
            padding: 1rem;
        }

        .validation-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .validation-stats .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--sol-gray-50);
            border-radius: var(--sol-radius-md);
        }

        .validation-stats .stat i {
            font-size: 1.5rem;
        }

        .validation-score {
            padding: 1rem;
            background: var(--sol-primary-light);
            border-radius: var(--sol-radius-md);
            color: var(--sol-primary);
        }

        /* Enhanced Table Column Styles */
        .documents-cell,
        .commercial-cell {
            text-align: center;
            width: 100px;
        }

        .commercial-cell .commercial-status:hover {
            transform: scale(1.05);
        }

        /* Bulk Commercial Import Styles */
        .bulk-commercial-import {
            padding: 1rem;
        }

        .bulk-commercial-import .import-options {
            grid-template-columns: repeat(2, 1fr);
        }
        
        @media print {
            /* Nascondi elementi non necessari nella stampa */
            .sol-header,
            .sol-page-actions,
            .sol-tabs,
            button,
            .sol-btn {
                display: none !important;
            }
            
            /* Ottimizza per stampa */
            .executive-dashboard-content {
                width: 100%;
                margin: 0;
                padding: 20px;
            }
            
            /* Forza i grafici a dimensioni stampabili */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
        }

        /* Enhanced Products Link Styles */
.products-link-stats {
    animation: fadeInUp 0.6s ease-out;
}
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.stat-card {
    transition: all 0.3s ease;
}
.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.link-container {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 2rem;
    min-height: 400px;
    margin-top: 2rem;
}
.link-panel {
    background: var(--sol-gray-50);
    border: 1px solid var(--sol-gray-200);
    border-radius: var(--sol-radius-lg);
    padding: 1.5rem;
    overflow-y: auto;
    max-height: 500px;
    transition: all 0.3s ease;
}
.link-panel:hover {
    border-color: var(--sol-primary);
    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.1);
}
.link-panel h4 {
    margin: 0 0 1rem;
    color: var(--sol-gray-800);
    font-size: 1rem;
    font-weight: 600;
}
.link-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}
.link-item {
    background: white;
    border: 1px solid var(--sol-gray-200);
    border-radius: var(--sol-radius-md);
    padding: 1rem;
    cursor: pointer;
    transition: all var(--sol-transition-fast);
    position: relative;
    overflow: hidden;
}
.link-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: transparent;
    transition: background 0.3s ease;
}
.link-item:hover {
    border-color: var(--sol-primary);
    transform: translateY(-1px);
    box-shadow: var(--sol-shadow-sm);
}
.link-item:hover::before {
    background: var(--sol-primary);
}
.link-item.selected {
    border-color: var(--sol-primary);
    background: var(--sol-primary-light);
}
.link-item.selected::before {
    background: var(--sol-primary);
}
.link-connector {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
}
#autoLinkBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
}
#autoLinkBtn:active {
    transform: translateY(0);
}
/* Products Grid Enhanced */
.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    animation: fadeIn 0.5s ease-out;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.shipment-products-card {
    background: white;
    border: 1px solid var(--sol-gray-200);
    border-radius: var(--sol-radius-lg);
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.shipment-products-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--sol-primary), var(--sol-success));
    transform: scaleX(0);
    transition: transform 0.3s ease;
}
.shipment-products-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--sol-shadow-lg);
    border-color: var(--sol-primary);
}
.shipment-products-card:hover::before {
    transform: scaleX(1);
}
.shipment-products-card h4 {
    margin: 0 0 1rem;
    color: var(--sol-gray-800);
    font-size: 1.125rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.product-list-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--sol-gray-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s ease;
}
.product-list-item:hover {
    background: var(--sol-gray-50);
    border-radius: 4px;
    margin: 0 -8px;
    padding-left: 8px;
    padding-right: 8px;
}
.product-list-item:last-child {
    border-bottom: none;
}
/* Auto-Link Animation */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
.auto-linking #autoLinkBtn {
    animation: pulse 1s infinite;
    background: linear-gradient(45deg, #007AFF, #34C759);
}
/* Mobile Responsiveness */
@media (max-width: 768px) {
    .link-container {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    .link-connector {
        flex-direction: row;
        padding: 1rem 0;
        justify-content: center;
    }
    .products-grid {
        grid-template-columns: 1fr;
    }
    .products-link-stats {
        grid-template-columns: 1fr;
    }
}
/* Loading States */
.loading-shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}
@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}
/* Success States */
.success-state {
    animation: successPulse 0.6s ease-out;
}
@keyframes successPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

    </style>
</head>
<body>
    <main class="sol-main-content" id="mainContent">
        <div class="sol-page-header">
            <div>
                <h1 class="sol-page-title">
                    <i class="fas fa-ship" style="color: var(--sol-primary); margin-right: 0.75rem;"></i>
                    Registro Centrale Spedizioni
                </h1>
                <p class="sol-page-subtitle">
                    Gestione unificata spedizioni, allocazione costi e integrazione prodotti
                </p>
            </div>
            <div class="sol-page-actions">
                <button class="sol-btn sol-btn-glass" id="importShipmentsBtn">
                    <i class="fas fa-upload"></i>
                    <span>Import CSV/Excel</span>
                </button>
                <button class="sol-btn sol-btn-glass" id="exportRegistryBtn">
                    <i class="fas fa-download"></i>
                    <span>Export Registry</span>
                </button>
                <button class="sol-btn sol-btn-glass" id="bulkActionsBtn">
                    <i class="fas fa-tasks"></i>
                    <span>Azioni Multiple</span>
                </button>
                <button class="sol-btn sol-btn-glass" id="costAllocationBtn">
                    <i class="fas fa-calculator"></i>
                    <span>Allocazione Costi</span>
                </button>
                <button class="sol-btn sol-btn-primary" id="addShipmentBtn">
                    <i class="fas fa-plus"></i>
                    <span>Nuova Spedizione</span>
                </button>
            </div>
        </div>

        <div class="sol-stats-grid" id="shipmentsKpiGrid">
            <div class="sol-stat-card">
                <i class="fas fa-ship sol-stat-icon" style="color: var(--sol-primary);"></i>
                <div class="sol-stat-value" id="totalShipments">0</div>
                <div class="sol-stat-label">Spedizioni Totali</div>
            </div>
            <div class="sol-stat-card">
                <i class="fas fa-route sol-stat-icon" style="color: var(--sol-info);"></i>
                <div class="sol-stat-value" id="activeShipments">0</div>
                <div class="sol-stat-label">In Transito</div>
            </div>
            <div class="sol-stat-card">
                <i class="fas fa-euro-sign sol-stat-icon" style="color: var(--sol-success);"></i>
                <div class="sol-stat-value" id="totalCosts">â‚¬0</div>
                <div class="sol-stat-label">Costo Totale</div>
            </div>
            <div class="sol-stat-card">
                <i class="fas fa-clock sol-stat-icon" style="color: var(--sol-warning);"></i>
                <div class="sol-stat-value" id="avgTransitTime">0gg</div>
                <div class="sol-stat-label">Tempo Medio Transito</div>
            </div>
        </div>

        <div class="sol-card" style="margin-bottom: 2rem;">
            <div class="sol-tabs" id="shipmentTabs">
                <button class="sol-tab active" data-section="registry">
                    <i class="fas fa-database"></i>
                    <span>Registro Spedizioni</span>
                </button>
                <button class="sol-tab" data-section="products-link">
                    <i class="fas fa-link"></i>
                    <span>Collegamento Prodotti</span>
                </button>
                <button class="sol-tab" data-section="commercial-forms">
                    <i class="fas fa-file-contract"></i>
                    <span>Smart Commercial Forms</span>
                    <span class="tab-badge new" style="background: var(--sol-primary); color: white; font-size: 0.6rem; padding: 0.125rem 0.375rem; border-radius: 999px; margin-left: 0.5rem;">V15.0</span>
                </button>
                <button class="sol-tab" data-section="cost-analysis">
                    <i class="fas fa-chart-line"></i>
                    <span>Executive BI Dashboard</span>
                    <span class="tab-badge" style="background: var(--sol-success); color: white; font-size: 0.6rem; padding: 0.125rem 0.375rem; border-radius: 999px; margin-left: 0.5rem;">NEW</span>
                </button>
                <button class="sol-tab" data-section="routes">
                    <i class="fas fa-globe"></i>
                    <span>Rotte & Performance</span>
                </button>
                <button class="sol-tab" data-section="timeline">
                    <i class="fas fa-history"></i>
                    <span>Timeline</span>
                </button>
            </div>
        </div>

        <div id="registry" class="sol-tab-content active">
            <div class="sol-card" style="margin-bottom: 1.5rem;">
                <div class="sol-card-header">
                    <h3 class="sol-card-title">Filtri Avanzati</h3>
                    <button class="sol-btn sol-btn-sm sol-btn-glass" id="resetFiltersBtn">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
                <div class="sol-card-body">
                    <div class="sol-form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="sol-form-group">
                            <label class="sol-form-label">Stato Spedizione</label>
                            <select class="sol-form-select" id="statusFilter">
                                <option value="">Tutti gli stati</option>
                                <option value="planned">Pianificata</option>
                                <option value="departed">Partita</option>
                                <option value="in_transit">In Transito</option>
                                <option value="arrived">Arrivata</option>
                                <option value="delivered">Consegnata</option>
                            </select>
                        </div>
                        <div class="sol-form-group">
                            <label class="sol-form-label">Tipo Spedizione</label>
                            <select class="sol-form-select" id="typeFilter">
                                <option value="">Tutti i tipi</option>
                                <option value="container">Container</option>
                                <option value="awb">Air Waybill</option>
                                <option value="bl">Bill of Lading</option>
                                <option value="lcl">LCL</option>
                            </select>
                        </div>
                        <div class="sol-form-group">
                            <label class="sol-form-label">Vettore</label>
                            <select class="sol-form-select" id="carrierFilter">
                                <option value="">Tutti i vettori</option>
                            </select>
                        </div>
                        <div class="sol-form-group">
                            <label class="sol-form-label">Periodo</label>
                            <select class="sol-form-select" id="periodFilter">
                                <option value="">Tutto</option>
                                <option value="7">Ultimi 7 giorni</option>
                                <option value="30">Ultimi 30 giorni</option>
                                <option value="90">Ultimi 3 mesi</option>
                                <option value="365">Ultimo anno</option>
                            </select>
                        </div>
                        <div class="sol-form-group" style="grid-column: span 2;">
                            <label class="sol-form-label">Cerca</label>
                            <div class="sol-search-wrapper">
                                <input type="text" class="sol-search" id="searchRegistry" 
                                       placeholder="Cerca per numero spedizione, prodotto, fornitore...">
                                <i class="fas fa-search sol-search-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sol-card">
                <div class="sol-card-header">
                    <h3 class="sol-card-title">
                        <span id="registryCount">0</span> Spedizioni
                    </h3>
                    <div class="sol-card-filters">
                        <button class="sol-btn sol-btn-sm sol-btn-glass" id="columnsManagerBtn">
                            <i class="fas fa-columns"></i> Colonne
                        </button>
                        <button class="sol-btn sol-btn-sm sol-btn-glass" id="refreshDataBtn">
                            <i class="fas fa-sync"></i> Aggiorna
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="sol-table" id="shipmentsTable">
                        <thead>
                            <tr>
                                <th data-sort="checkbox">
                                    <input type="checkbox" id="selectAllShipments">
                                </th>
                                <th data-sort="shipmentNumber">Rif. Spedizione</th>
                                <th data-sort="type">Tipo</th>
                                <th data-sort="status">Stato</th>
                                <th data-sort="carrier">Vettore</th>
                                <th data-sort="origin">Origine</th>
                                <th data-sort="destination">Destinazione</th>
                                <th data-sort="etd">ETD</th>
                                <th data-sort="eta">ETA</th>
                                <th data-sort="products">Prodotti</th>
                                <th data-sort="documents">
                                    <i class="fas fa-folder"></i> Docs
                                </th>
                                <th data-sort="commercial">
                                    <i class="fas fa-file-contract"></i> PO/PI/CI
                                </th>
                                <th data-sort="totalCost">Costo Tot.</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="shipmentsTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="table-pagination" id="registryPagination">
                </div>
            </div>
        </div>

        <div id="products-link" class="sol-tab-content">
    <div class="sol-card">
        <div class="sol-card-header">
            <h3 class="sol-card-title">
                <i class="fas fa-link"></i>
                Collegamento Prodotti-Spedizioni
                <span class="tab-badge" style="background: var(--sol-success); color: white; font-size: 0.6rem; padding: 0.125rem 0.375rem; border-radius: 999px; margin-left: 0.5rem;">V20.0</span>
            </h3>
            <div class="sol-card-actions">
                <button class="sol-btn sol-btn-glass" id="refreshProductsMenuBtn">
                    <i class="fas fa-sync"></i>
                    Aggiorna
                </button>
                <button class="sol-btn sol-btn-primary" id="linkProductsBtn">
                    <i class="fas fa-link"></i> 
                    Collega Prodotti
                </button>
            </div>
        </div>
        <div class="sol-card-body">
            <div class="products-link-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #ffc107;"></i>
                        <div>
                            <div class="stat-value" id="unlinkedShipmentsCount" style="font-size: 1.5rem; font-weight: bold; color: #856404;">0</div>
                            <div class="stat-label" style="font-size: 0.875rem; color: #856404;">Spedizioni Senza Prodotti</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card" style="background: #d4edda; border-left: 4px solid #28a745; padding: 1rem; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <i class="fas fa-box" style="font-size: 2rem; color: #28a745;"></i>
                        <div>
                            <div class="stat-value" id="availableProductsCount" style="font-size: 1.5rem; font-weight: bold; color: #155724;">0</div>
                            <div class="stat-label" style="font-size: 0.875rem; color: #155724;">Prodotti Disponibili</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card" style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 1rem; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <i class="fas fa-link" style="font-size: 2rem; color: #17a2b8;"></i>
                        <div>
                            <div class="stat-value" id="linkedShipmentsCount" style="font-size: 1.5rem; font-weight: bold; color: #0c5460;">0</div>
                            <div class="stat-label" style="font-size: 0.875rem; color: #0c5460;">Spedizioni Collegate</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card" style="background: #e2e3e5; border-left: 4px solid #6c757d; padding: 1rem; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <i class="fas fa-percentage" style="font-size: 2rem; color: #6c757d;"></i>
                        <div>
                            <div class="stat-value" id="linkingPercentage" style="font-size: 1.5rem; font-weight: bold; color: #495057;">0%</div>
                            <div class="stat-label" style="font-size: 0.875rem; color: #495057;">Completamento Collegamenti</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="link-container">
                <div class="link-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-ship" style="color: #ffc107;"></i>
                            Spedizioni Senza Prodotti
                        </h4>
                        <span class="sol-badge" id="unlinkedBadge" style="background: #ffc107; color: #856404;">0</span>
                    </div>
                    <div class="link-list" id="unlinkedShipmentsList">
                        <div style="text-align: center; padding: 2rem; color: #6c757d;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p style="margin: 0;">Caricamento spedizioni...</p>
                        </div>
                    </div>
                </div>
                <div class="link-connector">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                        <button class="sol-btn sol-btn-primary" id="autoLinkBtn" onclick="window.performAutoLink()" 
                                style="padding: 1rem 1.5rem; font-size: 1rem; border-radius: 50px; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-magic"></i>
                            Auto-Link
                        </button>
                        <div style="text-align: center; font-size: 0.75rem; color: #6c757d; max-width: 120px; line-height: 1.3;">
                            Collegamento automatico intelligente
                        </div>
                        <div id="autoLinkProgress" style="display: none; text-align: center;">
                            <div class="sol-progress-bar" style="width: 100px; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
                                <div class="sol-progress-fill" style="height: 100%; background: linear-gradient(90deg, #007AFF, #34C759); width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="font-size: 0.75rem; color: #007AFF;">Collegamento in corso...</div>
                        </div>
                    </div>
                </div>
                <div class="link-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-box" style="color: #28a745;"></i>
                            Prodotti Disponibili
                        </h4>
                        <span class="sol-badge" id="productsBadge" style="background: #28a745; color: white;">0</span>
                    </div>
                    <div class="link-list" id="availableProductsList">
                        <div style="text-align: center; padding: 2rem; color: #6c757d;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p style="margin: 0;">Caricamento prodotti...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="sol-card" style="margin-top: 2rem;">
        <div class="sol-card-header">
            <h3 class="sol-card-title">
                <i class="fas fa-network-wired"></i>
                Prodotti Collegati per Spedizione
            </h3>
            <div class="sol-card-actions">
                <button class="sol-btn sol-btn-glass" onclick="window.productLinkingV20Final?.populateProductsMenu()">
                    <i class="fas fa-sync"></i>
                    Aggiorna Vista
                </button>
                <button class="sol-btn sol-btn-glass" id="exportLinksBtn">
                    <i class="fas fa-download"></i>
                    Esporta Collegamenti
                </button>
            </div>
        </div>
        <div class="sol-card-body">
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap;">
                <div class="sol-form-group" style="margin: 0; min-width: 200px;">
                    <label class="sol-form-label" style="margin-bottom: 0.25rem;">Filtra per stato:</label>
                    <select class="sol-form-select" id="linkedProductsFilter" style="padding: 0.5rem;">
                        <option value="all">Tutte le spedizioni</option>
                        <option value="with-products">Solo con prodotti</option>
                        <option value="without-products">Solo senza prodotti</option>
                    </select>
                </div>
                <div class="sol-form-group" style="margin: 0; min-width: 200px;">
                    <label class="sol-form-label" style="margin-bottom: 0.25rem;">Cerca:</label>
                    <input type="text" class="sol-form-input" id="linkedProductsSearch" placeholder="Cerca spedizione o prodotto..." style="padding: 0.5rem;">
                </div>
                <div style="margin-left: auto;">
                    <button class="sol-btn sol-btn-sm sol-btn-glass" id="resetLinkedFiltersBtn">
                        <i class="fas fa-undo"></i>
                        Reset
                    </button>
                </div>
            </div>
            <div id="linkedProductsGrid" class="products-grid">
                <div style="text-align: center; padding: 3rem; color: #6c757d;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                    <p style="margin: 0; font-size: 1.125rem;">Caricamento collegamenti prodotti-spedizioni...</p>
                    <p style="margin: 0.5rem 0 0; font-size: 0.875rem;">Questo potrebbe richiedere qualche secondo</p>
                </div>
            </div>
        </div>
    </div>
</div>

        <div id="cost-analysis" class="sol-tab-content">
            <div class="loading-state" style="text-align: center; padding: 4rem;">
                <div class="loading-spinner" style="width: 60px; height: 60px; border: 4px solid var(--sol-gray-200); border-top: 4px solid var(--sol-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 2rem;"></div>
                <h3 style="color: var(--sol-gray-600); margin: 0 0 1rem;">Caricamento Executive BI Dashboard...</h3>
                <p style="color: var(--sol-gray-500); margin: 0;">Analisi dati e generazione insights in corso</p>
            </div>
        </div>

        <div id="routes" class="sol-tab-content">
            <div class="performance-overview">
                <h3 class="section-title">
                    <i class="fas fa-chart-line"></i> Carrier Performance Overview
                </h3>
                <div id="carrierPerformanceCards" class="performance-cards-grid">
                </div>
            </div>
            
            <div class="sol-grid-2" style="margin-top: 2rem;">
                <div class="sol-card">
                    <div class="sol-card-header">
                        <h3 class="sol-card-title">Carrier Performance Comparison</h3>
                    </div>
                    <div class="sol-card-body">
                        <canvas id="carrierComparisonChart" height="400"></canvas>
                    </div>
                </div>
                
                <div class="sol-card">
                    <div class="sol-card-header">
                        <h3 class="sol-card-title">Route Efficiency Analysis</h3>
                    </div>
                    <div class="sol-card-body">
                        <canvas id="routeEfficiencyChart" height="400"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="sol-grid-2" style="margin-top: 2rem;">
                <div class="sol-card">
                    <div class="sol-card-header">
                        <h3 class="sol-card-title">
                            <i class="fas fa-lightbulb"></i> Performance Insights
                        </h3>
                    </div>
                    <div class="sol-card-body">
                        <div id="performanceInsights" class="insights-container">
                        </div>
                    </div>
                </div>
                
                <div class="sol-card">
                    <div class="sol-card-header">
                        <h3 class="sol-card-title">
                            <i class="fas fa-magic"></i> Optimization Recommendations
                        </h3>
                    </div>
                    <div class="sol-card-body">
                        <div id="performanceRecommendations" class="recommendations-container">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sol-card" style="margin-top: 2rem;">
                <div class="sol-card-header">
                    <h3 class="sol-card-title">Route Optimization Matrix</h3>
                    <button class="sol-btn sol-btn-sm sol-btn-primary" onclick="window.carrierPerformance.exportRouteAnalysis()">
                        <i class="fas fa-download"></i> Export Analysis
                    </button>
                </div>
                <div class="table-wrapper">
                    <table class="sol-table">
                        <thead>
                            <tr>
                                <th>Route</th>
                                <th>Shipments</th>
                                <th>Avg Transit</th>
                                <th>Avg Cost</th>
                                <th>On-Time %</th>
                                <th>Efficiency</th>
                                <th>Competition</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="routeOptimizationTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="timeline" class="sol-tab-content">
            <div class="sol-card">
                <div class="sol-card-header">
                    <h3 class="sol-card-title">Timeline Spedizioni</h3>
                    <div class="sol-card-filters">
                        <select class="sol-select" id="timelineFilter">
                            <option value="all">Tutte</option>
                            <option value="active">Attive</option>
                            <option value="completed">Completate</option>
                        </select>
                    </div>
                </div>
                <div class="sol-card-body">
                    <div id="shipmentTimeline" class="timeline-container">
                    </div>
                </div>
            </div>

            <div class="sol-card" style="margin-top: 2rem;">
                <div class="sol-card-header">
                    <h3 class="sol-card-title">Eventi Recenti</h3>
                </div>
                <div class="sol-card-body">
                    <div id="timelineEvents">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <template id="shipmentDetailsTemplate">
        <div class="shipment-details">
            <div class="details-header">
                <h3 id="modalShipmentNumber"></h3>
                <span class="sol-badge" id="modalShipmentStatus"></span>
            </div>
            <div class="details-tabs">
                <button class="tab-btn active" data-tab="general">Generale</button>
                <button class="tab-btn" data-tab="products">Prodotti</button>
                <button class="tab-btn" data-tab="costs">Costi</button>
                <button class="tab-btn" data-tab="documents">
                    Documenti
                    <span class="tab-badge documents-count" id="documentsTabBadge" style="display: none;">0</span>
                </button>
                <button class="tab-btn" data-tab="timeline">Timeline</button>
            </div>
            <div class="details-content">
            </div>
        </div>
    </template>

    <style>
        /* Executive BI Dashboard Styles */
        .executive-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--sol-primary), var(--sol-primary-dark));
            border-radius: var(--sol-radius-lg);
            color: white;
        }

        .executive-title h2 {
            margin: 0 0 0.5rem;
            font-size: 1.875rem;
            font-weight: 700;
        }

        .executive-subtitle {
            margin: 0;
            opacity: 0.9;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .update-time {
            font-size: 0.875rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .executive-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .executive-actions .sol-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            backdrop-filter: blur(10px);
        }

        .executive-actions .sol-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .executive-actions .sol-btn-primary {
            background: white;
            color: var(--sol-primary);
        }

        .executive-actions .sol-btn-primary:hover {
            background: var(--sol-gray-50);
        }

        /* Executive KPI Grid */
        .executive-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .executive-kpi-card {
            background: white;
            border-radius: var(--sol-radius-lg);
            padding: 2rem;
            box-shadow: var(--sol-shadow-sm);
            border: 1px solid var(--sol-gray-200);
            transition: all var(--sol-transition-fast);
            position: relative;
            overflow: hidden;
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .executive-kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--sol-gray-300);
        }

        .executive-kpi-card.positive::before { background: var(--sol-success); }
        .executive-kpi-card.excellent::before { background: var(--sol-primary); }
        .executive-kpi-card.negative::before { background: var(--sol-danger); }
        .executive-kpi-card.neutral::before { background: var(--sol-warning); }

        .executive-kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sol-shadow-md);
        }

        .kpi-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--sol-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .volume-icon { background: rgba(0, 122, 255, 0.1); color: var(--sol-primary); }
        .cost-icon { background: rgba(255, 149, 0, 0.1); color: var(--sol-warning); }
        .performance-icon { background: rgba(76, 217, 100, 0.1); color: var(--sol-success); }
        .roi-icon { background: rgba(88, 86, 214, 0.1); color: var(--sol-purple); }

        .kpi-content {
            flex: 1;
        }

        .kpi-content h4 {
            margin: 0 0 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--sol-gray-600);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--sol-gray-900);
            margin: 0.5rem 0;
            line-height: 1;
        }

        .kpi-detail {
            font-size: 0.875rem;
            color: var(--sol-gray-600);
            margin-bottom: 0.5rem;
        }

        .kpi-comparison {
            display: block;
            font-size: 0.75rem;
            color: var(--sol-gray-500);
            margin-top: 0.25rem;
        }

        .kpi-trend {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--sol-primary);
        }

        /* Chart Cards */
        .chart-card {
            height: 400px;
        }

        .chart-card .sol-card-body {
            height: 300px;
            position: relative;
        }

        /* Insights & Recommendations */
        .insights-card, .recommendations-card {
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .insights-card .sol-card-body,
        .recommendations-card .sol-card-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .insights-count, .recommendations-count {
            background: var(--sol-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--sol-radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ADDED: Documents Column Styles */
        .documents-cell {
            text-align: center;
            width: 80px;
        }

        .documents-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            min-width: 60px;
            justify-content: center;
        }

        .documents-btn .doc-count {
            background: var(--sol-primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: var(--sol-radius-full);
            min-width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.25rem;
        }

        .documents-btn.empty .doc-count {
            background: var(--sol-gray-400);
        }

        .documents-btn:hover .doc-count {
            background: var(--sol-primary-dark);
        }

        .documents-btn.empty:hover .doc-count {
            background: var(--sol-gray-500);
        }

        /* ADDED: Tab Badge Styles for Modal */
        .tab-badge {
            background: var(--sol-primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: var(--sol-radius-full);
            margin-left: 0.5rem;
            min-width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .tab-badge.documents-count {
            background: var(--sol-info);
        }

        /* Commercial Forms Styles */
        .commercial-overview {
            padding: 1.5rem;
            background: var(--sol-gray-50);
            border-radius: var(--sol-radius-lg);
            margin-bottom: 2rem;
        }

        .commercial-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .commercial-stat {
            background: white;
            padding: 1.5rem;
            border-radius: var(--sol-radius-md);
            text-align: center;
            box-shadow: var(--sol-shadow-sm);
            border: 1px solid var(--sol-gray-200);
        }

        .commercial-stat i {
            font-size: 2rem;
            color: var(--sol-primary);
            margin-bottom: 1rem;
        }

        .stat-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--sol-gray-900);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--sol-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .commercial-workflow {
            background: white;
            padding: 1.5rem;
            border-radius: var(--sol-radius-lg);
            border: 1px solid var(--sol-gray-200);
            margin-bottom: 1.5rem;
        }

        .commercial-workflow h4 {
            margin: 0 0 1.5rem;
            color: var(--sol-gray-800);
            text-align: center;
        }

        .workflow-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            text-align: center;
        }

        .step-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--sol-gray-200);
            color: var(--sol-gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all var(--sol-transition-fast);
        }

        .workflow-step.completed .step-icon {
            background: var(--sol-success);
            color: white;
        }

        .workflow-step.partial .step-icon {
            background: var(--sol-warning);
            color: white;
        }

        .workflow-arrow {
            font-size: 1.5rem;
            color: var(--sol-gray-400);
            margin: 0 0.5rem;
        }

        /* Link Container Styles */
        .link-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            min-height: 400px;
        }

        .link-panel {
            background: var(--sol-gray-50);
            border-radius: var(--sol-radius-lg);
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 500px;
        }

        .link-panel h4 {
            margin: 0 0 1rem;
            color: var(--sol-gray-800);
            font-size: 1rem;
        }

        .link-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .link-item {
            background: white;
            border: 1px solid var(--sol-gray-200);
            border-radius: var(--sol-radius-md);
            padding: 1rem;
            cursor: pointer;
            transition: all var(--sol-transition-fast);
        }

        .link-item:hover {
            border-color: var(--sol-primary);
            transform: translateY(-1px);
            box-shadow: var(--sol-shadow-sm);
        }

        .link-item.selected {
            border-color: var(--sol-primary);
            background: var(--sol-primary-light);
        }

        .link-connector {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .shipment-products-card {
            background: white;
            border: 1px solid var(--sol-gray-200);
            border-radius: var(--sol-radius-lg);
            padding: 1.5rem;
        }

        .shipment-products-card h4 {
            margin: 0 0 1rem;
            color: var(--sol-gray-800);
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .product-list-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--sol-gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-list-item:last-child {
            border-bottom: none;
        }

        /* Timeline Styles */
        .timeline-container {
            position: relative;
            padding: 2rem 0;
        }

        .timeline-item {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .timeline-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--sol-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            z-index: 2;
        }

        .timeline-content {
            flex: 1;
            background: var(--sol-gray-50);
            border-radius: var(--sol-radius-lg);
            padding: 1.5rem;
        }

        .timeline-line {
            position: absolute;
            left: 20px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background: var(--sol-gray-200);
            z-index: 1;
        }

        .timeline-item:last-child .timeline-line {
            display: none;
        }

        /* Status Colors */
        .status-planned { background: var(--sol-gray-200); color: var(--sol-gray-700); }
        .status-departed { background: var(--sol-info-light); color: var(--sol-info-dark); }
        .status-in_transit { background: var(--sol-warning-light); color: var(--sol-warning-dark); }
        .status-arrived { background: var(--sol-success-light); color: var(--sol-success-dark); }
        .status-delivered { background: var(--sol-success); color: white; }

        /* Import Options */
        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
        }
        
        .import-option {
            text-align: center;
            padding: 2rem 1rem;
            border: 2px solid var(--sol-gray-200);
            border-radius: var(--sol-radius-lg);
            cursor: pointer;
            transition: all var(--sol-transition-fast);
        }
        
        .import-option:hover {
            border-color: var(--sol-primary);
            background: var(--sol-primary-light);
            transform: translateY(-2px);
        }
        
        .import-option i {
            color: var(--sol-primary);
            margin-bottom: 1rem;
        }
        
        .import-option h4 {
            margin: 0.5rem 0;
            color: var(--sol-gray-800);
        }
        
        .import-option p {
            margin: 0;
            color: var(--sol-gray-600);
            font-size: 0.875rem;
        }
        
        .bulk-actions-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
        }
        
        .sol-btn-block {
            width: 100%;
            justify-content: flex-start;
        }

        /* Import Results Styles */
        .import-results {
            padding: 1rem;
        }

        .results-summary {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .results-summary .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .errors-details {
            background: var(--sol-gray-50);
            border-radius: var(--sol-radius-md);
            padding: 1rem;
        }

        .errors-details h4 {
            margin: 0 0 0.5rem;
            color: var(--sol-gray-800);
        }

        .errors-details ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        /* Performance Cards */
        .performance-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .performance-card {
            background: white;
            border: 1px solid var(--sol-gray-200);
            border-radius: var(--sol-radius-lg);
            padding: 1.5rem;
            transition: all var(--sol-transition-fast);
        }

        .performance-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sol-shadow-md);
        }

        .performance-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .performance-card h4 {
            margin: 0;
            font-size: 1.125rem;
            color: var(--sol-gray-800);
        }

        .score-badge {padding: 0.25rem 0.75rem;
           border-radius: 999px;
           font-size: 0.875rem;
           font-weight: 600;
           color: white;
       }

       .card-metrics {
           display: grid;
           grid-template-columns: repeat(3, 1fr);
           gap: 1rem;
           margin-bottom: 1rem;
       }

       .metric {
           text-align: center;
       }

       .metric i {
           font-size: 1.5rem;
           color: var(--sol-gray-400);
           margin-bottom: 0.5rem;
           display: block;
       }

       .metric-value {
           display: block;
           font-size: 1.25rem;
           font-weight: 600;
           color: var(--sol-gray-800);
       }

       .metric-label {
           display: block;
           font-size: 0.75rem;
           color: var(--sol-gray-600);
           text-transform: uppercase;
       }

       /* Insights */
       .insights-container {
           display: flex;
           flex-direction: column;
           gap: 1rem;
       }

       .insight-card {
           display: flex;
           gap: 1rem;
           padding: 1rem;
           border-radius: var(--sol-radius-md);
           background: var(--sol-gray-50);
       }

       .insight-card.success { background: var(--sol-success-light); }
       .insight-card.warning { background: var(--sol-warning-light); }
       .insight-card.info { background: var(--sol-info-light); }

       .insight-card i {
           font-size: 1.5rem;
           flex-shrink: 0;
       }

       .insight-content h5 {
           margin: 0 0 0.25rem;
           font-size: 1rem;
       }

       .insight-content p {
           margin: 0;
           font-size: 0.875rem;
           color: var(--sol-gray-700);
       }

       .impact-badge {
           margin-left: auto;
           padding: 0.25rem 0.5rem;
           border-radius: var(--sol-radius-sm);
           font-size: 0.75rem;
           text-transform: uppercase;
           font-weight: 600;
       }

       .impact-badge.high { background: var(--sol-danger-light); color: var(--sol-danger); }
       .impact-badge.medium { background: var(--sol-warning-light); color: var(--sol-warning); }
       .impact-badge.low { background: var(--sol-info-light); color: var(--sol-info); }

       /* Recommendations */
       .recommendations-container {
           display: flex;
           flex-direction: column;
           gap: 1rem;
       }

       .recommendation-card {
           background: white;
           border: 1px solid var(--sol-gray-200);
           border-radius: var(--sol-radius-md);
           padding: 1.5rem;
       }

       .rec-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 0.75rem;
       }

       .rec-number {
           font-size: 1.25rem;
           font-weight: 700;
           color: var(--sol-primary);
       }

       .priority-badge {
           padding: 0.25rem 0.5rem;
           border-radius: var(--sol-radius-sm);
           font-size: 0.75rem;
           text-transform: uppercase;
           font-weight: 600;
       }

       .priority-badge.high { background: var(--sol-danger-light); color: var(--sol-danger); }
       .priority-badge.medium { background: var(--sol-warning-light); color: var(--sol-warning); }
       .priority-badge.low { background: var(--sol-info-light); color: var(--sol-info); }

       .recommendation-card h5 {
           margin: 0 0 0.5rem;
           color: var(--sol-gray-800);
       }

       .recommendation-card p {
           margin: 0 0 1rem;
           color: var(--sol-gray-600);
           font-size: 0.875rem;
       }

       .potential-saving {
           background: var(--sol-success-light);
           color: var(--sol-success-dark);
           padding: 0.5rem 1rem;
           border-radius: var(--sol-radius-md);
           font-size: 0.875rem;
           margin-bottom: 1rem;
       }

       .potential-saving i {
           margin-right: 0.5rem;
       }

       /* Efficiency Bar */
       .efficiency-bar {
           position: relative;
           background: var(--sol-gray-200);
           height: 24px;
           border-radius: 12px;
           overflow: hidden;
       }

       .efficiency-fill {
           position: absolute;
           left: 0;
           top: 0;
           height: 100%;
           transition: width 0.5s ease;
       }

       .efficiency-text {
           position: absolute;
           left: 50%;
           top: 50%;
           transform: translate(-50%, -50%);
           font-size: 0.875rem;
           font-weight: 600;
           color: var(--sol-gray-800);
       }

       /* Timeline Events */
       .timeline-event {
           display: flex;
           gap: 1rem;
           padding: 1rem;
           border-left: 3px solid var(--sol-primary);
           background: var(--sol-gray-50);
           margin-bottom: 0.5rem;
           border-radius: var(--sol-radius-md);
       }

       .timeline-event-icon {
           width: 32px;
           height: 32px;
           background: var(--sol-primary);
           color: white;
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           flex-shrink: 0;
       }

       .timeline-event-content {
           flex: 1;
       }

       .timeline-event-time {
           font-size: 0.75rem;
           color: var(--sol-gray-600);
       }

       /* Responsive Design */
       @media (max-width: 768px) {
           .executive-header {
               flex-direction: column;
               gap: 1.5rem;
               text-align: center;
           }
           
           .executive-kpi-grid {
               grid-template-columns: 1fr;
           }
           
           .sol-grid-2, .sol-grid-3 {
               grid-template-columns: 1fr;
           }
           
           .executive-kpi-card {
               flex-direction: column;
               text-align: center;
               gap: 1rem;
           }

           .link-container {
               grid-template-columns: 1fr;
           }

           .link-connector {
               flex-direction: row;
               padding: 1rem 0;
           }

           .sol-grid-2 {
               grid-template-columns: 1fr;
           }

        }
        /* Side Panel for product linking */
        .product-link-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .product-link-panel.open {
            right: 0;
        }

        .product-link-panel-header,
        .product-link-panel-footer {
            padding: 1rem;
            border-bottom: 1px solid var(--sol-gray-200);
        }

        .product-link-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
    </style>

   <script>
       // ===== COLUMN MANAGER IMPLEMENTATION =====
       class ColumnManager {
           constructor() {
               this.columns = [
                   { id: 'checkbox', label: 'Seleziona', visible: true, locked: true },
                   { id: 'shipmentNumber', label: 'Rif. Spedizione', visible: true },
                   { id: 'type', label: 'Tipo', visible: true },
                   { id: 'status', label: 'Stato', visible: true },
                   { id: 'carrier', label: 'Vettore', visible: true },
                   { id: 'origin', label: 'Origine', visible: true },
                   { id: 'destination', label: 'Destinazione', visible: true },
                   { id: 'etd', label: 'ETD', visible: true },
                   { id: 'eta', label: 'ETA', visible: true },
                   { id: 'products', label: 'Prodotti', visible: true },
                   { id: 'documents', label: 'Documenti', visible: true },
                   { id: 'commercial', label: 'PO/PI/CI', visible: true },
                   { id: 'totalCost', label: 'Costo Tot.', visible: true },
                   { id: 'actions', label: 'Azioni', visible: true, locked: true }
               ];
               
               this.loadPreferences();
           }
           
           loadPreferences() {
               const saved = localStorage.getItem('shipmentsTableColumns');
               if (saved) {
                   try {
                       const preferences = JSON.parse(saved);
                       this.columns = this.columns.map(col => ({
                           ...col,
                           visible: preferences[col.id] !== undefined ? preferences[col.id] : col.visible
                       }));
                   } catch (e) {
                       console.error('Error loading column preferences:', e);
                   }
               }
           }
           
           savePreferences() {
               const preferences = {};
               this.columns.forEach(col => {
                   preferences[col.id] = col.visible;
               });
               localStorage.setItem('shipmentsTableColumns', JSON.stringify(preferences));
           }
           
           openModal() {
               const modalContent = `
                   <div class="column-manager">
                       <p style="margin-bottom: 1.5rem;">Seleziona le colonne da visualizzare:</p>
                       <div class="columns-list">
                           ${this.columns.map(col => `
                               <div class="column-item ${col.locked ? 'locked' : ''}" data-column-id="${col.id}">
                                   <label class="sol-checkbox-label">
                                       <input type="checkbox" 
                                              class="column-checkbox" 
                                              value="${col.id}"
                                              ${col.visible ? 'checked' : ''}
                                              ${col.locked ? 'disabled' : ''}>
                                       <span>${col.label}</span>
                                       ${col.locked ? '<i class="fas fa-lock" style="margin-left: auto; color: var(--sol-gray-400);"></i>' : ''}
                                   </label>
                               </div>
                           `).join('')}
                       </div>
                   </div>
               `;
               
               window.ModalSystem?.show({
                   title: 'Gestione Colonne',
                   content: modalContent,
                   size: 'md',
                   buttons: [
                       {
                           text: 'Ripristina Default',
                           class: 'sol-btn-glass',
                           onclick: () => {
                               this.resetToDefault();
                               return false;
                           }
                       },
                       {
                           text: 'Annulla',
                           class: 'sol-btn-glass',
                           onclick: () => true
                       },
                       {
                           text: 'Applica',
                           class: 'sol-btn-primary',
                           onclick: () => {
                               this.applyChanges();
                               return true;
                           }
                       }
                   ]
               });
           }
           
           applyChanges() {
               const checkboxes = document.querySelectorAll('.column-checkbox');
               checkboxes.forEach(checkbox => {
                   const column = this.columns.find(col => col.id === checkbox.value);
                   if (column && !column.locked) {
                       column.visible = checkbox.checked;
                   }
               });
               
               this.savePreferences();
               this.updateTable();
               window.NotificationSystem?.show('Colonne aggiornate', 'Le preferenze sono state salvate', 'success');
           }
           
           resetToDefault() {
               this.columns.forEach(col => {
                   col.visible = true;
               });
               
               // Update checkboxes in modal
               document.querySelectorAll('.column-checkbox').forEach(checkbox => {
                   checkbox.checked = true;
               });
               
               window.NotificationSystem?.show('Reset completato', 'Colonne ripristinate ai valori default', 'info');
           }
           
           updateTable() {
               // Refresh the table with new column visibility
               if (window.registryCore) {
                   window.registryCore.render();
               } else if (window.loadShipmentsData) {
                   window.loadShipmentsData();
               }
           }
           
           getVisibleColumns() {
               return this.columns.filter(col => col.visible);
           }
           
           isColumnVisible(columnId) {
               const column = this.columns.find(col => col.id === columnId);
               return column ? column.visible : true;
           }
       }

       // Initialize Column Manager
       window.columnManager = new ColumnManager();

       // Update the click handler
       window.openColumnsManager = function() {
           if (window.columnManager) {
               window.columnManager.openModal();
           }
       };

       // ===== EXECUTIVE BI DASHBOARD INTEGRATION =====

       // Enhanced tab loading for Executive BI Dashboard
       function loadSectionData(section) {
           console.log(`Loading section: ${section}`);
           
           switch (section) {
               case 'products-link':
                   loadProductsLinkData();
                   break;
               case 'commercial-forms':
                   loadCommercialFormsData();
                   break;
               case 'cost-analysis':
                   // NEW: Load Executive BI Dashboard instead of basic cost analysis
                   loadExecutiveBIDashboard();
                   break;
               case 'routes':
                   loadRoutesData();
                   break;
               case 'timeline':
                   loadTimelineData();
                   break;
           }
       }

       // NEW: Commercial Forms data loader
       function loadCommercialFormsData() {
           console.log('Loading commercial forms data...');
           
           // Update commercial completion rates
           if (window.shipmentsPageV14) {
               window.shipmentsPageV14.updateCommercialCompletionRates();
           }
       }

       // NEW: Executive BI Dashboard loader
       async function loadExecutiveBIDashboard() {
           console.log('ðŸŽ¯ Loading Executive BI Dashboard...');
           
           // Ensure Executive BI Dashboard is available
           if (!window.executiveBIDashboard) {
               console.log('âš ï¸ Executive BI Dashboard not loaded, loading now...');
               
               // Dynamically load the Executive BI Dashboard
               await loadExecutiveBIScript();
               
               // Wait for initialization
               await new Promise(resolve => {
                   const checkInterval = setInterval(() => {
                       if (window.executiveBIDashboard) {
                           clearInterval(checkInterval);
                           resolve();
                       }
                   }, 100);
               });
           }
           
           // Trigger dashboard load
           if (window.executiveBIDashboard) {
               window.executiveBIDashboard.loadDashboard();
           }
       }

       // Dynamically load Executive BI Dashboard script
       async function loadExecutiveBIScript() {
           return new Promise((resolve, reject) => {
               const script = document.createElement('script');
               script.src = '/pages/shipments/executive-bi-dashboard.js';
               script.onload = resolve;
               script.onerror = reject;
               document.head.appendChild(script);
           });
       }

       // Enhanced tab initialization with Executive BI
       function initializeTabs() {
           const tabs = document.querySelectorAll('.sol-tab');
           const contents = document.querySelectorAll('.sol-tab-content');
           
           tabs.forEach(tab => {
               tab.addEventListener('click', async () => {
                   const targetSection = tab.dataset.section;
                   
                   // Update tabs
                   tabs.forEach(t => t.classList.remove('active'));
                   tab.classList.add('active');
                   
                   // Update content
                   contents.forEach(content => {
                       content.classList.remove('active');
                       if (content.id === targetSection) {
                           content.classList.add('active');
                           
                           // Load section data with enhanced loading
                           if (targetSection === 'cost-analysis') {
                               // Show loading state
                               content.innerHTML = `
                                   <div class="loading-state" style="text-align: center; padding: 4rem;">
                                       <div class="loading-spinner" style="width: 60px; height: 60px; border: 4px solid var(--sol-gray-200); border-top: 4px solid var(--sol-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 2rem;"></div>
                                       <h3 style="color: var(--sol-gray-600); margin: 0 0 1rem;">Caricamento Executive BI Dashboard...</h3>
                                       <p style="color: var(--sol-gray-500); margin: 0;">Analisi dati e generazione insights in corso</p>
                                   </div>
                               `;
                           }
                           
                           // Load data with delay for smooth UX
                           setTimeout(() => {
                               loadSectionData(targetSection);
                           }, 100);
                       }
                   });
               });
           });
       }

       // Create ShipmentsPageV14 class with enhanced commercial methods
       class ShipmentsPageV14 {
           constructor() {
               this.selectedRows = new Set();
           }

           // Enhanced Commercial Data Methods
           updateCommercialCompletionRates() {
               if (!window.shipmentsRegistry?.shipments) return;
               
               const shipments = window.shipmentsRegistry.shipments;
               const commercialShipments = shipments.filter(s => s.commercial);
               
               if (commercialShipments.length === 0) {
                   // Set all rates to 0% if no commercial data
                   ['po', 'pi', 'ci', 'bl'].forEach(type => {
                       const element = document.getElementById(`${type}CompletionRate`);
                       if (element) element.textContent = '0%';
                       
                       const statusElement = document.getElementById(`${type}StepStatus`);
                       if (statusElement) statusElement.textContent = 'Non Completato';
                   });
                   
                   const progressFill = document.getElementById('workflowProgressFill');
                   const progressText = document.getElementById('workflowProgressText');
                   if (progressFill) progressFill.style.width = '0%';
                   if (progressText) progressText.textContent = '0% workflow completato';
                   return;
               }
               
               // Calculate completion rates
               const rates = {
                   po: this.calculateDocumentCompletion(commercialShipments, 'purchaseOrder'),
                   pi: this.calculateDocumentCompletion(commercialShipments, 'proformaInvoice'),
                   ci: this.calculateDocumentCompletion(commercialShipments, 'commercialInvoice'),
                   bl: this.calculateDocumentCompletion(commercialShipments, 'transportDocument')
               };
               
               // Update UI
               Object.keys(rates).forEach(type => {
                   const element = document.getElementById(`${type}CompletionRate`);
                   if (element) {
                       element.textContent = `${rates[type].toFixed(0)}%`;
                   }
                   
                   // Update workflow step status
                   const step = document.querySelector(`[data-step="${type}"]`);
                   const statusElement = document.getElementById(`${type}StepStatus`);
                   
                   if (rates[type] >= 80) {
                       if (step) step.classList.add('completed');
                       if (statusElement) statusElement.textContent = 'Completato';
                   } else if (rates[type] > 0) {
                       if (step) step.classList.add('partial');
                       if (statusElement) statusElement.textContent = `${rates[type].toFixed(0)}% Completato`;
                   } else {
                       if (statusElement) statusElement.textContent = 'Non Completato';
                   }
               });
               
               // Update overall workflow progress
               const averageCompletion = Object.values(rates).reduce((sum, rate) => sum + rate, 0) / 4;
               const progressFill = document.getElementById('workflowProgressFill');
               const progressText = document.getElementById('workflowProgressText');
               
               if (progressFill) {
                   progressFill.style.width = `${averageCompletion}%`;
               }
               if (progressText) {
                   progressText.textContent = `${averageCompletion.toFixed(0)}% workflow completato`;
               }
           }

           calculateDocumentCompletion(shipments, documentType) {
               if (shipments.length === 0) return 0;
               
               const completed = shipments.filter(s => 
                   s.commercial && s.commercial[documentType] && 
                   Object.keys(s.commercial[documentType]).length > 0
               ).length;
               
               return (completed / shipments.length) * 100;
           }

           // Enhanced commercial data modal
           openCommercialDataModal(type = 'single', shipmentId = null) {
               if (window.ModalSystem) {
                   let content = '';
                   let title = '';
                   
                   if (type === 'bulk') {
                       title = 'Import Dati Commerciali Multipli';
                       content = `
                           <div class="bulk-commercial-import">
                               <p>Importa dati commerciali per multiple spedizioni:</p>
                               <div class="import-options">
                                   <div class="import-option" onclick="window.shipmentsPageV14.selectCommercialFile('excel')">
                                       <i class="fas fa-file-excel fa-2x"></i>
                                       <h4>Excel Template</h4>
                                       <p>Carica file Excel con dati PO/PI/CI/BL</p>
                                   </div>
                                   <div class="import-option" onclick="window.shipmentsPageV14.downloadCommercialTemplate()">
                                       <i class="fas fa-download fa-2x"></i>
                                       <h4>Download Template</h4>
                                       <p>Scarica template per data entry</p>
                                   </div>
                               </div>
                               <input type="file" id="commercialImportFile" style="display: none;" accept=".xlsx,.xls">
                           </div>
                       `;
                   } else {
                       title = 'Dati Commerciali Spedizione';
                       content = `
                           <iframe src="/pages/shipments/smart-commercial-forms.html${shipmentId ? '?shipment=' + shipmentId : ''}" 
                                   style="width: 100%; height: 70vh; border: none; border-radius: var(--sol-radius-md);">
                           </iframe>
                       `;
                   }
                   
                   window.ModalSystem.show({
                       title: title,
                       content: content,
                       size: type === 'bulk' ? 'lg' : 'fullscreen',
                       hideClose: false
                   });
               }
           }

           selectCommercialFile(type) {
               const input = document.getElementById('commercialImportFile');
               if (!input) return;
               
               input.accept = type === 'excel' ? '.xlsx,.xls' : '.csv';
               input.onchange = (e) => {
                   if (e.target.files.length > 0) {
                       this.importCommercialFile(e.target.files[0]);
                   }
               };
               input.click();
           }

           async importCommercialFile(file) {
               try {
                   // Parse file logic here
                   console.log('Importing commercial file:', file.name);
                   window.NotificationSystem?.show('Import', 'Importazione dati commerciali in corso...', 'info');
                   
                   // Simulate import
                   setTimeout(() => {
                       window.NotificationSystem?.show('Success', 'Dati commerciali importati con successo', 'success');
                       this.updateCommercialCompletionRates();
                   }, 2000);
                   
               } catch (error) {
                   console.error('Commercial import error:', error);
                   window.NotificationSystem?.show('Errore', 'Errore durante importazione dati commerciali', 'error');
               }
           }

           downloadCommercialTemplate() {
               const template = `Shipment Number,PO Number,PO Value,PI Number,PI Value,CI Number,CI Value,BL Number,Incoterms,Payment Method
MSKU1234567,PO-2024-001,15000,PI-2024-001,15000,CI-2024-001,15000,BL-2024-001,FOB,T/T
MSCU7654321,PO-2024-002,22000,PI-2024-002,22000,CI-2024-002,22000,BL-2024-002,CIF,L/C`;
               
               const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
               const link = document.createElement('a');
               link.href = URL.createObjectURL(blob);
               link.download = 'commercial_data_template.csv';
               link.click();
               URL.revokeObjectURL(link.href);
               
               window.ModalSystem?.close();
               window.NotificationSystem?.show('Download', 'Template commerciale scaricato', 'success');
           }

           // Enhanced table rendering with documents and commercial columns  
           renderShipmentRow(shipment) {
               const isSelected = this.selectedRows?.has(shipment.id) || false;
               
               // Get documents count
               const documentsCount = window.documentsManager ? 
                   window.documentsManager.getShipmentDocuments(shipment.id).length : 0;
               
               // Get commercial completion status
               const commercialStatus = this.getCommercialStatus(shipment);
               
               // Check column visibility
               const cm = window.columnManager;
               
               return `
                   <tr data-id="${shipment.id}" class="${isSelected ? 'selected' : ''}" data-shipment-id="${shipment.id}">
                       ${cm.isColumnVisible('checkbox') ? `
                           <td>
                               <input type="checkbox" 
                                      class="shipment-checkbox" 
                                      value="${shipment.id}"
                                      ${isSelected ? 'checked' : ''}>
                           </td>
                       ` : ''}
                       ${cm.isColumnVisible('shipmentNumber') ? `
                           <td class="font-mono">
                               <a href="#" onclick="window.shipmentDetails?.show('${shipment.id}'); return false;" 
                                  class="text-primary" style="text-decoration: none;">
                                   ${shipment.shipmentNumber}
                               </a>
                           </td>
                       ` : ''}
                       ${cm.isColumnVisible('type') ? `
                           <td>${this.getShipmentTypeIcon(shipment.type)} ${shipment.type}</td>
                       ` : ''}
                       ${cm.isColumnVisible('status') ? `
                           <td>
                               <span class="sol-badge status-${shipment.status}">
                                   ${this.getStatusLabel(shipment.status)}
                               </span>
                           </td>
                       ` : ''}
                       ${cm.isColumnVisible('carrier') ? `
                           <td>${shipment.carrier?.name || 'N/A'}</td>
                       ` : ''}
                       ${cm.isColumnVisible('origin') ? `
                           <td>
                               <small class="text-muted">${shipment.route?.origin?.port || ''}</small><br>
                               ${shipment.route?.origin?.name || 'N/A'}
                           </td>
                       ` : ''}
                       ${cm.isColumnVisible('destination') ? `
                           <td>
                               <small class="text-muted">${shipment.route?.destination?.port || ''}</small><br>
                               ${shipment.route?.destination?.name || 'N/A'}
                           </td>
                       ` : ''}
                       ${cm.isColumnVisible('etd') ? `
                           <td>${this.formatDate(shipment.schedule?.etd)}</td>
                       ` : ''}
                       ${cm.isColumnVisible('eta') ? `
                           <td>${this.formatDate(shipment.schedule?.eta)}</td>
                       ` : ''}
                       ${cm.isColumnVisible('products') ? `
                           <td>
                               ${shipment.products && shipment.products.length > 0 ? `
                                   <span class="sol-badge sol-badge-info">
                                       ${shipment.products.length} prodotti
                                   </span>
                               ` : `
                                   <button class="sol-btn sol-btn-sm sol-btn-glass" 
                                           onclick="window.registryCore?.linkProducts('${shipment.id}')"
                                           title="Collega prodotti">
                                       <i class="fas fa-link"></i> Collega
                                   </button>
                               `}
                           </td>
                       ` : ''}
                       ${cm.isColumnVisible('documents') ? `
                           <td class="documents-cell">
                               ${this.renderDocumentsButton(shipment.id, documentsCount)}
                           </td>
                       ` : ''}
                       ${cm.isColumnVisible('commercial') ? `
                           <td class="commercial-cell">
                               <span class="commercial-status ${commercialStatus.class}" 
                                     onclick="window.shipmentsPageV14.openCommercialDataModal('single', '${shipment.id}')"
                                     style="cursor: pointer;" title="Click per aprire dati commerciali">
                                   ${commercialStatus.text}
                               </span>
                           </td>
                       ` : ''}
                       ${cm.isColumnVisible('totalCost') ? `
                           <td style="text-align: right;">
                               <strong>â‚¬${(shipment.costs?.total || 0).toLocaleString('it-IT')}</strong>
                           </td>
                       ` : ''}
                       ${cm.isColumnVisible('actions') ? `
                           <td>
                               <div class="btn-group">
                                   <button class="sol-btn sol-btn-sm sol-btn-glass" 
                                           onclick="window.shipmentDetails?.show('${shipment.id}')"
                                           title="Visualizza">
                                       <i class="fas fa-eye"></i>
                                   </button>
                                   <button class="sol-btn sol-btn-sm sol-btn-glass" 
                                           onclick="window.shipmentDetails?.edit('${shipment.id}')"
                                           title="Modifica">
                                       <i class="fas fa-edit"></i>
                                   </button>
                                   <button class="sol-btn sol-btn-sm sol-btn-glass" 
                                           onclick="window.registryCore?.deleteShipment('${shipment.id}')"
                                           title="Elimina">
                                       <i class="fas fa-trash"></i>
                                   </button>
                               </div>
                           </td>
                       ` : ''}
                   </tr>
               `;
           }

           // Helper method for documents button
           renderDocumentsButton(shipmentId, documentsCount) {
               if (documentsCount > 0) {
                   return `
                       <button class="sol-btn sol-btn-sm sol-btn-glass documents-btn" 
                               onclick="window.documentsManager?.showDocumentsList('${shipmentId}')"
                               title="${documentsCount} documenti caricati">
                           <i class="fas fa-folder"></i>
                           <span class="doc-count">${documentsCount}</span>
                       </button>
                   `;
               } else {
                   return `
                       <button class="sol-btn sol-btn-sm sol-btn-glass documents-btn empty" 
                               onclick="window.documentsManager?.showUploadModal('${shipmentId}')"
                               title="Carica documenti">
                           <i class="fas fa-folder-plus"></i>
                           <span class="doc-count" style="display: none;">0</span>
                       </button>
                   `;
               }
           }

           // Enhanced commercial status method
           getCommercialStatus(shipment) {
               if (!shipment.commercial) {
                   return { class: 'missing', text: '-/-/-' };
               }
               
               const docs = ['purchaseOrder', 'proformaInvoice', 'commercialInvoice'];
               const completed = docs.filter(doc => 
                   shipment.commercial[doc] && Object.keys(shipment.commercial[doc]).length > 0
               ).length;
               
               if (completed === 3) {
                   return { class: 'complete', text: 'PO/PI/CI' };
               } else if (completed > 0) {
                   const status = docs.map(doc => 
                       shipment.commercial[doc] && Object.keys(shipment.commercial[doc]).length > 0 ? 
                       doc.substring(0, 2).toUpperCase() : '-'
                   ).join('/');
                   return { class: 'partial', text: status };
               } else {
                   return { class: 'missing', text: '-/-/-' };
               }
           }

           getShipmentTypeIcon(type) {
               const icons = {
                   container: '<i class="fas fa-cube"></i>',
                   awb: '<i class="fas fa-plane"></i>',
                   bl: '<i class="fas fa-ship"></i>',
                   lcl: '<i class="fas fa-boxes"></i>'
               };
               return icons[type] || '<i class="fas fa-box"></i>';
           }

           getStatusLabel(status) {
               const labels = {
                   planned: 'Pianificata',
                   departed: 'Partita',
                   in_transit: 'In Transito',
                   arrived: 'Arrivata',
                   delivered: 'Consegnata'
               };
               return labels[status] || status;
           }

           formatDate(date) {
               if (!date) return 'N/A';
               return new Date(date).toLocaleDateString('it-IT');
           }

           // New commercial analytics methods
           validateCommercialData() {
               if (!window.enhancedCommercialModel) {
                   window.NotificationSystem?.show('Errore', 'Enhanced Commercial Model non disponibile', 'error');
                   return;
               }
               
               const shipments = window.shipmentsRegistry?.shipments || [];
               const commercialShipments = shipments.filter(s => s.commercial);
               
               if (commercialShipments.length === 0) {
                   window.NotificationSystem?.show('Info', 'Nessun dato commerciale da validare', 'info');
                   return;
               }
               
               let validShipments = 0;
               let totalErrors = 0;
               let totalWarnings = 0;
               
               commercialShipments.forEach(shipment => {
                   const validation = window.enhancedCommercialModel.validateShipment(shipment);
                   if (validation.valid) {
                       validShipments++;
                   }
                   totalErrors += validation.errors.length;
                   totalWarnings += validation.warnings.length;
               });
               
               const validationResult = `
                   <div class="validation-summary">
                       <div class="validation-stats">
                           <div class="stat">
                               <i class="fas fa-check-circle" style="color: var(--sol-success);"></i>
                               <strong>${validShipments}</strong> spedizioni valide
                           </div>
                           <div class="stat">
                               <i class="fas fa-exclamation-circle" style="color: var(--sol-danger);"></i>
                               <strong>${totalErrors}</strong> errori totali
                           </div>
                           <div class="stat">
                               <i class="fas fa-exclamation-triangle" style="color: var(--sol-warning);"></i>
                               <strong>${totalWarnings}</strong> avvisi totali
                           </div>
                       </div>
                       <div class="validation-score">
                           <strong>Score Complessivo: ${((validShipments / commercialShipments.length) * 100).toFixed(0)}%</strong>
                       </div>
                   </div>
               `;
               
               window.ModalSystem?.show({
                   title: 'Risultati Validazione Dati Commerciali',
                   content: validationResult,
                   size: 'md'
               });
           }

           exportCommercialReport() {
               if (!window.shipmentsRegistry?.shipments) {
                   window.NotificationSystem?.show('Errore', 'Nessun dato da esportare', 'error');
                   return;
               }
               
               const shipments = window.shipmentsRegistry.shipments;
               const commercialData = shipments.map(s => ({
                   'Shipment Number': s.shipmentNumber,
                   'PO Number': s.commercial?.purchaseOrder?.poNumber || '',
                   'PO Value': s.commercial?.purchaseOrder?.poValue || '',
                   'PI Number': s.commercial?.proformaInvoice?.piNumber || '',
                   'PI Value': s.commercial?.proformaInvoice?.piValue || '',
                   'CI Number': s.commercial?.commercialInvoice?.ciNumber || '',
                   'CI Value': s.commercial?.commercialInvoice?.ciValue || '',
                   'BL Number': s.commercial?.transportDocument?.blNumber || '',
                   'Total Weight': s.commercial?.cargo?.totalWeight || '',
                   'CBM': s.commercial?.cargo?.cbm || '',
                   'Incoterms': s.commercial?.financial?.incoterms || '',
                   'Payment Method': s.commercial?.financial?.paymentMethod || ''
               }));
               
               const csv = Papa.unparse(commercialData);
               const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
               const link = document.createElement('a');
               link.href = URL.createObjectURL(blob);
               link.download = `commercial_data_report_${new Date().toISOString().split('T')[0]}.csv`;
               link.click();
               URL.revokeObjectURL(link.href);
               
               window.NotificationSystem?.show('Export', 'Report commerciale esportato', 'success');
           }

           showCommercialAnalytics() {
               // Switch to Executive BI Dashboard tab and show commercial metrics
               const biTab = document.querySelector('[data-section="cost-analysis"]');
               if (biTab) {
                   biTab.click();
                   
                   setTimeout(() => {
                       if (window.executiveBIDashboard) {
                           window.executiveBIDashboard.focusCommercialMetrics();
                       }
                   }, 500);
               }
           }
       }

       // Initialize ShipmentsPageV14 instance
       window.shipmentsPageV14 = new ShipmentsPageV14();

       // Generate comprehensive sample data for BI insights
       function generateComprehensiveSampleData() {
           const carriers = [
               { code: 'MAERSK', name: 'Maersk Line', service: 'AE7' },
               { code: 'MSC', name: 'MSC', service: 'TIGER' },
               { code: 'CMA', name: 'CMA CGM', service: 'COLUMBUS' },
               { code: 'COSCO', name: 'COSCO Shipping', service: 'OCEAN ALLIANCE' },
               { code: 'HAPAG', name: 'Hapag-Lloyd', service: 'AL1' }
           ];
           
           const routes = [
               { origin: { port: 'CNSHA', name: 'Shanghai', country: 'China' }, destination: { port: 'ITGOA', name: 'Genova', country: 'Italy' } },
               { origin: { port: 'CNNBO', name: 'Ningbo', country: 'China' }, destination: { port: 'ITLIV', name: 'Livorno', country: 'Italy' } },
               { origin: { port: 'CNQIN', name: 'Qingdao', country: 'China' }, destination: { port: 'ITLSP', name: 'La Spezia', country: 'Italy' } },
               { origin: { port: 'CNXMN', name: 'Xiamen', country: 'China' }, destination: { port: 'ITNAP', name: 'Napoli', country: 'Italy' } },
               { origin: { port: 'HKHKG', name: 'Hong Kong', country: 'Hong Kong' }, destination: { port: 'ITMXP', name: 'Milano Malpensa', country: 'Italy' } }
           ];
           
           const statuses = ['planned', 'departed', 'in_transit', 'arrived', 'delivered'];
           const types = ['container', 'awb', 'bl', 'lcl'];
           
           const sampleShipments = [];
           
           // Generate shipments for the last 12 months
           for (let month = 11; month >= 0; month--) {
               const shipmentsThisMonth = Math.floor(Math.random() * 15) + 8; // 8-22 shipments per month
               
               for (let i = 0; i < shipmentsThisMonth; i++) {
                   const date = new Date();
                   date.setMonth(date.getMonth() - month);
                   date.setDate(Math.floor(Math.random() * 28) + 1);
                   
                   const carrier = carriers[Math.floor(Math.random() * carriers.length)];
                   const route = routes[Math.floor(Math.random() * routes.length)];
                   const type = types[Math.floor(Math.random() * types.length)];
                   const status = statuses[Math.floor(Math.random() * statuses.length)];
                   
                   // Generate realistic cost variations
                   const baseCost = 2800 + (Math.random() * 1500); // 2800-4300 base
                   const seasonalMultiplier = 1 + (Math.sin((month - 2) * Math.PI / 6) * 0.15); // Seasonal variation
                   const carrierMultiplier = carrier.code === 'MAERSK' ? 1.1 : carrier.code === 'MSC' ? 0.95 : 1.0;
                   
                   const totalCost = Math.round(baseCost * seasonalMultiplier * carrierMultiplier);
                   
                   // Calculate ETD/ETA with realistic delays
                   const etd = new Date(date);
                   etd.setDate(etd.getDate() + Math.floor(Math.random() * 10) + 5);
                   
                   const estimatedTransit = 25 + Math.floor(Math.random() * 15); // 25-40 days
                   const eta = new Date(etd);
                   eta.setDate(eta.getDate() + estimatedTransit);
                   
                   // Actual arrival with 20% chance of delay
                   let ata = null;
                   if (['arrived', 'delivered'].includes(status)) {
                       ata = new Date(eta);
                       if (Math.random() < 0.2) { // 20% delayed
                           ata.setDate(ata.getDate() + Math.floor(Math.random() * 7) + 1); // 1-7 days delay
                       }
                   }
                   
                   const shipment = {
                       id: `SHIP-2024-${String(Date.now() + i).slice(-6)}`,
                       shipmentNumber: `${carrier.code}${String(Math.floor(Math.random() * 9000000) + 1000000)}`,
                       type: type,
                       carrier: carrier,
                       route: {
                           ...route,
                           via: Math.random() > 0.5 ? ['SGSIN'] : [],
                           distance: 18000 + Math.floor(Math.random() * 5000),
                           estimatedTransit: estimatedTransit
                       },
                       schedule: {
                           etd: etd.toISOString().split('T')[0],
                           eta: eta.toISOString().split('T')[0],
                           atd: ['departed', 'in_transit', 'arrived', 'delivered'].includes(status) ? etd.toISOString().split('T')[0] : null,
                           ata: ata ? ata.toISOString().split('T')[0] : null
                       },
                       products: [], // Add products separately if needed
                       costs: {
                           oceanFreight: Math.round(totalCost * 0.7),
                           bunkerSurcharge: Math.round(totalCost * 0.15),
                           portCharges: Math.round(totalCost * 0.08),
                           customs: Math.round(totalCost * 0.04),
                           insurance: Math.round(totalCost * 0.03),
                           total: totalCost,
                           currency: 'EUR'
                       },
                       status: status,
                       createdAt: date.toISOString(),
                       updatedAt: new Date().toISOString()
                   };
                   
                   sampleShipments.push(shipment);
               }
           }
           
           return sampleShipments;
       }

       // Ensure sample data exists for meaningful BI insights
       async function ensureSampleData() {
           if (!window.shipmentsRegistry) return;
           
           // Check if we have enough data for meaningful insights
           const shipments = window.shipmentsRegistry.shipments || [];
           
           if (shipments.length < 10) {
               console.log('ðŸ“Š Adding sample data for Executive BI Dashboard...');
               
               // Generate more comprehensive sample data
               const sampleShipments = generateComprehensiveSampleData();
               
               // Add to registry
               for (const shipment of sampleShipments) {
                   window.shipmentsRegistry.shipments.push(shipment);
               }
               
               // Save to localStorage
               window.shipmentsRegistry.saveShipments();
               
               console.log(`âœ… Added ${sampleShipments.length} sample shipments for BI analysis`);
           }
       }

       // Enhanced KPI update function with BI insights
       function updateKPIs(shipments) {
           if (!shipments || shipments.length === 0) return;
           
           // Calculate enhanced KPIs
           const total = shipments.length;
           const active = shipments.filter(s => s.status === 'in_transit').length;
           const totalCosts = shipments.reduce((sum, s) => sum + (s.costs?.total || 0), 0);
           const avgTransit = calculateAvgTransitTime(shipments);
           
           // Calculate month-over-month growth
           const now = new Date();
           const currentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
           const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
           
           const currentMonthShipments = shipments.filter(s => new Date(s.createdAt) >= currentMonth).length;
           const lastMonthShipments = shipments.filter(s => 
               new Date(s.createdAt) >= lastMonth && new Date(s.createdAt) < currentMonth
           ).length;
           
           const growthRate = lastMonthShipments > 0 ? 
               ((currentMonthShipments - lastMonthShipments) / lastMonthShipments * 100) : 0;
           
           // Update KPI displays with enhanced formatting
           document.getElementById('totalShipments').textContent = total;
           document.getElementById('activeShipments').textContent = active;
           document.getElementById('totalCosts').textContent = `â‚¬${totalCosts.toLocaleString('it-IT')}`;
           document.getElementById('avgTransitTime').textContent = `${avgTransit}gg`;
           
           // Add growth indicators
           const totalElement = document.getElementById('totalShipments').parentElement;
           if (totalElement && !totalElement.querySelector('.growth-indicator')) {
               const growthIndicator = document.createElement('div');
               growthIndicator.className = 'growth-indicator';
               growthIndicator.style.fontSize = '0.75rem';
               growthIndicator.style.color = growthRate >= 0 ? 'var(--sol-success)' : 'var(--sol-danger)';
               growthIndicator.style.marginTop = '0.25rem';
               growthIndicator.innerHTML = `
                   <i class="fas fa-arrow-${growthRate >= 0 ? 'up' : 'down'}"></i>
                   ${Math.abs(growthRate).toFixed(1)}% MoM
               `;
               totalElement.appendChild(growthIndicator);
           }
       }

       // Enhanced page initialization with Executive BI support
       document.addEventListener('DOMContentLoaded', async () => {
           console.log('ðŸš¢ Initializing Enhanced Shipments Registry with Executive BI...');

           if (window.organizationService && !window.organizationService.initialized) {
               await window.organizationService.init();
           }

           // // Initialize header
           // if (window.headerComponent) {
           //     await window.headerComponent.init();
           // }
           
           // Initialize Phase 2 Architecture
           if (window.Phase2Architecture) {
               window.productIntelligence = window.Phase2Architecture.initialize();
               console.log('âœ… Product Intelligence connected');
           }
           
           // Initialize Shipments Registry
           if (window.ShipmentsRegistry) {
               window.shipmentsRegistry = new window.ShipmentsRegistry();
               await window.shipmentsRegistry.init();
               console.log('âœ… Shipments Registry initialized');
               
               // Dispatch ready event for CarrierPerformance and Executive BI
               window.dispatchEvent(new Event('shipmentsRegistryReady'));
           }
           
           // Pre-load Executive BI Dashboard CSS
           loadExecutiveBIStyles();
           
           // Initialize tabs with enhanced functionality
           initializeTabs();
           
           // Initialize filters
           initializeFilters();
           
           // Load initial data
           loadShipmentsData();
           
           // Setup event listeners
           setupEventListeners();
           
           // Setup import button
           const importBtn = document.getElementById('importShipmentsBtn');
           if (importBtn) {
               importBtn.onclick = openImportModal;
           }
           
           // Setup commercial forms button
           const commercialBtn = document.getElementById('openCommercialFormsBtn');
           if (commercialBtn) {
               commercialBtn.onclick = () => window.shipmentsPageV14.openCommercialDataModal('single');
           }
           
           // Setup documents integration
           setupDocumentsIntegration();
           
           // Add sample data if none exists
           await ensureSampleData();
           
           console.log('âœ… Enhanced Shipments Registry with Executive BI initialized');
       });

       // Load Executive BI Dashboard CSS dynamically
       function loadExecutiveBIStyles() {
           // Check if styles already loaded
           if (document.getElementById('executive-bi-styles')) return;
           
           const link = document.createElement('link');
           link.id = 'executive-bi-styles';
           link.rel = 'stylesheet';
           link.href = '/pages/shipments/executive-bi-dashboard.css';
           document.head.appendChild(link);
       }

       // Add notification for Executive BI Dashboard activation
       window.addEventListener('shipmentsRegistryReady', () => {
           setTimeout(() => {
               if (window.NotificationSystem) {
                   window.NotificationSystem.show(
                       'Executive BI Dashboard', 
                       'Advanced analytics disponibili nella tab "Analisi Costi"', 
                       'info',
                       5000
                   );
               }
           }, 2000);
       });

       console.log('ðŸ“Š Executive BI Dashboard integration loaded');
   </script>

   <script>
       // ADDED: Documents integration setup
       function setupDocumentsIntegration() {
           // Listen for documents updates to refresh table
           window.addEventListener('documentsUpdated', (e) => {
               const { action, document } = e.detail;
               
               if (action === 'upload' || action === 'delete') {
                   // Update the documents count in the table without full refresh
                   updateDocumentsCountInTable(document.shipmentId);
                   
                   // Update any open shipment details modal
                   if (window.shipmentDetails && window.shipmentDetails.currentShipment?.id === document.shipmentId) {
                       window.shipmentDetails.updateDocumentsCount();
                       if (window.shipmentDetails.activeTab === 'documents') {
                           window.shipmentDetails.refreshDocumentsTab();
                       }
                   }
               }
           });
       }

       // ADDED: Function to update documents count in table
       function updateDocumentsCountInTable(shipmentId) {
           const row = document.querySelector(`tr[data-shipment-id="${shipmentId}"]`);
           if (!row || !window.documentsManager) return;
           
           const documentsCell = row.querySelector('.documents-cell');
           const docCountSpan = row.querySelector('.doc-count');
           const documentsBtn = row.querySelector('.documents-btn');
           
           if (documentsCell && docCountSpan && documentsBtn) {
               const count = window.documentsManager.getShipmentDocuments(shipmentId).length;
               
               // Update count display
               docCountSpan.textContent = count;
               
               if (count > 0) {
                   // Show count and update button to view documents
                   docCountSpan.style.display = 'inline';
                   documentsBtn.classList.remove('empty');
                   documentsBtn.onclick = () => window.documentsManager.showDocumentsList(shipmentId);
                   documentsBtn.title = `${count} documenti caricati`;
                   
                   const icon = documentsBtn.querySelector('i');
                   if (icon) {
                       icon.className = 'fas fa-folder';
                   }
               } else {
                   // Hide count and update button to upload documents
                   docCountSpan.style.display = 'none';
                   documentsBtn.classList.add('empty');
                   documentsBtn.onclick = () => window.documentsManager.showUploadModal(shipmentId);
                   documentsBtn.title = 'Carica documenti';
                   
                   const icon = documentsBtn.querySelector('i');
                   if (icon) {
                       icon.className = 'fas fa-folder-plus';
                   }
               }
           }
       }

       // Initialize Filters
       function initializeFilters() {
           // Populate carrier filter dynamically
           populateCarrierFilter();
           
           // Add filter event listeners
           ['statusFilter', 'typeFilter', 'carrierFilter', 'periodFilter'].forEach(filterId => {
               document.getElementById(filterId)?.addEventListener('change', applyFilters);
           });
           
           // Search input
           let searchTimeout;
           document.getElementById('searchRegistry')?.addEventListener('input', (e) => {
               clearTimeout(searchTimeout);
               searchTimeout = setTimeout(() => applyFilters(), 300);
           });
           
           // Reset filters
           document.getElementById('resetFiltersBtn')?.addEventListener('click', resetFilters);
       }

       // Load shipments data
       async function loadShipmentsData() {
           try {
               // Show loading state
               showLoading();
               
               // Load from API or localStorage (MVP approach)
               const shipments = await loadShipments();
               
               // Update KPIs
               updateKPIs(shipments);
               
               // Render table
               renderShipmentsTable(shipments);
               
               // Update count
               document.getElementById('registryCount').textContent = shipments.length;
               
           } catch (error) {
               console.error('Error loading shipments:', error);
               showError('Errore nel caricamento delle spedizioni');
           } finally {
               hideLoading();
           }
       }

       // FIXED: Routes/Performance data loading
       function loadRoutesData() {
           console.log('ðŸš€ Loading routes data...');
           
           // Ensure registry is loaded first
           if (!window.shipmentsRegistry || window.shipmentsRegistry.shipments.length === 0) {
               console.log('â³ Waiting for shipments to load...');
               // Wait a bit and retry
               setTimeout(() => {
                   if (window.shipmentsRegistry && window.shipmentsRegistry.shipments.length > 0) {
                       loadRoutesData();
                   }
               }, 500);
               return;
           }
           
           if (window.carrierPerformance) {
               console.log('âœ… CarrierPerformance found, initializing...');
               
               try {
                   // Force reload carrier data
                   window.carrierPerformance.loadCarrierData();
                   
                   // Wait for data processing
                   setTimeout(() => {
                       try {
                           // Refresh all analytics displays
                           window.carrierPerformance.refreshAnalytics();
                           
                           // Generate charts with slight delay
                           setTimeout(() => {
                               try {
                                   window.carrierPerformance.generateCarrierComparisonChart('carrierComparisonChart');
                                   window.carrierPerformance.generateRouteEfficiencyChart('routeEfficiencyChart');
                               } catch (chartError) {
                                   console.error('Error generating charts:', chartError);
                               }
                           }, 200);
                       } catch (refreshError) {
                           console.error('Error refreshing analytics:', refreshError);
                       }
                   }, 300);
               } catch (error) {
                   console.error('Error loading carrier data:', error);
               }
           } else {
               console.warn('âŒ CarrierPerformance not initialized');
           }
       }

       // Event Listeners
       function setupEventListeners() {
           // Add shipment
           document.getElementById('addShipmentBtn')?.addEventListener('click', () => {
               openShipmentModal();
           });
           
           // Export registry
           document.getElementById('exportRegistryBtn')?.addEventListener('click', () => {
               exportRegistry();
           });
           
           // Bulk actions
           document.getElementById('bulkActionsBtn')?.addEventListener('click', () => {
               showBulkActionsMenu();
           });
           
           // Cost allocation
           document.getElementById('costAllocationBtn')?.addEventListener('click', () => {
               openCostAllocationModal();
           });
           
           // Select all checkbox
           document.getElementById('selectAllShipments')?.addEventListener('change', (e) => {
               toggleSelectAll(e.target.checked);
           });
           
           // Columns manager - UPDATED TO USE COLUMN MANAGER
           document.getElementById('columnsManagerBtn')?.addEventListener('click', () => {
               openColumnsManager();
           });
           
           // Refresh data
           document.getElementById('refreshDataBtn')?.addEventListener('click', () => {
               loadShipmentsData();
           });
       }

       // Placeholder functions (to be implemented in registry-core.js)
       async function loadShipments() {
           // Ensure we return an array
           if (window.shipmentsRegistry && window.shipmentsRegistry.shipments) {
               return window.shipmentsRegistry.shipments;
           }
           
           // MVP: Load from localStorage first
           const orgId = window.organizationService?.getCurrentOrgId();
           const savedShipments = localStorage.getItem(`shipmentsRegistry_${orgId}`);
           if (savedShipments) {
               try {
                   const parsed = JSON.parse(savedShipments);
                   // Handle both old and new format
                   if (Array.isArray(parsed)) {
                       return parsed;
                   } else if (parsed.shipments && Array.isArray(parsed.shipments)) {
                       return parsed.shipments;
                   }
               } catch (e) {
                   console.error('Error parsing saved shipments:', e);
               }
           }
           
           // Default empty array
           return [];
       }

       function calculateAvgTransitTime(shipments) {
           const validShipments = shipments.filter(s => s.schedule?.estimatedTransit);
           if (validShipments.length === 0) return 0;
           
           const totalDays = validShipments.reduce((sum, s) => sum + s.schedule.estimatedTransit, 0);
           return Math.round(totalDays / validShipments.length);
       }

       // MODIFIED: Enhanced render function with documents and commercial columns AND column visibility
       function renderShipmentsTable(shipments) {
           const tbody = document.getElementById('shipmentsTableBody');
           if (!tbody) return;
           
           // Update table headers based on column visibility
           const thead = document.querySelector('#shipmentsTable thead tr');
           if (thead && window.columnManager) {
               const headerHTML = window.columnManager.getVisibleColumns().map(col => {
                   switch(col.id) {
                       case 'checkbox':
                           return `<th data-sort="${col.id}"><input type="checkbox" id="selectAllShipments"></th>`;
                       case 'documents':
                           return `<th data-sort="${col.id}"><i class="fas fa-folder"></i> Docs</th>`;
                       case 'commercial':
                           return `<th data-sort="${col.id}"><i class="fas fa-file-contract"></i> PO/PI/CI</th>`;
                       default:
                           return `<th data-sort="${col.id}">${col.label}</th>`;
                   }
               }).join('');
               thead.innerHTML = headerHTML;
               
               // Re-attach select all handler
               const selectAll = document.getElementById('selectAllShipments');
               if (selectAll) {
                   selectAll.addEventListener('change', (e) => toggleSelectAll(e.target.checked));
               }
           }
           
           // Render table body
           tbody.innerHTML = shipments.map(shipment => {
               if (window.shipmentsPageV14) {
                   return window.shipmentsPageV14.renderShipmentRow(shipment);
               } else {
                   // Fallback rendering
                   return renderBasicShipmentRow(shipment);
               }
           }).join('');
       }

       // Fallback basic row rendering
       function renderBasicShipmentRow(shipment) {
           const cm = windowconst;
           
           return `
               <tr data-id="${shipment.id}" data-shipment-id="${shipment.id}">
                   ${cm.isColumnVisible('checkbox') ? `<td><input type="checkbox" class="shipment-checkbox" value="${shipment.id}"></td>` : ''}
                   ${cm.isColumnVisible('shipmentNumber') ? `<td class="font-mono">${shipment.shipmentNumber}</td>` : ''}
                   ${cm.isColumnVisible('type') ? `<td>${shipment.type}</td>` : ''}
                   ${cm.isColumnVisible('status') ? `<td><span class="sol-badge status-${shipment.status}">${shipment.status}</span></td>` : ''}
                   ${cm.isColumnVisible('carrier') ? `<td>${shipment.carrier?.name || 'N/A'}</td>` : ''}
                   ${cm.isColumnVisible('origin') ? `<td>${shipment.route?.origin?.name || 'N/A'}</td>` : ''}
                   ${cm.isColumnVisible('destination') ? `<td>${shipment.route?.destination?.name || 'N/A'}</td>` : ''}
                   ${cm.isColumnVisible('etd') ? `<td>${formatDate(shipment.schedule?.etd)}</td>` : ''}
                   ${cm.isColumnVisible('eta') ? `<td>${formatDate(shipment.schedule?.eta)}</td>` : ''}
                   ${cm.isColumnVisible('products') ? `<td>${shipment.products?.length || 0} prodotti</td>` : ''}
                   ${cm.isColumnVisible('documents') ? `<td class="documents-cell">-</td>` : ''}
                   ${cm.isColumnVisible('commercial') ? `<td class="commercial-cell">-</td>` : ''}
                   ${cm.isColumnVisible('totalCost') ? `<td>â‚¬${(shipment.costs?.total || 0).toLocaleString('it-IT')}</td>` : ''}
                   ${cm.isColumnVisible('actions') ? `
                       <td>
                           <button class="sol-btn sol-btn-sm sol-btn-glass" onclick="viewShipmentDetails('${shipment.id}')">
                               <i class="fas fa-eye"></i>
                           </button>
                       </td>
                   ` : ''}
               </tr>
           `;
       }

       // Helper functions
       function getShipmentTypeIcon(type) {
           const icons = {
               container: '<i class="fas fa-cube"></i>',
               awb: '<i class="fas fa-plane"></i>',
               bl: '<i class="fas fa-ship"></i>',
               lcl: '<i class="fas fa-boxes"></i>'
           };
           return icons[type] || '<i class="fas fa-box"></i>';
       }

       function getStatusLabel(status) {
           const labels = {
               planned: 'Pianificata',
               departed: 'Partita',
               in_transit: 'In Transito',
               arrived: 'Arrivata',
               delivered: 'Consegnata'
           };
           return labels[status] || status;
       }

       function formatDate(date) {
           if (!date) return 'N/A';
           return new Date(date).toLocaleDateString('it-IT');
       }

       // Loading states
       function showLoading() {
           // Add loading overlay
       }

       function hideLoading() {
           // Remove loading overlay
       }

       function showError(message) {
           if (window.NotificationSystem) {
               window.NotificationSystem.show('Errore', message, 'error');
           }
       }

       // Placeholder for other functions
       function applyFilters() {
           console.log('Applying filters...');
       }

       function resetFilters() {
           console.log('Resetting filters...');
       }

       function populateCarrierFilter() {
           console.log('Populating carrier filter...');
       }

       // Modal functions
       window.openShipmentModal = function() {
           if (window.shipmentDetails) {
               window.shipmentDetails.create();
           }
       };

       // NEW IMPORT INTEGRATION CODE
       window.openImportModal = function() {
           if (window.ModalSystem) {
               window.ModalSystem.show({
                   title: 'Importa Spedizioni',
                   content: `
                       <div class="import-options">
                           <div class="import-option" onclick="selectImportFile('csv')">
                               <i class="fas fa-file-csv fa-3x"></i>
                               <h4>File CSV</h4>
                               <p>Importa da file CSV</p>
                           </div>
                           <div class="import-option" onclick="selectImportFile('excel')">
                               <i class="fas fa-file-excel fa-3x"></i>
                               <h4>File Excel</h4>
                               <p>Importa da file Excel</p>
                           </div>
                           <div class="import-option" onclick="downloadShipmentTemplate()">
                               <i class="fas fa-download fa-3x"></i>
                               <h4>Download Template</h4>
                               <p>Scarica template di esempio</p>
                           </div>
                       </div>
                       <input type="file" id="shipmentImportFile" style="display: none;" accept=".csv,.xlsx,.xls">
                   `,
                   size: 'lg'
               });
           }
       };

       window.selectImportFile = function(type) {
           const input = document.getElementById('shipmentImportFile');
           if (type === 'csv') {
               input.accept = '.csv';
           } else {
               input.accept = '.xlsx,.xls';
           }
           
           input.onchange = function(e) {
               if (e.target.files.length > 0) {
                   importShipmentsFile(e.target.files[0]);
               }
           };
           
           input.click();
       };

       window.importShipmentsFile = async function(file) {
           try {
               // Close the import modal
               window.ModalSystem.close();
               
               // Show progress
               const progressModal = window.ModalSystem?.progress?.({
                   title: 'Import Spedizioni',
                   message: 'Analisi file...',
                   showPercentage: true
               });
               
               // Parse file
               let data = [];
               const extension = file.name.split('.').pop().toLowerCase();
               
               if (extension === 'csv') {
                   data = await parseCSVFile(file);
               } else if (['xlsx', 'xls'].includes(extension)) {
                   data = await parseExcelFile(file);
               }
               
               progressModal?.update(25, 'Validazione dati...');
               
               // Import using ShipmentsRegistry
               if (window.shipmentsRegistry) {
                   const result = await window.shipmentsRegistry.importShipments(data, {
                       overwrite: false
                   });
                   
                   progressModal?.close();
                   
                   // Show results
                   showImportResults(result);
                   
                   // Refresh the table
                   window.registryCore?.render();
                   
               } else {
                   throw new Error('Shipments Registry not available');
               }
               
           } catch (error) {
               console.error('Import error:', error);
               window.NotificationSystem?.show('Errore', error.message, 'error');
           }
       };

       async function parseCSVFile(file) {
           return new Promise((resolve, reject) => {
               Papa.parse(file, {
                   header: true,
                   dynamicTyping: true,
                   skipEmptyLines: true,
                   complete: (results) => {
                       if (results.errors.length > 0) {
                           reject(new Error('Errore parsing CSV'));
                       } else {
                           resolve(results.data);
                       }
                   },
                   error: (error) => reject(error)
               });
           });
       }

       async function parseExcelFile(file) {
           return new Promise((resolve, reject) => {
               const reader = new FileReader();
               reader.onload = (e) => {
                   try {
                       const workbook = XLSX.read(e.target.result, { type: 'array' });
                       const sheetName = workbook.SheetNames[0];
                       const worksheet = workbook.Sheets[sheetName];
                       const data = XLSX.utils.sheet_to_json(worksheet);
                       resolve(data);
                   } catch (error) {
                       reject(error);
                   }
               };
               reader.onerror = reject;
               reader.readAsArrayBuffer(file);
           });
       }

       function showImportResults(result) {
           const { imported, errors } = result;
           
           let content = `
               <div class="import-results">
                   <div class="results-summary">
                       <div class="stat">
                           <i class="fas fa-check-circle" style="color: var(--sol-success);"></i>
                           <strong>${imported.length}</strong> spedizioni importate
                       </div>
           `;
           
           if (errors.length > 0) {
               content += `
                       <div class="stat">
                           <i class="fas fa-exclamation-circle" style="color: var(--sol-danger);"></i>
                           <strong>${errors.length}</strong> errori
                       </div>
                   </div>
                   <div class="errors-details" style="margin-top: 1rem;">
                       <h4>Dettagli Errori:</h4>
                       <ul style="max-height: 200px; overflow-y: auto;">
                           ${errors.slice(0, 10).map(err => 
                               `<li>${err.row['Shipment Number'] || 'N/A'}: ${err.error}</li>`
                           ).join('')}
                       </ul>
                       ${errors.length > 10 ? `<p>...e altri ${errors.length - 10} errori</p>` : ''}
                   </div>
               `;
           } else {
               content += '</div>';
           }
           
           content += '</div>';
           
           window.ModalSystem?.show({
               title: 'âœ… Import Completato',
               content,
               buttons: [{
                   text: 'OK',
                   class: 'sol-btn-primary',
                   onclick: () => window.ModalSystem.close()
               }]
           });
       }

       window.downloadShipmentTemplate = function() {
           const template = `Shipment Number,Type,Status,Carrier Code,Carrier Name,Service,Origin Port,Origin Name,Destination Port,Destination Name,Via,Transit Days,ETD,ETA,Ocean Freight,BAF,Port Charges,Customs,Insurance,Currency
MSKU1234567,container,planned,MAERSK,Maersk Line,AE7,CNSHA,Shanghai,ITGOA,Genova,"SGSIN,NLRTM",28,2024-02-15,2024-03-10,2850,425,180,120,95,EUR
MSCU7654321,container,in_transit,MSC,MSC,TIGER,CNNBO,Ningbo,ITLIV,Livorno,SGSIN,32,2024-02-10,2024-03-14,3200,380,200,150,110,EUR
176-12345678,awb,planned,CV,Cargolux,CV7321,HKG,Hong Kong,MXP,Milano Malpensa,,2,2024-02-20,2024-02-22,1200,0,50,80,40,EUR`;
           
           const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
           const link = document.createElement('a');
           link.href = URL.createObjectURL(blob);
           link.download = 'shipments_import_template.csv';
           link.click();
           URL.revokeObjectURL(link.href);
           
           window.ModalSystem?.close();
           window.NotificationSystem?.show('Download', 'Template scaricato', 'success');
       };

       // Products â†” Shipments Integration
       window.addEventListener('productsUpdated', async (e) => {
           console.log('ðŸ“¦ Products updated, checking shipment links...');
           
           if (!window.shipmentsRegistry) return;
           
           const products = e.detail.products;
           const shipments = window.shipmentsRegistry.shipments;
           
           // Check if any shipments need product data updates
           for (const shipment of shipments) {
               if (shipment.products && shipment.products.length > 0) {
                   let needsUpdate = false;
                   
                   shipment.products.forEach(shipmentProduct => {
                       const currentProduct = products.find(p => p.id === shipmentProduct.productId);
                       if (currentProduct) {
                           // Update product info if changed
                           if (shipmentProduct.productName !== currentProduct.name ||
                               shipmentProduct.weight !== currentProduct.specifications?.weight ||
                               shipmentProduct.volume !== currentProduct.specifications?.volume ||
                               shipmentProduct.value !== currentProduct.specifications?.value) {
                               
                               shipmentProduct.productName = currentProduct.name;
                               shipmentProduct.weight = currentProduct.specifications?.weight || 0;
                               shipmentProduct.volume = currentProduct.specifications?.volume || 0;
                               shipmentProduct.value = currentProduct.specifications?.value || 0;
                               needsUpdate = true;
                           }
                       }
                   });
                   
                   if (needsUpdate) {
                       await window.shipmentsRegistry.updateShipment(shipment.id, {
                           products: shipment.products
                       });
                   }
               }
           }
       });

       // Export functionality for selected shipments
       window.bulkExport = async function() {
           const selectedIds = Array.from(window.registryCore?.selectedRows || []);
           
           if (selectedIds.length === 0) {
               window.NotificationSystem?.show('Attenzione', 'Nessuna spedizione selezionata', 'warning');
               return;
           }
           
           const selectedShipments = window.shipmentsRegistry.shipments.filter(s => 
               selectedIds.includes(s.id)
           );
           
           // Create custom export data
           const exportData = selectedShipments.map(s => ({
               'Shipment Number': s.shipmentNumber,
               'Type': s.type,
               'Status': s.status,
               'Carrier': s.carrier?.name || '',
               'Service': s.carrier?.service || '',
               'Origin Port': s.route?.origin?.port || '',
               'Origin Name': s.route?.origin?.name || '',
               'Destination Port': s.route?.destination?.port || '',
               'Destination Name': s.route?.destination?.name || '',
               'Via': s.route?.via?.join(', ') || '',
               'Transit Days': s.route?.estimatedTransit || '',
               'ETD': s.schedule?.etd || '',
               'ETA': s.schedule?.eta || '',
               'Products': s.products?.map(p => `${p.sku} (${p.quantity})`).join('; ') || '',
               'Total Cost': s.costs?.total || 0,
               'Currency': s.costs?.currency || 'EUR',
               'Created': new Date(s.createdAt).toLocaleDateString('it-IT'),
               'Updated': new Date(s.updatedAt).toLocaleDateString('it-IT')
           }));
           
           // Convert to CSV
           const csv = Papa.unparse(exportData);
           
           // Download
           const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
           const link = document.createElement('a');
           link.href = URL.createObjectURL(blob);
           link.download = `shipments_export_${new Date().toISOString().split('T')[0]}.csv`;
           link.click();
           URL.revokeObjectURL(link.href);
           
           window.ModalSystem?.close();
           window.NotificationSystem?.show('Export', `${selectedIds.length} spedizioni esportate`, 'success');
       };

       window.exportRegistry = function() {
           try {
               const format = 'csv'; // Default format
               const data = window.shipmentsRegistry.exportShipments(format);
               
               const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
               const link = document.createElement('a');
               const url = URL.createObjectURL(blob);
               
               link.setAttribute('href', url);
               link.setAttribute('download', `registro_spedizioni_${new Date().toISOString().split('T')[0]}.csv`);
               link.style.visibility = 'hidden';
               
               document.body.appendChild(link);
               link.click();
               document.body.removeChild(link);
               
               window.NotificationSystem?.show('Export Completato', 'Registro esportato con successo', 'success');
           } catch (error) {
               console.error('Export error:', error);
               window.NotificationSystem?.show('Errore', 'Errore durante l\'export', 'error');
           }
       };

       window.showBulkActionsMenu = function() {
           const selectedCount = window.registryCore?.selectedRows.size || 0;
           
           if (selectedCount === 0) {
               window.NotificationSystem?.show('Attenzione', 'Seleziona almeno una spedizione', 'warning');
               return;
           }
           
           if (window.ModalSystem) {
               window.ModalSystem.show({
                   title: `Azioni Multiple (${selectedCount} spedizioni selezionate)`,
                   content: `
                       <div class="bulk-actions-list">
                           <button class="sol-btn sol-btn-block sol-btn-glass" onclick="bulkUpdateStatus()">
                               <i class="fas fa-edit"></i> Aggiorna Stato
                           </button>
                           <button class="sol-btn sol-btn-block sol-btn-glass" onclick="bulkAssignCarrier()">
                               <i class="fas fa-truck"></i> Assegna Vettore
                           </button>
                           <button class="sol-btn sol-btn-block sol-btn-glass" onclick="bulkLinkProducts()">
                               <i class="fas fa-link"></i> Collega Prodotti
                          </button>
                          <button class="sol-btn sol-btn-block sol-btn-glass" onclick="bulkExport()">
                              <i class="fas fa-download"></i> Esporta Selezionate
                          </button>
                          <button class="sol-btn sol-btn-block sol-btn-danger" onclick="bulkDelete()">
                              <i class="fas fa-trash"></i> Elimina Selezionate
                          </button>
                      </div>
                  `,
                  size: 'md'
              });
          }
      };

      window.toggleSelectAll = function(checked) {
          document.querySelectorAll('.shipment-checkbox').forEach(checkbox => {
              checkbox.checked = checked;
              const event = new Event('change', { bubbles: true });
              checkbox.dispatchEvent(event);
          });
      };

      // Placeholder functions for section data loading
      function loadProductsLinkData() {
          console.log('Loading products link data...');
          // Implementation for products linking UI
      }

      // Timeline Section Implementation
      function loadTimelineData() {
          console.log('Loading timeline data...');
          
          if (!window.shipmentsRegistry || window.shipmentsRegistry.shipments.length === 0) {
              console.log('No shipments for timeline');
              return;
          }
          
          // Get shipments sorted by most recent activity
          const shipments = [...window.shipmentsRegistry.shipments]
              .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
          
          // Render timeline
          renderShipmentTimeline(shipments);
          
          // Render recent events
          renderTimelineEvents(shipments);
      }

      function renderShipmentTimeline(shipments) {
          const container = document.getElementById('shipmentTimeline');
          if (!container) return;
          
          // Filter based on timeline filter
          const filter = document.getElementById('timelineFilter')?.value || 'all';
          let filteredShipments = shipments;
          
          if (filter === 'active') {
              filteredShipments = shipments.filter(s => 
                  ['planned', 'departed', 'in_transit'].includes(s.status)
              );
          } else if (filter === 'completed') {
              filteredShipments = shipments.filter(s => 
                  ['arrived', 'delivered'].includes(s.status)
              );
          }
          
          // Group by month
          const groupedByMonth = {};
          filteredShipments.forEach(shipment => {
              const month = new Date(shipment.createdAt).toLocaleDateString('it-IT', {
                  month: 'long',
                  year: 'numeric'
              });
              
              if (!groupedByMonth[month]) {
                  groupedByMonth[month] = [];
              }
              groupedByMonth[month].push(shipment);
          });
          
          // Render timeline
          container.innerHTML = Object.entries(groupedByMonth).map(([month, shipments]) => `
              <div class="timeline-month">
                  <h4 class="timeline-month-header">${month}</h4>
                  ${shipments.map(shipment => renderTimelineItem(shipment)).join('')}
              </div>
          `).join('');
      }

      function renderTimelineItem(shipment) {
          const icon = getStatusIcon(shipment.status);
          const color = getStatusColor(shipment.status);
          
          return `
              <div class="timeline-item">
                  <div class="timeline-marker" style="background: ${color};">
                      <i class="fas ${icon}"></i>
                  </div>
                  <div class="timeline-content">
                      <div class="timeline-header">
                          <h5>${shipment.shipmentNumber}</h5>
                          <span class="sol-badge status-${shipment.status}">${getStatusLabel(shipment.status)}</span>
                      </div>
                      <div class="timeline-details">
                          <p><strong>Route:</strong> ${shipment.route?.origin?.name || 'N/A'} â†’ ${shipment.route?.destination?.name || 'N/A'}</p>
                          <p><strong>Carrier:</strong> ${shipment.carrier?.name || 'N/A'}</p>
                          <p><strong>ETD:</strong> ${formatDate(shipment.schedule?.etd)} | <strong>ETA:</strong> ${formatDate(shipment.schedule?.eta)}</p>
                      </div>
                      <div class="timeline-actions">
                          <button class="sol-btn sol-btn-sm sol-btn-glass" onclick="viewShipmentDetails('${shipment.id}')">
                              <i class="fas fa-eye"></i> Dettagli
                          </button>
                      </div>
                  </div>
                  <div class="timeline-line"></div>
              </div>
          `;
      }

      function renderTimelineEvents(shipments) {
          const container = document.getElementById('timelineEvents');
          if (!container) return;
          
          // Generate recent events from shipments
          const events = generateRecentEvents(shipments);
          
          container.innerHTML = events.map(event => `
              <div class="timeline-event">
                  <div class="timeline-event-icon" style="background: ${event.color};">
                      <i class="fas ${event.icon}"></i>
                  </div>
                  <div class="timeline-event-content">
                      <strong>${event.title}</strong>
                      <p>${event.description}</p>
                      <span class="timeline-event-time">${formatRelativeTime(event.timestamp)}</span>
                  </div>
              </div>
          `).join('');
      }

      function generateRecentEvents(shipments) {
          const events = [];
          
          // Recent departures
          shipments.filter(s => s.status === 'departed').slice(0, 3).forEach(s => {
              events.push({
                  title: 'Spedizione Partita',
                  description: `${s.shipmentNumber} partita da ${s.route?.origin?.name || 'N/A'}`,
                  icon: 'fa-ship',
                  color: 'var(--sol-info)',
                  timestamp: s.schedule?.atd || s.updatedAt
              });
          });
          
          // Recent arrivals
          shipments.filter(s => s.status === 'arrived').slice(0, 3).forEach(s => {
              events.push({
                  title: 'Spedizione Arrivata',
                  description: `${s.shipmentNumber} arrivata a ${s.route?.destination?.name || 'N/A'}`,
                  icon: 'fa-check-circle',
                  color: 'var(--sol-success)',
                  timestamp: s.schedule?.ata || s.updatedAt
              });
          });
          
          // Sort by timestamp
          return events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 10);
      }

      function getStatusIcon(status) {
          const icons = {
              planned: 'fa-calendar-check',
              departed: 'fa-ship',
              in_transit: 'fa-route',
              arrived: 'fa-map-marker-alt',
              delivered: 'fa-check-circle'
          };
          return icons[status] || 'fa-box';
      }

      function getStatusColor(status) {
          const colors = {
              planned: 'var(--sol-gray-400)',
              departed: 'var(--sol-info)',
              in_transit: 'var(--sol-warning)',
              arrived: 'var(--sol-success-light)',
              delivered: 'var(--sol-success)'
          };
          return colors[status] || 'var(--sol-gray-400)';
      }

      function formatRelativeTime(timestamp) {
          const now = new Date();
          const then = new Date(timestamp);
          const diff = now - then;
          
          const minutes = Math.floor(diff / 60000);
          const hours = Math.floor(minutes / 60);
          const days = Math.floor(hours / 24);
          
          if (days > 0) return `${days} giorni fa`;
          if (hours > 0) return `${hours} ore fa`;
          if (minutes > 0) return `${minutes} minuti fa`;
          return 'Adesso';
      }

      function openCostAllocationModal() {
          if (window.costAllocation) {
              window.costAllocation.openModal();
          }
      }

      // Global functions for onclick handlers
      window.viewShipmentDetails = function(id) {
          console.log('View shipment details:', id);
          if (window.shipmentDetails) {
              window.shipmentDetails.show(id);
          }
      };

      window.editShipment = function(id) {
          console.log('Edit shipment:', id);
          if (window.shipmentDetails) {
              window.shipmentDetails.edit(id);
          }
      };

      // Timeline filter handler
      document.getElementById('timelineFilter')?.addEventListener('change', () => {
          loadTimelineData();
      });

      // Bulk action placeholder functions
      window.bulkUpdateStatus = function() {
          window.NotificationSystem?.show('Coming Soon', 'Aggiornamento stato in massa in sviluppo', 'info');
          window.ModalSystem?.close();
      };

      window.bulkAssignCarrier = function() {
          window.NotificationSystem?.show('Coming Soon', 'Assegnazione vettore in massa in sviluppo', 'info');
          window.ModalSystem?.close();
      };

      window.bulkLinkProducts = function() {
          window.NotificationSystem?.show('Coming Soon', 'Collegamento prodotti in massa in sviluppo', 'info');
          window.ModalSystem?.close();
      };

      window.bulkDelete = function() {
          if (confirm('Sei sicuro di voler eliminare le spedizioni selezionate?')) {
              window.NotificationSystem?.show('Coming Soon', 'Eliminazione in massa in sviluppo', 'info');
          }
          window.ModalSystem?.close();
      };

      console.log('ðŸ“¦ Shipments page script loaded - FIXED carrier performance initialization');
      console.log('ðŸ“¦ Shipments Import Integration loaded');
      console.log('ðŸ• Timeline Section implemented');
      console.log('ðŸ“„ Documents Integration ready');
      console.log('ðŸ“Š Column Manager implemented');
  </script>

   <script src="shipments-initialization-fix.js"></script>
  <script src="/pages/shipments/registry-core.js"></script>
  <script src="/pages/shipments/shipments-details.js"></script>
  <script src="/pages/shipments/cost-allocation.js"></script>
  <script src="/pages/shipments/carrier-performance.js"></script>
  <script src="/pages/shipments/documents-manager.js"></script>
  
  <script>
  // ==== SISTEMA MODAL CORRETTO - INIZIALIZZAZIONE ====
  // Aggiungi dopo tutti gli altri script esistenti

  // 1. CLASSE FIXED MODAL SYSTEM
  class FixedModalSystem {
      constructor() {
          this.activeModals = new Map();
          this.zIndexCounter = 2000;
          this.setupGlobalStyles();
      }

      setupGlobalStyles() {
          if (!document.getElementById('fixed-modal-styles')) {
              const style = document.createElement('style');
              style.id = 'fixed-modal-styles';
              style.textContent = `
                  .sol-modal-overlay {
                      position: fixed;
                      top: 0;
                      left: 0;
                      right: 0;
                      bottom: 0;
                      background: rgba(0, 0, 0, 0.7);
                      backdrop-filter: blur(8px);
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      z-index: 2000;
                      padding: 20px;
                      opacity: 0;
                      visibility: hidden;
                      transition: all 0.3s ease;
                  }

                  .sol-modal-overlay.active {
                      opacity: 1;
                      visibility: visible;
                  }

                  .sol-modal-content {
                      background: white;
                      border-radius: 12px;
                      width: 100%;
                      max-width: 600px;
                      max-height: 90vh;
                      overflow: hidden;
                      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                      transform: scale(0.9) translateY(20px);
                      transition: transform 0.3s ease;
                      position: relative;
                  }

                  .sol-modal-overlay.active .sol-modal-content {
                      transform: scale(1) translateY(0);
                  }

                  .sol-modal-header {
                      padding: 24px 24px 20px;
                      border-bottom: 1px solid #e5e5e7;
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      background: #f8f9fa;
                  }

                  .sol-modal-title {
                      font-size: 18px;
                      font-weight: 600;
                      margin: 0;
                      color: #1d1d1f;
                  }

                  .sol-modal-close {
                      background: none;
                      border: none;
                      color: #6e6e73;
                      font-size: 20px;
                      cursor: pointer;
                      padding: 8px;
                      border-radius: 6px;
                      transition: all 0.2s ease;
                      width: 36px;
                      height: 36px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                  }

                  .sol-modal-close:hover {
                      background: #e5e5e7;
                      color: #1d1d1f;
                  }

                  .sol-modal-body {
                      padding: 24px;
                      overflow-y: auto;
                      max-height: calc(90vh - 160px);
                  }

                  .sol-modal-footer {
                      padding: 20px 24px 24px;
                      border-top: 1px solid #e5e5e7;
                      display: flex;
                      gap: 12px;
                      justify-content: flex-end;
                      background: #f8f9fa;
                  }

                  /* Dashboard customizer styles */
                  .modules-selector {
                      display: flex;
                      flex-direction: column;
                      gap: 12px;
                      margin-bottom: 24px;
                  }

                  .module-option {
                      border: 2px solid #e5e5e7;
                      border-radius: 12px;
                      transition: all 0.2s ease;
                      overflow: hidden;
                      background: white;
                  }

                  .module-option:hover {
                      border-color: #007AFF;
                      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
                  }

                  .sol-checkbox-label {
                      display: flex;
                      align-items: flex-start;
                      gap: 16px;
                      padding: 20px;
                      margin: 0;
                      cursor: pointer;
                      transition: background 0.2s ease;
                  }

                  .sol-checkbox-label:hover {
                      background: #f8f9fa;
                  }

                  .sol-checkbox-custom {
                      width: 20px;
                      height: 20px;
                      border: 2px solid #c7c7cc;
                      border-radius: 4px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      transition: all 0.2s ease;
                      flex-shrink: 0;
                      margin-top: 2px;
                      background: white;
                  }

                  .sol-checkbox:checked + .sol-checkbox-custom {
                      background: #007AFF;
                      border-color: #007AFF;
                  }

                  .sol-checkbox:checked + .sol-checkbox-custom::after {
                      content: 'âœ“';
                      color: white;
                      font-size: 12px;
                      font-weight: bold;
                  }

                  .module-info strong {
                      display: block;
                      color: #1d1d1f;
                      font-size: 16px;
                      font-weight: 600;
                      margin-bottom: 4px;
                  }

                  .module-info p {
                      margin: 0;
                      color: #6e6e73;
                      font-size: 14px;
                      line-height: 1.4;
                  }

                  /* Format options styles */
                  .format-options {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                      gap: 16px;
                  }

                  .format-card {
                      background: white;
                      border: 2px solid #e5e5e7;
                      border-radius: 12px;
                      padding: 20px;
                      text-align: center;
                      transition: all 0.2s ease;
                      cursor: pointer;
                  }

                  .format-option input[type="radio"]:checked + .format-card {
                      border-color: #007AFF;
                      background: #f0f8ff;
                  }

                  .format-card:hover {
                      border-color: #007AFF;
                      transform: translateY(-2px);
                      box-shadow: 0 8px 24px rgba(0, 122, 255, 0.15);
                  }

                  .format-card i {
                      font-size: 32px;
                      color: #007AFF;
                      margin-bottom: 12px;
                  }

                  /* Form styles */
                  .sol-form-input, .sol-form-select, .sol-textarea {
                      width: 100%;
                      padding: 12px 16px;
                      border: 2px solid #e5e5e7;
                      border-radius: 8px;
                      font-size: 16px;
                      transition: border-color 0.2s ease;
                      background: white;
                      color: #1d1d1f;
                  }

                  .sol-form-input:focus, .sol-form-select:focus, .sol-textarea:focus {
                      outline: none;
                      border-color: #007AFF;
                      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
                  }

                  /* Button styles */
                  .sol-btn {
                      padding: 12px 24px;
                      border-radius: 8px;
                      font-size: 16px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.2s ease;
                      border: none;
                      display: inline-flex;
                      align-items: center;
                      gap: 8px;
                  }

                  .sol-btn-primary {
                      background: #007AFF;
                      color: white;
                  }

                  .sol-btn-primary:hover {
                      background: #0056CC;
                      transform: translateY(-1px);
                  }

                  .sol-btn-glass {
                      background: transparent;
                      color: #007AFF;
                      border: 2px solid #007AFF;
                  }

                  .sol-btn-glass:hover {
                      background: #007AFF;
                      color: white;
                  }

                  /* Commercial workflow styles */
                  .workflow-steps {
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      margin: 24px 0;
                      flex-wrap: wrap;
                      gap: 16px;
                  }

                  .workflow-step {
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                      gap: 8px;
                      flex: 1;
                      text-align: center;
                      min-width: 120px;
                  }

                  .step-icon {
                      width: 48px;
                      height: 48px;
                      border-radius: 50%;
                      background: #e5e5e7;
                      color: #6e6e73;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 20px;
                  }

                  .workflow-step.completed .step-icon {
                      background: #34C759;
                      color: white;
                  }

                  /* Responsive */
                  @media (max-width: 768px) {
                      .sol-modal-overlay {
                          padding: 16px;
                      }
                      
                      .format-options {
                          grid-template-columns: 1fr;
                      }
                      
                      .workflow-steps {
                          flex-direction: column;
                      }
                  }
              `;
              document.head.appendChild(style);
          }
      }

      show(options = {}) {
          if (typeof options === 'string') {
              options = { content: options };
          }

          const modalId = `modal-${Date.now()}`;
          const config = {
              title: '',
              content: '',
              maxWidth: '600px',
              closable: true,
              hideClose: false,
              closeOnBackdrop: true,
              closeOnEsc: true,
              size: 'md',
              buttons: [],
              ...options
          };

          let maxWidth = config.maxWidth;
          if (config.size === 'sm') maxWidth = '400px';
          if (config.size === 'md') maxWidth = '600px';
          if (config.size === 'lg') maxWidth = '800px';
          if (config.size === 'xl') maxWidth = '1000px';
          if (config.size === 'fullscreen') maxWidth = '95vw';

          let footer = '';
          if (config.buttons && config.buttons.length > 0) {
              footer = config.buttons.map(btn => `
                  <button class="sol-btn ${btn.class || 'sol-btn-primary'}" 
                          data-modal-action="button-${btn.text}">
                      ${btn.text}
                  </button>
              `).join('');
          }

          const modal = document.createElement('div');
          modal.className = 'sol-modal-overlay';
          modal.id = modalId;
          modal.style.zIndex = this.zIndexCounter++;
          modal.innerHTML = `
              <div class="sol-modal-content" style="max-width: ${maxWidth}">
                  ${config.title || !config.hideClose ? `
                      <div class="sol-modal-header">
                          <h2 class="sol-modal-title">${config.title || ''}</h2>
                          ${!config.hideClose ? `
                              <button class="sol-modal-close" data-close-modal="${modalId}">
                                  <i class="fas fa-times"></i>
                              </button>
                          ` : ''}
                      </div>
                  ` : ''}
                  <div class="sol-modal-body">
                      ${config.content || ''}
                  </div>
                  ${footer ? `
                      <div class="sol-modal-footer">
                          ${footer}
                      </div>
                  ` : ''}
              </div>
          `;

          document.body.appendChild(modal);
          this.activeModals.set(modalId, { element: modal, config: config });
          this.setupModalEvents(modalId, config);

          requestAnimationFrame(() => {
              modal.classList.add('active');
          });

          return { id: modalId, element: modal };
      }

      close(modalId) {
          if (!modalId && this.activeModals.size > 0) {
              modalId = Array.from(this.activeModals.keys()).pop();
          }

          const modalData = this.activeModals.get(modalId);
          if (!modalData) return;

          const { element } = modalData;
          element.classList.remove('active');
          setTimeout(() => {
              if (element.parentNode) {
                  element.remove();
              }
              this.activeModals.delete(modalId);
          }, 300);
      }

      setupModalEvents(modalId, config) {
          const modalData = this.activeModals.get(modalId);
          if (!modalData) return;

          const { element } = modalData;

          element.addEventListener('click', (e) => {
              if (e.target.closest('[data-close-modal]')) {
                  this.close(modalId);
              }

              // Handle button clicks
              const buttonAction = e.target.getAttribute('data-modal-action');
              if (buttonAction && config.buttons) {
                  const buttonIndex = Array.from(element.querySelectorAll('[data-modal-action]')).indexOf(e.target);
                  const button = config.buttons[buttonIndex];
                  if (button && button.onclick) {
                      const result = button.onclick();
                      if (result !== false) {
                          this.close(modalId);
                      }
                  }
              }
          });

          if (config.closeOnBackdrop) {
              element.addEventListener('click', (e) => {
                  if (e.target === element) {
                      this.close(modalId);
                  }
              });
          }
      }
  }

  // 2. INIZIALIZZAZIONE SISTEMA CORRETTO
  document.addEventListener('DOMContentLoaded', () => {
      console.log('ðŸ”§ Applicazione correzioni sistema modal...');
      
      // Sostituisci il sistema modal globale
      window.ModalSystem = new FixedModalSystem();
      
      console.log('âœ… Correzioni sistema modal applicate con successo');
  });
  </script>
  
  <script>
   // ===== ENHANCED INITIALIZATION OVERRIDE =====
   // This replaces the existing DOMContentLoaded handler in shipments.html
   
   (function() {
       console.log('ðŸ”§ Applying shipments initialization fixes...');
       
       // Wait for dependency resolution system
       let initAttempts = 0;
       const maxAttempts = 50; // 5 seconds maximum wait
       
       const waitForDependencyManager = () => {
           initAttempts++;
           
           if (window.shipmentsInitManager) {
               console.log('âœ… Dependency manager found, proceeding with enhanced initialization');
               startEnhancedInitialization();
           } else if (initAttempts < maxAttempts) {
               setTimeout(waitForDependencyManager, 100);
           } else {
               console.warn('âš ï¸ Dependency manager not found, falling back to standard initialization');
               startFallbackInitialization();
           }
       };
       
       async function startEnhancedInitialization() {
           try {
               console.log('ðŸš€ Starting enhanced shipments initialization...');
               
               // Initialize header first
               if (window.headerComponent) {
                   await window.headerComponent.init();
                   console.log('âœ… Header component initialized');
               }
               
               // Initialize Phase 2 Architecture
               if (window.Phase2Architecture) {
                   window.productIntelligence = window.Phase2Architecture.initialize();
                   console.log('âœ… Product Intelligence connected');
               }
               
               // Wait for dependency manager to complete
               const success = await window.reinitializeShipments();
               
               if (success) {
                   console.log('âœ… Enhanced initialization completed successfully');
                   
                   // Initialize tabs and UI components
                   initializeTabs();
                   initializeFilters();
                   setupEventListeners();
                   
                   // Load initial data
                   await loadShipmentsData();
                   
                   // Setup import/export handlers
                   setupImportExportHandlers();
                   
                   // Setup documents integration
                   setupDocumentsIntegration();
                   
                   // Add sample data if needed
                   await ensureSampleData();
                   
                   // Show success notification
                   if (window.NotificationSystem) {
                       window.NotificationSystem.show(
                           'System Ready', 
                           'Enhanced Shipments Registry V15.0 initialized successfully', 
                           'success',
                           3000
                       );
                   }
                   
               } else {
                   throw new Error('Enhanced initialization failed');
               }
               
           } catch (error) {
               console.error('âŒ Enhanced initialization failed:', error);
               startFallbackInitialization();
           }
       }
       
       async function startFallbackInitialization() {
           console.log('ðŸ”„ Starting fallback initialization...');
           
           try {
               // Basic initialization without dependency management
               if (window.headerComponent) {
                   await window.headerComponent.init();
               }
               
               // Create basic registry if needed
               if (!window.shipmentsRegistry) {
                   if (window.ShipmentsRegistry) {
                       window.shipmentsRegistry = new window.ShipmentsRegistry();
                       await window.shipmentsRegistry.init();
                   } else {
                       // Create minimal stub
                       window.shipmentsRegistry = {
                           shipments: [],
                           initialized: false,
                           async init() { this.initialized = true; return true; },
                           getStatistics() { 
                               return { total: 0, byStatus: {}, totalCost: 0, avgTransitTime: 0 }; 
                           }
                       };
                       await window.shipmentsRegistry.init();
                   }
               }
               
               // Initialize basic UI
               initializeTabs();
               initializeFilters();
               setupEventListeners();
               
               // Load data
               await loadShipmentsData();
               
               console.log('âœ… Fallback initialization completed');
               
               if (window.NotificationSystem) {
                   window.NotificationSystem.show(
                       'System Ready', 
                       'Shipments system initialized (fallback mode)', 
                       'info',
                       3000
                   );
               }
               
           } catch (error) {
               console.error('âŒ Fallback initialization also failed:', error);
               
               if (window.NotificationSystem) {
                   window.NotificationSystem.show(
                       'Initialization Error', 
                       'Failed to initialize shipments system. Please refresh the page.', 
                       'error',
                       10000
                   );
               }
           }
       }
       
       function setupImportExportHandlers() {
           // Import button
           const importBtn = document.getElementById('importShipmentsBtn');
           if (importBtn) {
               importBtn.onclick = openImportModal;
           }
           
           // Export button
           const exportBtn = document.getElementById('exportRegistryBtn');
           if (exportBtn) {
               exportBtn.onclick = exportRegistry;
           }
           
           // Commercial forms button
           const commercialBtn = document.getElementById('openCommercialFormsBtn');
           if (commercialBtn) {
               commercialBtn.onclick = () => {
                   if (window.shipmentsPageV14) {
                       window.shipmentsPageV14.openCommercialDataModal('single');
                   } else {
                       console.warn('âš ï¸ Commercial forms not available yet');
                   }
               };
           }
       }
       
       // Enhanced error handling for loadShipmentsData
       async function loadShipmentsData() {
           try {
               console.log('ðŸ“Š Loading shipments data...');
               
               if (!window.shipmentsRegistry) {
                   console.warn('âš ï¸ ShipmentsRegistry not available');
                   return;
               }
               
               const shipments = window.shipmentsRegistry.shipments || [];
               
               // Update KPIs
               updateKPIs(shipments);
               
               // Render table if registry core is available
               if (window.registryCore) {
                   window.registryCore.render();
               } else {
                   console.log('âš ï¸ Registry core not available, using fallback table rendering');
                   renderShipmentsTable(shipments);
               }
               
               // Update count
               const registryCount = document.getElementById('registryCount');
               if (registryCount) {
                   registryCount.textContent = shipments.length;
               }
               
               console.log(`âœ… Loaded ${shipments.length} shipments`);
               
           } catch (error) {
               console.error('âŒ Error loading shipments data:', error);
               
               if (window.NotificationSystem) {
                   window.NotificationSystem.show(
                       'Data Loading Error', 
                       'Failed to load shipments data', 
                       'error'
                   );
               }
           }
       }
       
       // Enhanced event listener setup
       function setupEventListeners() {
           try {
               // Add shipment
               const addBtn = document.getElementById('addShipmentBtn');
               if (addBtn) {
                   addBtn.addEventListener('click', () => {
                       if (window.shipmentDetails) {
                           window.shipmentDetails.create();
                       } else {
                           console.warn('âš ï¸ Shipment details not available');
                       }
                   });
               }
               
               // Bulk actions
               const bulkBtn = document.getElementById('bulkActionsBtn');
               if (bulkBtn) {
                   bulkBtn.addEventListener('click', () => {
                       showBulkActionsMenu();
                   });
               }
               
               // Cost allocation
               const costBtn = document.getElementById('costAllocationBtn');
               if (costBtn) {
                   costBtn.addEventListener('click', () => {
                       if (window.costAllocation) {
                           window.costAllocation.openModal();
                       } else {
                           console.warn('âš ï¸ Cost allocation not available');
                       }
                   });
               }
               
               // Select all checkbox
               const selectAllBtn = document.getElementById('selectAllShipments');
               if (selectAllBtn) {
                   selectAllBtn.addEventListener('change', (e) => {
                       toggleSelectAll(e.target.checked);
                   });
               }
               
               // Refresh data
               const refreshBtn = document.getElementById('refreshDataBtn');
               if (refreshBtn) {
                   refreshBtn.addEventListener('click', () => {
                       loadShipmentsData();
                   });
               }
               
               console.log('âœ… Event listeners setup completed');
               
           } catch (error) {
               console.error('âŒ Error setting up event listeners:', error);
           }
       }
       
       // Enhanced documents integration setup
       function setupDocumentsIntegration() {
           // Listen for documents updates to refresh table
           window.addEventListener('documentsUpdated', (e) => {
               const { action, document: doc } = e.detail;
               
               if (action === 'upload' || action === 'delete') {
                   // Update the documents count in the table
                   updateDocumentsCountInTable(doc.shipmentId);
                   
                   // Update any open shipment details modal
                   if (window.shipmentDetails && window.shipmentDetails.currentShipment?.id === doc.shipmentId) {
                       if (window.shipmentDetails.updateDocumentsCount) {
                           window.shipmentDetails.updateDocumentsCount();
                       }
                       if (window.shipmentDetails.activeTab === 'documents') {
                           if (window.shipmentDetails.refreshDocumentsTab) {
                               window.shipmentDetails.refreshDocumentsTab();
                           }
                       }
                   }
               }
           });
           
           console.log('âœ… Documents integration setup completed');
       }
       
       // Update documents count in table
       function updateDocumentsCountInTable(shipmentId) {
           if (!window.documentsManager) return;
           
           const row = document.querySelector(`tr[data-shipment-id="${shipmentId}"]`);
           if (!row) return;
           
           const documentsCell = row.querySelector('.documents-cell');
           const docCountSpan = row.querySelector('.doc-count');
           const documentsBtn = row.querySelector('.documents-btn');
           
           if (documentsCell && docCountSpan && documentsBtn) {
               const count = window.documentsManager.getShipmentDocuments(shipmentId).length;
               
               // Update count display
               docCountSpan.textContent = count;
               
               if (count > 0) {
                   docCountSpan.style.display = 'inline';
                   documentsBtn.classList.remove('empty');
                   documentsBtn.onclick = () => window.documentsManager.showDocumentsList(shipmentId);
                   documentsBtn.title = `${count} documenti caricati`;
                   
                   const icon = documentsBtn.querySelector('i');
                   if (icon) icon.className = 'fas fa-folder';
               } else {
                   docCountSpan.style.display = 'none';
                   documentsBtn.classList.add('empty');
                   documentsBtn.onclick = () => window.documentsManager.showUploadModal(shipmentId);
                   documentsBtn.title = 'Carica documenti';
                   
                   const icon = documentsBtn.querySelector('i');
                   if (icon) icon.className = 'fas fa-folder-plus';
               }
           }
       }
       
       // Start initialization based on document state
       if (document.readyState === 'loading') {
           document.addEventListener('DOMContentLoaded', () => {
               setTimeout(waitForDependencyManager, 100);
           });
       } else {
           setTimeout(waitForDependencyManager, 100);
       }
       
       // Add debug helper
       window.debugShipmentsSystem = function() {
           console.log('ðŸ” Shipments System Debug:');
           console.log('- Dependency Manager:', !!window.shipmentsInitManager);
           console.log('- ShipmentsRegistry:', !!window.shipmentsRegistry, window.shipmentsRegistry?.initialized);
           console.log('- DocumentsManager:', !!window.documentsManager);
           console.log('- RegistryCore:', !!window.registryCore);
           console.log('- ShipmentDetails:', !!window.shipmentDetails);
           console.log('- CostAllocation:', !!window.costAllocation);
           console.log('- CarrierPerformance:', !!window.carrierPerformance);
           console.log('- ExecutiveBI:', !!window.executiveBIDashboard);
           console.log('- Shipments Count:', window.shipmentsRegistry?.shipments?.length || 0);
           console.log('- Column Manager:', !!window.columnManager);
       };
       
       console.log('ðŸ”§ Initialization override script loaded');
       console.log('ðŸ’¡ Use window.debugShipmentsSystem() for debugging');
       
   })();
   </script>
<script>
// Enhanced Auto-Link functionality with progress tracking
document.addEventListener('DOMContentLoaded', function() {
    // Initialize enhanced auto-link functionality
    initializeEnhancedAutoLink();
    // Setup filter listeners
    setupLinkedProductsFilters();
    // Setup refresh functionality
    setupRefreshFunctionality();
});
function initializeEnhancedAutoLink() {
    const autoLinkBtn = document.getElementById('autoLinkBtn');
    if (!autoLinkBtn) return;
    // Enhanced auto-link with progress
    window.performAutoLinkEnhanced = async function() {
        const progressContainer = document.getElementById('autoLinkProgress');
        const progressBar = progressContainer?.querySelector('.sol-progress-fill');
        const button = document.getElementById('autoLinkBtn');
        try {
            // Show progress
            if (progressContainer) {
                progressContainer.style.display = 'block';
                document.body.classList.add('auto-linking');
            }
            // Disable button
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Auto-Linking...';
            }
            // Simulate progress steps
            const steps = [
                { progress: 20, message: 'Analisi spedizioni...' },
                { progress: 40, message: 'Caricamento prodotti...' },
                { progress: 60, message: 'Creazione collegamenti...' },
                { progress: 80, message: 'Salvataggio modifiche...' },
                { progress: 100, message: 'Completato!' }
            ];
            for (const step of steps) {
                if (progressBar) {
                    progressBar.style.width = `${step.progress}%`;
                }
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            // Call the actual auto-link function
            if (window.productLinkingV20Final) {
                await window.productLinkingV20Final.performAutoLink();
            } else if (window.performAutoLink) {
                await window.performAutoLink();
            }
            // Update stats
            updateProductsLinkStats();
            // Success state
            if (button) {
                button.innerHTML = '<i class="fas fa-check"></i> Completato!';
                button.classList.add('success-state');
            }
            setTimeout(() => {
                // Reset button
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-magic"></i> Auto-Link';
                    button.classList.remove('success-state');
                }
                // Hide progress
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                    document.body.classList.remove('auto-linking');
                }
            }, 2000);
        } catch (error) {
            console.error('Error in enhanced auto-link:', error);
            // Error state
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Errore';
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-magic"></i> Auto-Link';
                }, 3000);
            }
            if (progressContainer) {
                progressContainer.style.display = 'none';
                document.body.classList.remove('auto-linking');
            }
        }
    };
    // Replace the onclick with enhanced version
    autoLinkBtn.onclick = window.performAutoLinkEnhanced;
}
function updateProductsLinkStats() {
    if (!window.shipmentsRegistry?.shipments) return;
    const shipments = window.shipmentsRegistry.shipments;
    const unlinkedShipments = shipments.filter(s => !s.products || s.products.length === 0);
    const linkedShipments = shipments.filter(s => s.products && s.products.length > 0);
    // Get products count
    let productsCount = 0;
    if (window.productLinkingV20Final?.productsData) {
        productsCount = window.productLinkingV20Final.productsData.length;
    } else if (window.productSync?.getProducts) {
        productsCount = window.productSync.getProducts().length;
    }
    const linkingPercentage = shipments.length > 0 ? 
        Math.round((linkedShipments.length / shipments.length) * 100) : 0;
    // Update stats displays
    const elements = {
        unlinkedShipmentsCount: unlinkedShipments.length,
        availableProductsCount: productsCount,
        linkedShipmentsCount: linkedShipments.length,
        linkingPercentage: `${linkingPercentage}%`,
        unlinkedBadge: unlinkedShipments.length,
        productsBadge: productsCount
    };
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
            // Add visual feedback for changes
            element.classList.add('success-state');
            setTimeout(() => {
                element.classList.remove('success-state');
            }, 600);
        }
    });
}
function setupLinkedProductsFilters() {
    const filterSelect = document.getElementById('linkedProductsFilter');
    const searchInput = document.getElementById('linkedProductsSearch');
    const resetBtn = document.getElementById('resetLinkedFiltersBtn');
    if (filterSelect) {
        filterSelect.addEventListener('change', applyLinkedProductsFilters);
    }
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyLinkedProductsFilters, 300);
        });
    }
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            if (filterSelect) filterSelect.value = 'all';
            if (searchInput) searchInput.value = '';
            applyLinkedProductsFilters();
        });
    }
}
function applyLinkedProductsFilters() {
    // This would filter the displayed linked products
    // Implementation would depend on the actual grid rendering logic
    if (window.productLinkingV20Final?.populateLinkedProductsGrid) {
        window.productLinkingV20Final.populateLinkedProductsGrid();
    }
}
function setupRefreshFunctionality() {
    const refreshBtn = document.getElementById('refreshProductsMenuBtn');
    const exportBtn = document.getElementById('exportLinksBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            // Show loading state
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aggiornamento...';
            refreshBtn.disabled = true;
            // Refresh the products menu
            if (window.productLinkingV20Final?.populateProductsMenu) {
                window.productLinkingV20Final.populateProductsMenu();
            }
            // Update stats
            updateProductsLinkStats();
            // Reset button
            setTimeout(() => {
                refreshBtn.innerHTML = '<i class="fas fa-sync"></i> Aggiorna';
                refreshBtn.disabled = false;
            }, 1000);
        });
    }
    if (exportBtn) {
        exportBtn.addEventListener('click', exportProductLinks);
    }
}
function exportProductLinks() {
    if (!window.shipmentsRegistry?.shipments) {
        alert('Nessun dato disponibile per l\'export');
        return;
    }
    const shipments = window.shipmentsRegistry.shipments;
    const exportData = [];
    shipments.forEach(shipment => {
        if (shipment.products && shipment.products.length > 0) {
            shipment.products.forEach(product => {
                exportData.push({
                    'Shipment Number': shipment.shipmentNumber,
                    'Shipment ID': shipment.id,
                    'Product ID': product.productId,
                    'Product SKU': product.sku,
                    'Product Name': product.productName,
                    'Quantity': product.quantity,
                    'Weight (kg)': product.weight || 0,
                    'Volume (mÂ³)': product.volume || 0,
                    'Value (â‚¬)': product.value || 0,
                    'Link Date': new Date().toLocaleDateString('it-IT')
                });
            });
        }
    });
    if (exportData.length === 0) {
        alert('Nessun collegamento prodotto-spedizione da esportare');
        return;
    }
    // Convert to CSV
    const headers = Object.keys(exportData[0]);
    const csvContent = [
        headers.join(','),
        ...exportData.map(row => 
            headers.map(header => `"${row[header] || ''}"`).join(',')
        )
    ].join('\n');
    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `product_links_export_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
    // Show success
    if (window.NotificationSystem) {
        window.NotificationSystem.show('Export', `${exportData.length} collegamenti esportati`, 'success');
    }
}
// Auto-update stats when page loads
setTimeout(() => {
    updateProductsLinkStats();
}, 1000);
// Listen for shipments updates to refresh stats
window.addEventListener('shipmentsUpdated', () => {
    setTimeout(updateProductsLinkStats, 100);
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const panel = document.getElementById('productLinkPanel');
    const openBtn = document.getElementById('linkProductsBtn');
    const closeBtn = document.getElementById('closeProductLinkPanel');
    const shipmentSelect = document.getElementById('plShipmentSelect');
    const productsList = document.getElementById('plProductsList');
    const confirmBtn = document.getElementById('confirmProductLink');

    function populatePanel() {
        shipmentSelect.innerHTML = '';
        const shipments = window.shipmentsRegistry?.shipments || [];
        const unlinked = shipments.filter(s => !s.products || s.products.length === 0);
        shipmentSelect.innerHTML = unlinked.map(s => `<option value="${s.id}">${s.shipmentNumber}</option>`).join('');

        productsList.innerHTML = '';
        const orgId = window.organizationService?.getCurrentOrgId();
        let products = [];
        if (window.productLinkingV20Final?.productsData) {
            products = window.productLinkingV20Final.productsData;
        } else if (window.productSync?.getProducts) {
            products = window.productSync.getProducts();
        }
        products = products.filter(p => !orgId || p.organization_id === orgId);

        products.forEach(prod => {
            const row = document.createElement('label');
            row.className = 'pl-product-row';
            row.style.display = 'flex';
            row.style.alignItems = 'center';
            row.style.marginBottom = '0.5rem';
            row.innerHTML = `
                <input type="checkbox" value="${prod.id}" class="pl-product-checkbox" title="Seleziona prodotto" style="margin-right:8px;">
                <span style="flex:1;" title="${prod.name}">${prod.name} <small class="font-mono">${prod.sku}</small></span>
                <input type="number" value="1" min="1" class="pl-product-qty" data-prod-id="${prod.id}" style="width:60px;margin-left:8px;">
            `;
            productsList.appendChild(row);
        });
    }

    function openPanel() {
        populatePanel();
        panel.classList.add('open');
        panel.setAttribute('aria-hidden', 'false');
    }

    function closePanel() {
        panel.classList.remove('open');
        panel.setAttribute('aria-hidden', 'true');
    }

    openBtn?.addEventListener('click', openPanel);
    closeBtn?.addEventListener('click', closePanel);

    confirmBtn?.addEventListener('click', () => {
        const shipmentId = shipmentSelect.value;
        if (!shipmentId) {
            window.NotificationSystem?.show('Attenzione', 'Seleziona una spedizione', 'warning');
            return;
        }
        const selections = [];
        panel.querySelectorAll('.pl-product-checkbox:checked').forEach(cb => {
            const qtyInput = panel.querySelector(`.pl-product-qty[data-prod-id="${cb.value}"]`);
            const qty = parseInt(qtyInput?.value || '1', 10);
            selections.push({ productId: cb.value, quantity: qty });
        });
        if (selections.length === 0) {
            window.NotificationSystem?.show('Attenzione', 'Seleziona almeno un prodotto', 'warning');
            return;
        }
        if (window.productLinkingV20Final?.linkProductsToShipment) {
            window.productLinkingV20Final.linkProductsToShipment(shipmentId, selections);
            window.productLinkingV20Final.populateProductsMenu?.();
            updateProductsLinkStats?.();
            window.NotificationSystem?.show('Successo', 'Prodotti collegati', 'success');
        }
        closePanel();
    });
});
</script>

<script>
// Fix semplice e sicuro per reset button
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const resetBtn = document.getElementById('resetLinkedFiltersBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Reset semplice
                const filter = document.getElementById('linkedProductsFilter');
                const search = document.getElementById('linkedProductsSearch');
                
                if (filter) filter.value = 'all';
                if (search) search.value = '';
                
                console.log('âœ… Filtri resettati');
            });
            console.log('âœ… Reset button fix applicato (versione sicura)');
        }
    }, 2000);
});
</script>

<script>
// Fix solo per il reset button del registro spedizioni
setTimeout(() => {
    // Cerca il reset button nella schermata principale
    const mainResetBtn = document.getElementById('resetFiltersBtn');
    
    if (mainResetBtn) {
        console.log('âœ… Found main reset button, applying fix...');
        
        // Rimuovi listener esistenti
        const newBtn = mainResetBtn.cloneNode(true);
        mainResetBtn.parentNode.replaceChild(newBtn, mainResetBtn);
        
        // Aggiungi listener semplice
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('ðŸ”„ Main reset clicked');
            
            // Reset tutti i filtri della schermata principale
            const filters = [
                'statusFilter',
                'typeFilter', 
                'carrierFilter',
                'periodFilter',
                'searchRegistry'
            ];
            
            filters.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    if (element.tagName === 'SELECT') {
                        element.value = '';
                    } else if (element.tagName === 'INPUT') {
                        element.value = '';
                    }
                }
            });
            
            // Trigger refresh se disponibile
            if (window.registryCore && window.registryCore.render) {
                window.registryCore.render();
            }
            
            console.log('âœ… Main filters reset');
        });
        
        console.log('âœ… Main reset button fixed');
    } else {
        console.log('â„¹ï¸ Main reset button not found yet');
    }
}, 3000);
</script>

    <div id="productLinkPanel" class="product-link-panel" aria-hidden="true">
        <div class="product-link-panel-header">
            <h3 style="margin:0;">Collega Prodotti</h3>
            <button id="closeProductLinkPanel" class="sol-btn sol-btn-sm sol-btn-glass" title="Chiudi pannello">&times;</button>
        </div>
        <div class="product-link-panel-body">
            <div class="sol-form-group">
                <label class="sol-form-label" for="plShipmentSelect">Spedizione</label>
                <select id="plShipmentSelect" class="sol-form-select" title="Seleziona la spedizione di destinazione"></select>
            </div>
            <p style="font-size:0.875rem;color:var(--sol-gray-600);">Seleziona i prodotti e imposta la quantitÃ  da collegare.</p>
            <div id="plProductsList" style="margin-top:1rem;"></div>
        </div>
        <div class="product-link-panel-footer" style="text-align:right;">
            <button id="confirmProductLink" class="sol-btn sol-btn-primary" title="Collega i prodotti selezionati">Conferma</button>
        </div>
    </div>

</body>
</html>