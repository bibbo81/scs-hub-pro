<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Tracking Spedizioni</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/solarium.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Core Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- App Configuration -->
    <script>
        window.APP_VERSION = 'v48.2';
        window.SUPABASE_URL = 'https://gnlrmnsdmpjzitsysowq.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdubHJtbnNkbXBqeml0c3lzb3dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0NjMxMzQsImV4cCI6MjA2NTAzOTEzNH0.UoJJoDUoDXGbiWnKNN48qb9PVQWOW_X_MXqAfzTHSaA';
    </script>
</head>
<body>
    <!-- Header Component -->
    <div id="header-root"></div>

    <!-- Main Content -->
    <main class="sol-main-content">
        <div class="sol-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>Tracking Spedizioni</h1>
                <div class="page-actions">
                    <button id="btnImport" class="sol-btn sol-btn-secondary">
                        <i class="fas fa-file-import"></i> Importa
                    </button>
                    <button id="btnExport" class="sol-btn sol-btn-secondary">
                        <i class="fas fa-file-export"></i> Esporta
                    </button>
                    <button id="btnAddTracking" class="sol-btn sol-btn-primary">
                        <i class="fas fa-plus"></i> Aggiungi Tracking
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="sol-card mb-4">
                <div class="sol-card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="Cerca tracking number, carrier...">
                        </div>
                        <div class="col-md-3">
                            <select id="statusFilter" class="form-control">
                                <option value="">Tutti gli stati</option>
                                <option value="delivered">Consegnato</option>
                                <option value="in_transit">In transito</option>
                                <option value="arrived">Arrivato</option>
                                <option value="out_for_delivery">In consegna</option>
                                <option value="exception">Eccezione</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="carrierFilter" class="form-control">
                                <option value="">Tutti i carrier</option>
                                <option value="fedex">FedEx</option>
                                <option value="dhl">DHL</option>
                                <option value="ups">UPS</option>
                                <option value="gls">GLS</option>
                                <option value="tnt">TNT</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button id="btnResetFilters" class="sol-btn sol-btn-secondary w-100">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
                <div class="bulk-actions-content">
                    <span id="selectedCount">0 selezionati</span>
                    <div class="bulk-actions-buttons">
                        <button id="btnBulkRefresh" class="sol-btn sol-btn-sm sol-btn-primary">
                            <i class="fas fa-sync"></i> Aggiorna
                        </button>
                        <button id="btnBulkExport" class="sol-btn sol-btn-sm sol-btn-secondary">
                            <i class="fas fa-download"></i> Esporta
                        </button>
                        <button id="btnBulkDelete" class="sol-btn sol-btn-sm sol-btn-danger">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tracking Table -->
            <div class="sol-card">
                <div class="sol-card-body">
                    <div class="table-responsive">
                        <table class="sol-table" id="trackingTable">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>Tracking Number</th>
                                    <th>Carrier</th>
                                    <th>Stato</th>
                                    <th>Origine</th>
                                    <th>Destinazione</th>
                                    <th>Ultimo Aggiornamento</th>
                                    <th width="100">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="trackingTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nessun tracking trovato</p>
                        <button class="sol-btn sol-btn-primary" onclick="document.getElementById('btnAddTracking').click()">
                            <i class="fas fa-plus"></i> Aggiungi il tuo primo tracking
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Caricamento...</span>
                        </div>
                        <p class="text-muted mt-2">Caricamento tracking...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Load Core Modules -->
    <script type="module">
        // Import modules with versioning
        const V = window.APP_VERSION;
        
        // Import all required modules
        Promise.all([
            import(`/core/api-client.js?v=${V}`),
            import(`/core/header-component.js?v=${V}`),
            import(`/core/notification-system.js?v=${V}`),
            import(`/core/modal-system.js?v=${V}`),
            import(`/core/table-manager.js?v=${V}`),
            import(`/core/export-manager.js?v=${V}`),
            import(`/core/import-manager.js?v=${V}`),
            import(`/core/services/supabase-client.js?v=${V}`),
            import(`/core/services/supabase-tracking-service.js?v=${V}`),
            import(`/core/services/organization-api-keys-service.js?v=${V}`),
            import(`/core/services/tracking-service.js?v=${V}`),
            import(`/pages/tracking/tracking-form-progressive.js?v=${V}`)
        ]).then(modules => {
            // Expose modules globally
            window.api = modules[0].default;
            window.headerComponent = modules[1].default;
            window.NotificationSystem = modules[2].default;
            window.ModalSystem = modules[3].default;
            window.TableManager = modules[4].default;
            window.ExportManager = modules[5].default;
            window.ImportManager = modules[6].default;
            window.supabase = modules[7].supabase;
            window.supabaseTrackingService = modules[8].default;
            window.organizationApiKeysService = modules[9].default;
            window.trackingService = modules[10].default;
            window.TrackingFormProgressive = modules[11];
            
            console.log('✅ All modules loaded successfully');
            
            // Initialize page
            import(`/pages/tracking/index.js?v=${V}`).then(module => {
                console.log('✅ Tracking page initialized');
            });
        }).catch(error => {
            console.error('❌ Error loading modules:', error);
        });
    </script>

    <!-- Legacy Scripts -->
    <script src="/core/auth.js"></script>
    <script src="/core/auth-init.js"></script>
</body>
</html>