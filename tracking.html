<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Tracking Spedizioni</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/solarium.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Inline styles for critical elements -->
    <style>
        /* Ensure table is visible */
        #trackingTableBody { display: table-row-group !important; }
        .table-responsive { overflow-x: auto; }
        
        /* Loading state */
        #loadingState { padding: 3rem; text-align: center; }
        #emptyState { padding: 3rem; text-align: center; }
        
        /* Bulk actions bar */
        .bulk-actions-bar {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
            z-index: 100;
        }
        
        .bulk-actions-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Status badges */
        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }
        
        .badge-success { background-color: #28a745; color: white; }
        .badge-info { background-color: #17a2b8; color: white; }
        .badge-primary { background-color: #007bff; color: white; }
        .badge-warning { background-color: #ffc107; color: #212529; }
        .badge-danger { background-color: #dc3545; color: white; }
        .badge-secondary { background-color: #6c757d; color: white; }
        
        /* Carrier badges */
        .carrier-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .carrier-badge.fedex { background: #4d148c; color: white; }
        .carrier-badge.dhl { background: #ffcc00; color: #d40511; }
        .carrier-badge.ups { background: #351c15; color: white; }
        .carrier-badge.gls { background: #0066cc; color: white; }
        .carrier-badge.tnt { background: #ff6600; color: white; }
        
        /* Button group */
        .btn-group-sm .sol-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        /* Page header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .page-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
    
    <!-- Core Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- App Configuration -->
    <script>
        window.APP_VERSION = 'v48.2';
        window.SUPABASE_URL = 'https://gnlrmnsdmpjzitsysowq.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdubHJtbnNkbXBqeml0c3lzb3dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0NjMxMzQsImV4cCI6MjA2NTAzOTEzNH0.UoJJoDUoDXGbiWnKNN48qb9PVQWOW_X_MXqAfzTHSaA';
    </script>
</head>
<body>
    <!-- Header Component -->
    <div id="header-root"></div>

    <!-- Main Content -->
    <main class="sol-main-content">
        <div class="sol-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>Tracking Spedizioni</h1>
                <div class="page-actions">
                    <button id="btnImport" class="sol-btn sol-btn-secondary">
                        <i class="fas fa-file-import"></i> Importa
                    </button>
                    <button id="btnExport" class="sol-btn sol-btn-secondary">
                        <i class="fas fa-file-export"></i> Esporta
                    </button>
                    <button id="btnAddTracking" class="sol-btn sol-btn-primary">
                        <i class="fas fa-plus"></i> Aggiungi Tracking
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="sol-card mb-4">
                <div class="sol-card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="Cerca tracking number, carrier...">
                        </div>
                        <div class="col-md-3">
                            <select id="statusFilter" class="form-control">
                                <option value="">Tutti gli stati</option>
                                <option value="delivered">Consegnato</option>
                                <option value="in_transit">In transito</option>
                                <option value="arrived">Arrivato</option>
                                <option value="out_for_delivery">In consegna</option>
                                <option value="exception">Eccezione</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="carrierFilter" class="form-control">
                                <option value="">Tutti i carrier</option>
                                <option value="fedex">FedEx</option>
                                <option value="dhl">DHL</option>
                                <option value="ups">UPS</option>
                                <option value="gls">GLS</option>
                                <option value="tnt">TNT</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button id="btnResetFilters" class="sol-btn sol-btn-secondary w-100">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
                <div class="bulk-actions-content">
                    <span id="selectedCount">0 selezionati</span>
                    <div class="bulk-actions-buttons">
                        <button id="btnBulkRefresh" class="sol-btn sol-btn-sm sol-btn-primary">
                            <i class="fas fa-sync"></i> Aggiorna
                        </button>
                        <button id="btnBulkExport" class="sol-btn sol-btn-sm sol-btn-secondary">
                            <i class="fas fa-download"></i> Esporta
                        </button>
                        <button id="btnBulkDelete" class="sol-btn sol-btn-sm sol-btn-danger">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tracking Table -->
            <div class="sol-card">
                <div class="sol-card-body">
                    <div class="table-responsive">
                        <table class="sol-table" id="trackingTable">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>Tracking Number</th>
                                    <th>Carrier</th>
                                    <th>Stato</th>
                                    <th>Origine</th>
                                    <th>Destinazione</th>
                                    <th>Ultimo Aggiornamento</th>
                                    <th width="100">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="trackingTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nessun tracking trovato</p>
                        <button class="sol-btn sol-btn-primary" onclick="document.getElementById('btnAddTracking').click()">
                            <i class="fas fa-plus"></i> Aggiungi il tuo primo tracking
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Caricamento...</span>
                        </div>
                        <p class="text-muted mt-2">Caricamento tracking...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Load Core Modules -->
    <script type="module">
        // Import modules with versioning
        const V = window.APP_VERSION;
        
        // Import modules one by one with error handling
        (async () => {
            try {
                // Core modules
                const apiModule = await import(`/core/api-client.js?v=${V}`).catch(() => null);
                const headerModule = await import(`/core/header-component.js?v=${V}`).catch(() => null);
                const notificationModule = await import(`/core/notification-system.js?v=${V}`).catch(() => null);
                const modalModule = await import(`/core/modal-system.js?v=${V}`).catch(() => null);
                const tableModule = await import(`/core/table-manager.js?v=${V}`).catch(() => null);
                const exportModule = await import(`/core/export-manager.js?v=${V}`).catch(() => null);
                const importModule = await import(`/core/import-manager.js?v=${V}`).catch(() => null);
                
                // Supabase modules
                const supabaseClientModule = await import(`/core/services/supabase-client.js?v=${V}`).catch(() => null);
                const supabaseTrackingModule = await import(`/core/services/supabase-tracking-service.js?v=${V}`).catch(() => null);
                const orgApiKeysModule = await import(`/core/services/organization-api-keys-service.js?v=${V}`).catch(() => null);
                
                // Services
                const trackingServiceModule = await import(`/core/services/tracking-service.js?v=${V}`).catch(() => null);
                const trackingFormModule = await import(`/pages/tracking/tracking-form-progressive.js?v=${V}`).catch(() => null);
                
                // Expose modules globally
                if (apiModule) window.api = apiModule.default;
                if (headerModule) window.headerComponent = headerModule.default;
                if (notificationModule) window.NotificationSystem = notificationModule.default;
                if (modalModule) window.ModalSystem = modalModule.default;
                if (tableModule) window.TableManager = tableModule.default;
                if (exportModule) window.ExportManager = exportModule.default;
                if (importModule) window.ImportManager = importModule.default;
                if (supabaseClientModule) window.supabase = supabaseClientModule.supabase;
                if (supabaseTrackingModule) window.supabaseTrackingService = supabaseTrackingModule.default;
                if (orgApiKeysModule) window.organizationApiKeysService = orgApiKeysModule.default;
                if (trackingServiceModule) window.trackingService = trackingServiceModule.default;
                if (trackingFormModule) {
                    window.TrackingFormProgressive = trackingFormModule;
                    // Check if the function is directly exported
                    if (trackingFormModule.showEnhancedTrackingForm) {
                        window.showEnhancedTrackingForm = trackingFormModule.showEnhancedTrackingForm;
                        console.log('✅ showEnhancedTrackingForm exposed globally');
                    }
                    // Check default export
                    if (trackingFormModule.default?.showEnhancedTrackingForm) {
                        window.showEnhancedTrackingForm = trackingFormModule.default.showEnhancedTrackingForm;
                        console.log('✅ showEnhancedTrackingForm from default export');
                    }
                }
                
                console.log('✅ Modules loaded:', {
                    api: !!window.api,
                    header: !!window.headerComponent,
                    notification: !!window.NotificationSystem,
                    modal: !!window.ModalSystem,
                    table: !!window.TableManager,
                    export: !!window.ExportManager,
                    import: !!window.ImportManager,
                    supabase: !!window.supabase,
                    tracking: !!window.trackingService
                });
                
                // Initialize page
                await import(`/pages/tracking/index.js?v=${V}`);
                console.log('✅ Tracking page initialized');
                
            } catch (error) {
                console.error('❌ Error during initialization:', error);
                
                // Show error to user
                document.getElementById('loadingState').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Errore di caricamento</strong><br>
                        Si è verificato un errore nel caricamento della pagina.<br>
                        <small>${error.message}</small><br>
                        <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">
                            <i class="fas fa-redo"></i> Ricarica
                        </button>
                    </div>
                `;
            }
        })();
    </script>

    <!-- Legacy Scripts -->
    <script src="/core/auth.js"></script>
    <script src="/core/auth-init.js"></script>
    
    <!-- Fallback functions -->
    <script>
        // Fallback functions in case modules don't load
        if (!window.refreshTracking) {
            window.refreshTracking = function(id) {
                console.log('Refreshing tracking:', id);
                alert('Funzione non disponibile al momento');
            };
        }
        
        if (!window.viewDetails) {
            window.viewDetails = function(id) {
                console.log('Viewing details:', id);
                alert('Funzione non disponibile al momento');
            };
        }
        
        if (!window.deleteTracking) {
            window.deleteTracking = function(id) {
                console.log('Deleting tracking:', id);
                if (confirm('Eliminare questo tracking?')) {
                    // Remove from localStorage
                    const stored = localStorage.getItem('trackings');
                    if (stored) {
                        const trackings = JSON.parse(stored);
                        const filtered = trackings.filter(t => t.id !== id);
                        localStorage.setItem('trackings', JSON.stringify(filtered));
                        location.reload();
                    }
                }
            };
        }
    </script>
</body>
</html>