<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Tracking Spedizioni</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/solarium.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Inline styles for critical elements -->
    <style>
        /* Ensure table is visible */
        #trackingTableBody { display: table-row-group !important; }
        .table-responsive { overflow-x: auto; }
        
        /* Loading state */
        #loadingState { padding: 3rem; text-align: center; }
        #emptyState { padding: 3rem; text-align: center; }
        
        /* Bulk actions bar */
        .bulk-actions-bar {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
            z-index: 100;
        }
        
        .bulk-actions-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Status badges */
        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }
        
        .badge-success { background-color: #28a745; color: white; }
        .badge-info { background-color: #17a2b8; color: white; }
        .badge-primary { background-color: #007bff; color: white; }
        .badge-warning { background-color: #ffc107; color: #212529; }
        .badge-danger { background-color: #dc3545; color: white; }
        .badge-secondary { background-color: #6c757d; color: white; }
        
        /* Carrier badges */
        .carrier-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .carrier-badge.fedex { background: #4d148c; color: white; }
        .carrier-badge.dhl { background: #ffcc00; color: #d40511; }
        .carrier-badge.ups { background: #351c15; color: white; }
        .carrier-badge.gls { background: #0066cc; color: white; }
        .carrier-badge.tnt { background: #ff6600; color: white; }
        
        /* Button group */
        .btn-group-sm .sol-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        /* Page header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .page-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
    
    <!-- Core Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- App Configuration -->
    <script>
        window.APP_VERSION = 'v48.3-FIXED';
        window.SUPABASE_URL = 'https://gnlrmnsdmpjzitsysowq.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdubHJtbnNkbXBqeml0c3lzb3dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0NjMxMzQsImV4cCI6MjA2NTAzOTEzNH0.UoJJoDUoDXGbiWnKNN48qb9PVQWOW_X_MXqAfzTHSaA';
    </script>
</head>
<body>
    <!-- Header Component -->
    <div id="header-root"></div>

    <!-- Main Content -->
    <main class="sol-main-content">
        <div class="sol-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>Tracking Spedizioni</h1>
                <div class="page-actions">
                    <button id="btnImport" class="sol-btn sol-btn-secondary" onclick="showImportDialog()">
                        <i class="fas fa-upload"></i> Importa
                    </button>
                    <button id="btnExport" class="sol-btn sol-btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i> Esporta
                    </button>
                    <button id="btnAddTracking" class="sol-btn sol-btn-primary" onclick="showAddTrackingForm()">
                        <i class="fas fa-plus"></i> Aggiungi Tracking
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="sol-card mb-4">
                <div class="sol-card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Cerca</label>
                            <input type="text" id="searchInput" class="sol-form-control" 
                                   placeholder="Numero tracking, carrier, riferimento...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Stato</label>
                            <select id="statusFilter" class="sol-form-control">
                                <option value="">Tutti gli stati</option>
                                <option value="delivered">Consegnato</option>
                                <option value="in_transit">In transito</option>
                                <option value="arrived">Arrivato</option>
                                <option value="pending">In attesa</option>
                                <option value="exception">Eccezione</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Carrier</label>
                            <select id="carrierFilter" class="sol-form-control">
                                <option value="">Tutti i carrier</option>
                                <option value="fedex">FedEx</option>
                                <option value="dhl">DHL</option>
                                <option value="ups">UPS</option>
                                <option value="gls">GLS</option>
                                <option value="tnt">TNT</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button id="btnResetFilters" class="sol-btn sol-btn-outline w-100" onclick="resetFilters()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
                <div class="bulk-actions-content">
                    <div>
                        <span class="text-muted">Selezionati:</span>
                        <strong id="selectedCount">0</strong> tracking
                    </div>
                    <div>
                        <button class="sol-btn sol-btn-sm sol-btn-secondary" onclick="performBulkAction('refresh')">
                            <i class="fas fa-sync"></i> Aggiorna
                        </button>
                        <button class="sol-btn sol-btn-sm sol-btn-danger" onclick="performBulkAction('delete')">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Table Card -->
            <div class="sol-card">
                <div class="sol-card-body p-0">
                    <!-- Table -->
                    <div class="table-responsive">
                        <table id="trackingTable" class="sol-table">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" 
                                               onchange="toggleSelectAll(this)">
                                    </th>
                                    <th>Tracking Number</th>
                                    <th>Carrier</th>
                                    <th>Stato</th>
                                    <th>Origine</th>
                                    <th>Destinazione</th>
                                    <th>Ultimo Aggiornamento</th>
                                    <th width="120">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="trackingTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nessun tracking trovato</p>
                        <button class="sol-btn sol-btn-primary" onclick="document.getElementById('btnAddTracking').click()">
                            <i class="fas fa-plus"></i> Aggiungi il tuo primo tracking
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Caricamento...</span>
                        </div>
                        <p class="text-muted mt-2">Caricamento tracking...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

<script>
(function() {
    'use strict';
    
    console.log('🚀 Quick fix for organizationApiKeysService');
    
    // Attendi che organizationApiKeysService sia disponibile
    const checkInterval = setInterval(() => {
        if (window.organizationApiKeysService) {
            // Aggiungi il metodo mancante immediatamente
            if (!window.organizationApiKeysService.getOrganizationApiKeys) {
                window.organizationApiKeysService.getOrganizationApiKeys = async function() {
                    console.log('📦 Using quick-fixed getOrganizationApiKeys');
                    if (this.getApiKeys) {
                        return await this.getApiKeys();
                    }
                    if (this.getAllKeys) {
                        return await this.getAllKeys();
                    }
                    console.warn('No API keys method available, returning empty array');
                    return [];
                };
                console.log('✅ Added getOrganizationApiKeys method');
            }
            clearInterval(checkInterval);
        }
    }, 100);
    
    // Stop dopo 10 secondi
    setTimeout(() => clearInterval(checkInterval), 10000);
})();
</script>

    <!-- Load Core Modules -->
    <script type="module">
        // Import modules with versioning
        const V = window.APP_VERSION;
        
        // Import modules one by one with error handling
        (async () => {
            try {
                // Core modules
                const apiModule = await import(`/core/api-client.js?v=${V}`).catch(() => null);
                const headerModule = await import(`/core/header-component.js?v=${V}`).catch(() => null);
                const notificationModule = await import(`/core/notification-system.js?v=${V}`).catch(() => null);
                const modalModule = await import(`/core/modal-system.js?v=${V}`).catch(() => null);
                const tableModule = await import(`/core/table-manager.js?v=${V}`).catch(() => null);
                const exportModule = await import(`/core/export-manager.js?v=${V}`).catch(() => null);
                const importModule = await import(`/core/import-manager.js?v=${V}`).catch(() => null);
                
                // Supabase modules
                const supabaseClientModule = await import(`/core/services/supabase-client.js?v=${V}`).catch(() => null);
                const supabaseTrackingModule = await import(`/core/services/supabase-tracking-service.js?v=${V}`).catch(() => null);
                const orgApiKeysModule = await import(`/core/services/organization-api-keys-service.js?v=${V}`).catch(() => null);
                const trackingServiceModule = await import(`/core/services/tracking-service.js?v=${V}`).catch(() => null);
                
                // Tracking form progressive
                const trackingFormModule = await import(`/pages/tracking/tracking-form-progressive.js?v=${V}`).catch(() => null);
                
                // Expose modules globally
                if (apiModule) window.api = apiModule.default;
                if (headerModule) window.headerComponent = headerModule.default;
                if (notificationModule) window.NotificationSystem = notificationModule.default;
                if (modalModule) window.ModalSystem = modalModule.default;
                if (tableModule) window.TableManager = tableModule.default;
                if (exportModule) window.ExportManager = exportModule.default;
                if (importModule) window.ImportManager = importModule.default;
                if (supabaseClientModule) window.supabase = supabaseClientModule.supabase;
                if (supabaseTrackingModule) window.supabaseTrackingService = supabaseTrackingModule.default;
                if (orgApiKeysModule) window.organizationApiKeysService = orgApiKeysModule.default;
                if (trackingServiceModule) window.trackingService = trackingServiceModule.default;
                if (trackingFormModule) window.TrackingFormProgressive = trackingFormModule;
                
                // Log module status
                console.log('📦 Module status:', {
                    api: !!window.api,
                    header: !!window.headerComponent,
                    notification: !!window.NotificationSystem,
                    modal: !!window.ModalSystem,
                    table: !!window.TableManager,
                    export: !!window.ExportManager,
                    import: !!window.ImportManager,
                    supabase: !!window.supabase,
                    tracking: !!window.trackingService
                });
                
                // Initialize page
                await import(`/pages/tracking/index.js?v=${V}`);
                console.log('✅ Tracking page initialized');
                
            } catch (error) {
                console.error('❌ Error during initialization:', error);
                
                // Show error to user
                document.getElementById('loadingState').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Errore di caricamento</strong><br>
                        Si è verificato un errore nel caricamento della pagina.<br>
                        <small>${error.message}</small><br>
                        <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">
                            <i class="fas fa-redo"></i> Ricarica
                        </button>
                    </div>
                `;
            }
        })();
    </script>

    <!-- Legacy Scripts -->
    <script src="/core/auth.js"></script>
    <script src="/core/auth-init.js"></script>
    
    <!-- NUOVO: Fix Script per inizializzazione -->
    <script src="/pages/tracking/tracking-init-fix.js"></script>
    
    <script src="/pages/tracking/tracking-complete-fix.js"></script>

    <!-- Fallback functions -->
    <script>
        // Fallback functions in case modules don't load
        if (!window.refreshTracking) {
            window.refreshTracking = function(id) {
                console.log('Refreshing tracking:', id);
                alert('Funzione non disponibile al momento');
            };
        }
        
        if (!window.viewDetails) {
            window.viewDetails = function(id) {
                console.log('Viewing details:', id);
                alert('Funzione non disponibile al momento');
            };
        }
        
        if (!window.deleteTracking) {
            window.deleteTracking = function(id) {
                console.log('Deleting tracking:', id);
                if (confirm('Eliminare questo tracking?')) {
                    // Remove from localStorage
                    const stored = localStorage.getItem('trackings');
                    if (stored) {
                        const trackings = JSON.parse(stored);
                        const filtered = trackings.filter(t => t.id !== id);
                        localStorage.setItem('trackings', JSON.stringify(filtered));
                        location.reload();
                    }
                }
            };
        }
        
        if (!window.resetFilters) {
            window.resetFilters = function() {
                document.getElementById('searchInput').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('carrierFilter').value = '';
                if (window.applyFilters) window.applyFilters();
            };
        }
    </script>

<script>
// FIX COMBINATO COMPLETO - TUTTI I FIX IN UNO
(function() {
    'use strict';
    
    console.log('🚀 COMBINED FIX: Starting all fixes...');
    
    // ========================================
    // PARTE 1: INIZIALIZZAZIONE VARIABILI
    // ========================================
    
    window.trackings = window.trackings || [];
    window.filteredTrackings = window.filteredTrackings || [];
    window.selectedTrackingIds = window.selectedTrackingIds || new Set();
    
    // ========================================
    // PARTE 2: COLONNE DISPONIBILI
    // ========================================
    
    const AVAILABLE_COLUMNS = [
        { key: 'tracking_number', label: 'Tracking Number', required: true },
        { key: 'reference', label: 'Riferimento', required: false },
        { key: 'tracking_type', label: 'Tipo', required: false },
        { key: 'status', label: 'Stato', required: true },
        { key: 'carrier', label: 'Carrier', required: false },
        { key: 'origin_name', label: 'Origine', required: false },
        { key: 'destination_name', label: 'Destinazione', required: false },
        { key: 'eta', label: 'ETA', required: false }
    ];
    
    let visibleColumns = ['tracking_number', 'status', 'carrier', 'origin_name', 'destination_name', 'eta'];
    
    // ========================================
    // PARTE 3: HELPER FUNCTIONS
    // ========================================
    
    function getStatusClass(status) {
        const statusMap = {
            'delivered': 'success',
            'in_transit': 'primary',
            'pending': 'warning',
            'exception': 'danger',
            'created': 'secondary'
        };
        return statusMap[status?.toLowerCase()] || 'secondary';
    }
    
    function formatDate(dateString) {
        if (!dateString || dateString === '-') return '-';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        } catch {
            return dateString;
        }
    }
    
    // ========================================
    // PARTE 4: TROVA O CREA TBODY
    // ========================================
    
    function findOrCreateTbody() {
        // Cerca tbody esistente
        let tbody = document.getElementById('trackingTableBody');
        if (tbody) return tbody;
        
        // Cerca nella tabella
        const table = document.getElementById('trackingTable');
        if (table) {
            tbody = table.querySelector('tbody');
            if (!tbody) {
                tbody = document.createElement('tbody');
                tbody.id = 'trackingTableBody';
                table.appendChild(tbody);
            }
            return tbody;
        }
        
        return null;
    }
    
    // ========================================
    // PARTE 5: RENDER TABELLA
    // ========================================
    
    function renderTableComplete() {
        console.log('📊 Rendering table...');
        
        const tbody = findOrCreateTbody();
        if (!tbody) {
            console.error('Cannot find tbody');
            return;
        }
        
        // Nascondi empty state
        const emptyState = document.getElementById('emptyState');
        if (emptyState) emptyState.style.display = 'none';
        
        // Usa trackings se filteredTrackings è vuoto
        if (!window.filteredTrackings || window.filteredTrackings.length === 0) {
            window.filteredTrackings = window.trackings;
        }
        
        // Se ancora vuoto, mostra messaggio
        if (!window.filteredTrackings || window.filteredTrackings.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <p>Nessun tracking trovato</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Render righe
        tbody.innerHTML = window.filteredTrackings.map(function(tracking) {
            return `
                <tr data-id="${tracking.id}">
                    <td>
                        <input type="checkbox" class="form-check-input row-select" data-id="${tracking.id}">
                    </td>
                    <td>
                        <strong>${tracking.tracking_number || '-'}</strong>
                        ${tracking.reference ? '<br><small class="text-muted">' + tracking.reference + '</small>' : ''}
                    </td>
                    <td>
                        <span class="badge bg-secondary">${tracking.tracking_type || 'container'}</span>
                    </td>
                    <td>
                        <span class="badge bg-${getStatusClass(tracking.status)}">${tracking.status || 'pending'}</span>
                    </td>
                    <td>${tracking.origin_name || '-'}</td>
                    <td>${tracking.destination_name || '-'}</td>
                    <td>${formatDate(tracking.eta) || '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary" onclick="refreshTracking('${tracking.id}')" title="Aggiorna">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button class="btn btn-info" onclick="viewDetails('${tracking.id}')" title="Dettagli">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteTracking('${tracking.id}')" title="Elimina">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        console.log('✅ Table rendered with ' + window.filteredTrackings.length + ' rows');
    }
    
    // ========================================
    // PARTE 6: CARICA DATI
    // ========================================
    
    async function loadDataAndRender() {
        console.log('📦 Loading data...');
        
        // Attendi che il servizio sia pronto
        let attempts = 0;
        while (!window.supabaseTrackingService && attempts < 30) {
            await new Promise(function(resolve) { setTimeout(resolve, 100); });
            attempts++;
        }
        
        if (window.supabaseTrackingService && window.supabaseTrackingService.getAllTrackings) {
            try {
                const data = await window.supabaseTrackingService.getAllTrackings();
                if (data && data.length > 0) {
                    window.trackings = data;
                    window.filteredTrackings = data;
                    console.log('✅ Loaded ' + data.length + ' trackings');
                    renderTableComplete();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
    }
    
    // ========================================
    // PARTE 7: DELETE FUNCTION
    // ========================================
    
    window.deleteTracking = async function(id) {
        if (!confirm('Eliminare questo tracking?')) return;
        
        try {
            if (window.supabaseTrackingService && window.supabaseTrackingService.deleteTracking) {
                await window.supabaseTrackingService.deleteTracking(id);
            }
            
            window.trackings = window.trackings.filter(function(t) { return t.id !== id; });
            window.filteredTrackings = window.filteredTrackings.filter(function(t) { return t.id !== id; });
            
            renderTableComplete();
            
            if (window.NotificationSystem) {
                window.NotificationSystem.success('Tracking eliminato');
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('Errore durante eliminazione');
        }
    };
    
    // ========================================
    // PARTE 8: COLUMN SELECTOR BUTTON
    // ========================================
    
    function addColumnSelectorButton() {
        const buttonContainer = document.querySelector('.d-flex.gap-2.mb-3');
        if (!buttonContainer || document.getElementById('columnSelectorBtn')) return;
        
        const btn = document.createElement('button');
        btn.id = 'columnSelectorBtn';
        btn.className = 'btn btn-outline-secondary';
        btn.innerHTML = '<i class="fas fa-columns"></i> Gestisci Colonne';
        btn.onclick = function() {
            showColumnSelector();
        };
        
        buttonContainer.insertBefore(btn, buttonContainer.firstChild);
    }
    
    function showColumnSelector() {
        alert('Selettore colonne disponibile prossimamente!');
        // TODO: Implementare modal per selezione colonne
    }
    
    // ========================================
    // PARTE 9: OVERRIDE RENDER
    // ========================================
    
    if (window.renderTable) {
        const originalRender = window.renderTable;
        window.renderTable = function() {
            try {
                originalRender();
            } catch (e) {
                console.error('Original render failed:', e);
            }
            renderTableComplete();
        };
    } else {
        window.renderTable = renderTableComplete;
    }
    
    // ========================================
    // PARTE 10: STILI
    // ========================================
    
    function injectStyles() {
        const style = document.createElement('style');
        style.textContent = `
            #trackingTable {
                width: 100%;
                background: white;
            }
            
            #trackingTable thead th {
                background: #f8f9fa;
                padding: 12px;
                font-weight: 600;
            }
            
            #trackingTable tbody td {
                padding: 12px;
                vertical-align: middle;
                border-bottom: 1px solid #dee2e6;
            }
            
            #trackingTable tbody tr:hover {
                background-color: #f8f9fa;
            }
            
            .badge {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
            }
        `;
        document.head.appendChild(style);
    }
    
    // ========================================
    // PARTE 11: INIZIALIZZAZIONE
    // ========================================
    
    async function init() {
        console.log('🚀 Initializing combined fix...');
        
        // Inietta stili
        injectStyles();
        
        // Aggiungi pulsante colonne
        addColumnSelectorButton();
        
        // Carica dati e renderizza
        await loadDataAndRender();
        
        // Se non ci sono ancora dati, riprova
        if (window.trackings.length === 0) {
            setTimeout(loadDataAndRender, 2000);
        }
    }
    
    // ========================================
    // PARTE 12: DEBUG COMMANDS
    // ========================================
    
    window.trackingFix = {
        reload: loadDataAndRender,
        render: renderTableComplete,
        showData: function() {
            console.log('Trackings:', window.trackings);
            console.log('Filtered:', window.filteredTrackings);
        }
    };
    
    // Avvia quando DOM è pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        setTimeout(init, 500);
    }
    
    console.log('✅ COMBINED FIX LOADED');
    console.log('Commands: trackingFix.reload(), trackingFix.render(), trackingFix.showData()');
    
})();
</script>

<script>
(function() {
    'use strict';
    
    console.log('🔧 TBODY FIX: Verifica e correzione tbody...');
    
    // Funzione per trovare o creare tbody
    function fixTbodyStructure() {
        // Cerca tbody
        let tbody = document.getElementById('trackingTableBody');
        if (tbody) {
            console.log('✅ tbody trovato');
            return tbody;
        }
        
        // Cerca table
        const table = document.getElementById('trackingTable');
        if (!table) {
            console.error('❌ Table non trovata!');
            
            // Cerca in container
            const container = document.getElementById('trackingTableContainer');
            if (container) {
                const tables = container.querySelectorAll('table');
                if (tables.length > 0) {
                    tables[0].id = 'trackingTable';
                    console.log('✅ Assegnato ID a table');
                }
            }
            return null;
        }
        
        // Cerca tbody nella table
        tbody = table.querySelector('tbody');
        if (!tbody) {
            // Crea tbody
            tbody = document.createElement('tbody');
            tbody.id = 'trackingTableBody';
            table.appendChild(tbody);
            console.log('✅ tbody creato e aggiunto');
        } else {
            // Assegna ID se manca
            tbody.id = 'trackingTableBody';
            console.log('✅ ID assegnato a tbody esistente');
        }
        
        return tbody;
    }
    
    // Verifica e sistema la struttura
    setTimeout(function() {
        console.log('🔍 Controllo struttura tabella...');
        
        const tbody = fixTbodyStructure();
        if (tbody) {
            console.log('✅ Struttura tabella OK');
            
            // Se ci sono dati ma la tabella è vuota, forza render
            if (window.trackings && window.trackings.length > 0 && tbody.children.length === 0) {
                console.log('📊 Forzatura render tabella...');
                if (window.trackingFix && window.trackingFix.render) {
                    window.trackingFix.render();
                } else if (window.renderTable) {
                    window.renderTable();
                }
            }
        }
        
        // Verifica presenza dati
        console.log('📦 Dati presenti:', {
            trackings: window.trackings ? window.trackings.length : 0,
            filtered: window.filteredTrackings ? window.filteredTrackings.length : 0
        });
        
    }, 2000); // Aspetta 2 secondi per essere sicuro che tutto sia caricato
    
    // Comando debug
    window.checkTable = function() {
        console.log('=== CHECK TABLE ===');
        console.log('Table:', document.getElementById('trackingTable'));
        console.log('Tbody:', document.getElementById('trackingTableBody'));
        console.log('Rows:', document.querySelectorAll('#trackingTableBody tr').length);
        console.log('Data:', window.trackings ? window.trackings.length : 'No data');
    };
    
    console.log('✅ TBODY FIX caricato. Usa checkTable() per debug');
})();
</script>

</body>
</html>