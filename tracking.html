# üìã HANDOFF COMPLETO v7 - Supply Chain Hub Tracking Page Fix

## üéØ SITUAZIONE ATTUALE

### Problemi Identificati:
1. **Tabella rimane in caricamento** - Conflitti tra script di fix e nuovo TableManager
2. **Checkbox non cliccabili** - Eventi non collegati correttamente
3. **Bulk actions non funzionano** - Selezione non attiva le azioni
4. **Troppi script di fix** che vanno in conflitto

### File Attualmente in Uso:
- `/pages/tracking/tracking.html` (NON tracking-FIXED.html)
- `/pages/tracking/index.js` (da aggiornare con index-FIXED.js)
- `/core/table-manager.js` (gi√† aggiornato con il nuovo codice)

## üîß MODIFICHE NECESSARIE

### 1. **tracking.html** - RIMUOVERE Script Conflittuali

**TROVA E RIMUOVI/COMMENTA questi script alla fine del file:**

```html
<!-- RIMUOVI O COMMENTA QUESTI -->
<script src="/pages/tracking/tracking-init-fix.js"></script>
<script src="/pages/tracking/tracking-complete-fix.js"></script>

<script>
// FIX COMBINATO COMPLETO - TUTTI I FIX IN UNO
(function() {
    // TUTTO questo script va rimosso
})();
</script>

<script>
// Fix permanente per tabella tracking
(function() {
    // ANCHE questo script va rimosso
})();
</script>
```

**MANTIENI SOLO:**
```html
<!-- Load Core Modules -->
<script type="module">
    // MANTIENI tutto il codice di import modules
</script>

<!-- Legacy Scripts -->
<script src="/core/auth.js"></script>
<script src="/core/auth-init.js"></script>
```

### 2. **index.js** - SOSTITUIRE COMPLETAMENTE

**PROBLEMA:** Il file index.js attuale non usa il nuovo TableManager correttamente.

**SOLUZIONE:** Sostituisci TUTTO il contenuto di `/pages/tracking/index.js` con:

```javascript
// index.js - Clean tracking page logic
import TableManager from '/core/table-manager.js';

// State
let trackings = [];
let filteredTrackings = [];
let tableManager = null;

// Column configuration
const COLUMNS = [
    { key: 'tracking_number', label: 'Tracking Number', sortable: true },
    { key: 'carrier', label: 'Carrier', sortable: true },
    { key: 'status', label: 'Stato', sortable: true, formatter: formatStatus },
    { key: 'origin_name', label: 'Origine', sortable: true },
    { key: 'destination_name', label: 'Destinazione', sortable: true },
    { key: 'last_update', label: 'Ultimo Aggiornamento', sortable: true, formatter: formatDate },
    { 
        key: 'actions', 
        label: 'Azioni', 
        sortable: false,
        formatter: (value, row) => `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-primary" onclick="refreshTracking('${row.id}')">
                    <i class="fas fa-sync"></i>
                </button>
                <button class="btn btn-info" onclick="viewDetails('${row.id}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-danger" onclick="deleteTracking('${row.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `
    }
];

// Formatters
function formatStatus(value) {
    const statusMap = {
        'delivered': { label: 'Consegnato', class: 'success' },
        'in_transit': { label: 'In transito', class: 'primary' },
        'pending': { label: 'In attesa', class: 'warning' },
        'exception': { label: 'Eccezione', class: 'danger' }
    };
    const status = statusMap[value] || { label: value, class: 'secondary' };
    return `<span class="badge badge-${status.class}">${status.label}</span>`;
}

function formatDate(value) {
    if (!value) return '-';
    return new Date(value).toLocaleString('it-IT');
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Initializing tracking page...');
    
    try {
        // Hide loading state
        document.getElementById('loadingState').style.display = 'none';
        
        // Create table container
        const tableCard = document.querySelector('.sol-card-body.p-0');
        const tableContainer = document.createElement('div');
        tableContainer.id = 'trackingTableContainer';
        
        // Remove existing table
        const oldTable = document.getElementById('trackingTable');
        if (oldTable) {
            oldTable.style.display = 'none';
        }
        
        // Insert new container
        tableCard.insertBefore(tableContainer, tableCard.firstChild);
        
        // Initialize TableManager
        tableManager = new TableManager('trackingTableContainer', {
            columns: COLUMNS,
            selectable: true,
            searchable: false, // We use external search
            paginate: true,
            pageSize: 20,
            enableColumnDrag: true,
            onSelectionChange: handleSelectionChange
        });
        
        // Register globally
        window.registerTableManager('trackingTableContainer', tableManager);
        
        // Load data
        await loadTrackings();
        
        // Setup event listeners
        setupEventListeners();
        
        console.log('‚úÖ Tracking page initialized');
        
    } catch (error) {
        console.error('‚ùå Initialization error:', error);
        showError('Errore durante l\'inizializzazione');
    }
});

// Load trackings
async function loadTrackings() {
    try {
        if (window.supabaseTrackingService) {
            const data = await window.supabaseTrackingService.getAllTrackings();
            trackings = data || [];
        } else {
            // Mock data for testing
            trackings = [
                {
                    id: '1',
                    tracking_number: 'TEST123',
                    carrier: 'DHL',
                    status: 'in_transit',
                    origin_name: 'Milano',
                    destination_name: 'Roma',
                    last_update: new Date().toISOString()
                }
            ];
        }
        
        filteredTrackings = [...trackings];
        updateTable();
        
    } catch (error) {
        console.error('Error loading trackings:', error);
    }
}

// Update table
function updateTable() {
    if (tableManager) {
        tableManager.setData(filteredTrackings);
    }
}

// Handle selection change
function handleSelectionChange(selected) {
    const bulkBar = document.getElementById('bulkActionsBar');
    const count = document.getElementById('selectedCount');
    
    if (bulkBar) {
        bulkBar.style.display = selected.length > 0 ? 'block' : 'none';
    }
    
    if (count) {
        count.textContent = selected.length;
    }
}

// Setup event listeners
function setupEventListeners() {
    // Search
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            filteredTrackings = trackings.filter(t => 
                t.tracking_number?.toLowerCase().includes(term) ||
                t.carrier?.toLowerCase().includes(term) ||
                t.origin_name?.toLowerCase().includes(term) ||
                t.destination_name?.toLowerCase().includes(term)
            );
            updateTable();
        });
    }
    
    // Filters
    document.getElementById('statusFilter')?.addEventListener('change', applyFilters);
    document.getElementById('carrierFilter')?.addEventListener('change', applyFilters);
    
    // Global functions
    window.refreshTracking = refreshTracking;
    window.viewDetails = viewDetails;
    window.deleteTracking = deleteTracking;
    window.showAddTrackingForm = showAddTrackingForm;
    window.showImportDialog = showImportDialog;
    window.exportData = exportData;
    window.resetFilters = resetFilters;
    window.toggleSelectAll = toggleSelectAll;
    window.performBulkAction = performBulkAction;
}

// Apply filters
function applyFilters() {
    const status = document.getElementById('statusFilter')?.value;
    const carrier = document.getElementById('carrierFilter')?.value;
    
    filteredTrackings = trackings.filter(t => {
        if (status && t.status !== status) return false;
        if (carrier && t.carrier !== carrier) return false;
        return true;
    });
    
    updateTable();
}

// Actions
async function refreshTracking(id) {
    console.log('Refresh tracking:', id);
    window.NotificationSystem?.info('Aggiornamento tracking...');
}

function viewDetails(id) {
    console.log('View details:', id);
    const tracking = trackings.find(t => t.id === id);
    if (tracking && window.ModalSystem) {
        window.ModalSystem.show({
            title: `Dettagli: ${tracking.tracking_number}`,
            content: `
                <div>
                    <p><strong>Carrier:</strong> ${tracking.carrier || '-'}</p>
                    <p><strong>Stato:</strong> ${formatStatus(tracking.status)}</p>
                    <p><strong>Origine:</strong> ${tracking.origin_name || '-'}</p>
                    <p><strong>Destinazione:</strong> ${tracking.destination_name || '-'}</p>
                </div>
            `
        });
    }
}

async function deleteTracking(id) {
    if (!confirm('Eliminare questo tracking?')) return;
    
    try {
        if (window.supabaseTrackingService) {
            await window.supabaseTrackingService.deleteTracking(id);
        }
        
        trackings = trackings.filter(t => t.id !== id);
        filteredTrackings = filteredTrackings.filter(t => t.id !== id);
        updateTable();
        
        window.NotificationSystem?.success('Tracking eliminato');
        
    } catch (error) {
        console.error('Delete error:', error);
        window.NotificationSystem?.error('Errore eliminazione');
    }
}

function showAddTrackingForm() {
    console.log('Show add form');
    if (window.showEnhancedTrackingForm) {
        window.showEnhancedTrackingForm();
    } else {
        window.NotificationSystem?.info('Form in caricamento...');
    }
}

function showImportDialog() {
    console.log('Show import dialog');
    window.NotificationSystem?.info('Import in sviluppo...');
}

function exportData() {
    if (tableManager) {
        tableManager.export('excel');
    }
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('carrierFilter').value = '';
    applyFilters();
}

function toggleSelectAll(checkbox) {
    if (tableManager) {
        tableManager.selectAll(checkbox.checked);
    }
}

function performBulkAction(action) {
    const selected = tableManager?.getSelectedRows() || [];
    
    if (selected.length === 0) {
        window.NotificationSystem?.warning('Nessun tracking selezionato');
        return;
    }
    
    switch(action) {
        case 'refresh':
            console.log('Bulk refresh:', selected.length);
            window.NotificationSystem?.info(`Aggiornamento ${selected.length} tracking...`);
            break;
            
        case 'delete':
            if (confirm(`Eliminare ${selected.length} tracking?`)) {
                console.log('Bulk delete:', selected.length);
                // TODO: Implement bulk delete
                window.NotificationSystem?.success('Tracking eliminati');
            }
            break;
    }
}

function showError(message) {
    if (window.NotificationSystem) {
        window.NotificationSystem.error(message);
    } else {
        alert(message);
    }
}

// Export for debugging
window.trackingDebug = {
    getData: () => ({ trackings, filteredTrackings }),
    getTable: () => tableManager,
    refresh: () => loadTrackings()
};
```

### 3. **Verifica File Necessari**

Assicurati che questi file esistano e siano aggiornati:
- ‚úÖ `/core/table-manager.js` (con export default alla fine)
- ‚úÖ `/pages/tracking/tracking-complete.css`
- ‚úÖ `/core/services/supabase-tracking-service.js`
- ‚úÖ `/core/modal-system.js`
- ‚úÖ `/core/notification-system.js`

## üöÄ ORDINE DI ESECUZIONE

1. **PRIMA:** Modifica `tracking.html` rimuovendo gli script di fix
2. **POI:** Sostituisci completamente `index.js` con il codice sopra
3. **INFINE:** Fai hard refresh (Ctrl+F5) e testa

## ‚úÖ COSA DOVREBBE FUNZIONARE DOPO

- ‚úÖ Tabella visibile senza "Caricamento..."
- ‚úÖ Checkbox select all funzionante
- ‚úÖ Selezione righe attiva bulk actions
- ‚úÖ Drag & drop colonne
- ‚úÖ Paginazione
- ‚úÖ Ricerca in tempo reale
- ‚úÖ Filtri funzionanti
- ‚úÖ Export Excel/PDF
- ‚úÖ Azioni (view, refresh, delete)

## üêõ TROUBLESHOOTING

**Se la tabella non si vede:**
- Controlla console per errori
- Verifica che TableManager sia caricato: `console.log(window.TableManager)`

**Se le checkbox non funzionano:**
- Verifica che toggleSelectAll sia definita: `console.log(window.toggleSelectAll)`
- Controlla che tableManager sia registrato: `console.log(window.getTableManager('trackingTableContainer'))`

**Se i dati non si caricano:**
- Controlla: `window.trackingDebug.getData()`
- Prova refresh manuale: `window.trackingDebug.refresh()`

## üìù NOTE IMPORTANTI

- Status mapping e column mapping sono mantenuti
- Il nuovo sistema √® pi√π pulito e manutenibile
- Non servono pi√π tutti i fix perch√© il TableManager gestisce tutto
- La struttura HTML esistente viene adattata dinamicamente

## üÜò SUPPORTO

Se hai problemi dopo queste modifiche:
1. Condividi gli errori della console
2. Usa `window.trackingDebug` per diagnostica
3. Verifica che tutti i moduli siano caricati correttamente

---
**VERSIONE:** v7
**DATA:** 27/01/2025
**STATO:** Pronto per implementazione