<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Tracking Spedizioni</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/solarium.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Inline styles for critical elements -->
    <style>
        /* Ensure table is visible */
        #trackingTableBody { display: table-row-group !important; }
        .table-responsive { overflow-x: auto; }
        
        /* Loading state */
        #loadingState { padding: 3rem; text-align: center; }
        #emptyState { padding: 3rem; text-align: center; }
        
        /* Bulk actions bar */
        .bulk-actions-bar {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
            z-index: 100;
        }
        
        .bulk-actions-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Status badges */
        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }
        
        .badge-success { background-color: #28a745; color: white; }
        .badge-info { background-color: #17a2b8; color: white; }
        .badge-primary { background-color: #007bff; color: white; }
        .badge-warning { background-color: #ffc107; color: #212529; }
        .badge-danger { background-color: #dc3545; color: white; }
        .badge-secondary { background-color: #6c757d; color: white; }
        
        /* Carrier badges */
        .carrier-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .carrier-badge.fedex { background: #4d148c; color: white; }
        .carrier-badge.dhl { background: #ffcc00; color: #d40511; }
        .carrier-badge.ups { background: #351c15; color: white; }
        .carrier-badge.gls { background: #0066cc; color: white; }
        .carrier-badge.tnt { background: #ff6600; color: white; }
        
        /* Button group */
        .btn-group-sm .sol-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        /* Page header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .page-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
    
    <!-- Core Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- App Configuration -->
    <script>
        window.APP_VERSION = 'v48.3-FIXED';
        window.SUPABASE_URL = 'https://gnlrmnsdmpjzitsysowq.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdubHJtbnNkbXBqeml0c3lzb3dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0NjMxMzQsImV4cCI6MjA2NTAzOTEzNH0.UoJJoDUoDXGbiWnKNN48qb9PVQWOW_X_MXqAfzTHSaA';
    </script>
</head>
<body>
    <!-- Header Component -->
    <div id="header-root"></div>

    <!-- Main Content -->
    <main class="sol-main-content">
        <div class="sol-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>Tracking Spedizioni</h1>
                <div class="page-actions">
                    <button id="btnImport" class="sol-btn sol-btn-secondary" onclick="showImportDialog()">
                        <i class="fas fa-upload"></i> Importa
                    </button>
                    <button id="btnExport" class="sol-btn sol-btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i> Esporta
                    </button>
                    <button id="btnAddTracking" class="sol-btn sol-btn-primary" onclick="showAddTrackingForm()">
                        <i class="fas fa-plus"></i> Aggiungi Tracking
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="sol-card mb-4">
                <div class="sol-card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Cerca</label>
                            <input type="text" id="searchInput" class="sol-form-control" 
                                   placeholder="Numero tracking, carrier, riferimento...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Stato</label>
                            <select id="statusFilter" class="sol-form-control">
                                <option value="">Tutti gli stati</option>
                                <option value="delivered">Consegnato</option>
                                <option value="in_transit">In transito</option>
                                <option value="arrived">Arrivato</option>
                                <option value="pending">In attesa</option>
                                <option value="exception">Eccezione</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Carrier</label>
                            <select id="carrierFilter" class="sol-form-control">
                                <option value="">Tutti i carrier</option>
                                <option value="fedex">FedEx</option>
                                <option value="dhl">DHL</option>
                                <option value="ups">UPS</option>
                                <option value="gls">GLS</option>
                                <option value="tnt">TNT</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button id="btnResetFilters" class="sol-btn sol-btn-outline w-100" onclick="resetFilters()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
                <div class="bulk-actions-content">
                    <div>
                        <span class="text-muted">Selezionati:</span>
                        <strong id="selectedCount">0</strong> tracking
                    </div>
                    <div>
                        <button class="sol-btn sol-btn-sm sol-btn-secondary" onclick="performBulkAction('refresh')">
                            <i class="fas fa-sync"></i> Aggiorna
                        </button>
                        <button class="sol-btn sol-btn-sm sol-btn-danger" onclick="performBulkAction('delete')">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Table Card -->
            <div class="sol-card">
                <div class="sol-card-body p-0">
                    <!-- Table -->
                    <div class="table-responsive">
                        <table id="trackingTable" class="sol-table">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" 
                                               onchange="toggleSelectAll(this)">
                                    </th>
                                    <th>Tracking Number</th>
                                    <th>Carrier</th>
                                    <th>Stato</th>
                                    <th>Origine</th>
                                    <th>Destinazione</th>
                                    <th>Ultimo Aggiornamento</th>
                                    <th width="120">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="trackingTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nessun tracking trovato</p>
                        <button class="sol-btn sol-btn-primary" onclick="document.getElementById('btnAddTracking').click()">
                            <i class="fas fa-plus"></i> Aggiungi il tuo primo tracking
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Caricamento...</span>
                        </div>
                        <p class="text-muted mt-2">Caricamento tracking...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

<script>
(function() {
    'use strict';
    
    console.log('üöÄ Quick fix for organizationApiKeysService');
    
    // Attendi che organizationApiKeysService sia disponibile
    const checkInterval = setInterval(() => {
        if (window.organizationApiKeysService) {
            // Aggiungi il metodo mancante immediatamente
            if (!window.organizationApiKeysService.getOrganizationApiKeys) {
                window.organizationApiKeysService.getOrganizationApiKeys = async function() {
                    console.log('üì¶ Using quick-fixed getOrganizationApiKeys');
                    if (this.getApiKeys) {
                        return await this.getApiKeys();
                    }
                    if (this.getAllKeys) {
                        return await this.getAllKeys();
                    }
                    console.warn('No API keys method available, returning empty array');
                    return [];
                };
                console.log('‚úÖ Added getOrganizationApiKeys method');
            }
            clearInterval(checkInterval);
        }
    }, 100);
    
    // Stop dopo 10 secondi
    setTimeout(() => clearInterval(checkInterval), 10000);
})();
</script>

    <!-- Load Core Modules -->
    <script type="module">
        // Import modules with versioning
        const V = window.APP_VERSION;
        
        // Import modules one by one with error handling
        (async () => {
            try {
                // Core modules
                const apiModule = await import(`/core/api-client.js?v=${V}`).catch(() => null);
                const headerModule = await import(`/core/header-component.js?v=${V}`).catch(() => null);
                const notificationModule = await import(`/core/notification-system.js?v=${V}`).catch(() => null);
                const modalModule = await import(`/core/modal-system.js?v=${V}`).catch(() => null);
                const tableModule = await import(`/core/table-manager.js?v=${V}`).catch(() => null);
                const exportModule = await import(`/core/export-manager.js?v=${V}`).catch(() => null);
                const importModule = await import(`/core/import-manager.js?v=${V}`).catch(() => null);
                
                // Supabase modules
                const supabaseClientModule = await import(`/core/services/supabase-client.js?v=${V}`).catch(() => null);
                const supabaseTrackingModule = await import(`/core/services/supabase-tracking-service.js?v=${V}`).catch(() => null);
                const orgApiKeysModule = await import(`/core/services/organization-api-keys-service.js?v=${V}`).catch(() => null);
                const trackingServiceModule = await import(`/core/services/tracking-service.js?v=${V}`).catch(() => null);
                
                // Tracking form progressive
                const trackingFormModule = await import(`/pages/tracking/tracking-form-progressive.js?v=${V}`).catch(() => null);
                
                // Expose modules globally
                if (apiModule) window.api = apiModule.default;
                if (headerModule) window.headerComponent = headerModule.default;
                if (notificationModule) window.NotificationSystem = notificationModule.default;
                if (modalModule) window.ModalSystem = modalModule.default;
                if (tableModule) window.TableManager = tableModule.default;
                if (exportModule) window.ExportManager = exportModule.default;
                if (importModule) window.ImportManager = importModule.default;
                if (supabaseClientModule) window.supabase = supabaseClientModule.supabase;
                if (supabaseTrackingModule) window.supabaseTrackingService = supabaseTrackingModule.default;
                if (orgApiKeysModule) window.organizationApiKeysService = orgApiKeysModule.default;
                if (trackingServiceModule) window.trackingService = trackingServiceModule.default;
                if (trackingFormModule) window.TrackingFormProgressive = trackingFormModule;
                
                // Log module status
                console.log('üì¶ Module status:', {
                    api: !!window.api,
                    header: !!window.headerComponent,
                    notification: !!window.NotificationSystem,
                    modal: !!window.ModalSystem,
                    table: !!window.TableManager,
                    export: !!window.ExportManager,
                    import: !!window.ImportManager,
                    supabase: !!window.supabase,
                    tracking: !!window.trackingService
                });
                
                // Initialize page
                await import(`/pages/tracking/index.js?v=${V}`);
                console.log('‚úÖ Tracking page initialized');
                
            } catch (error) {
                console.error('‚ùå Error during initialization:', error);
                
                // Show error to user
                document.getElementById('loadingState').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Errore di caricamento</strong><br>
                        Si √® verificato un errore nel caricamento della pagina.<br>
                        <small>${error.message}</small><br>
                        <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">
                            <i class="fas fa-redo"></i> Ricarica
                        </button>
                    </div>
                `;
            }
        })();
    </script>

    <!-- Legacy Scripts -->
    <script src="/core/auth.js"></script>
    <script src="/core/auth-init.js"></script>
    
    <!-- NUOVO: Fix Script per inizializzazione -->
    <script src="/pages/tracking/tracking-init-fix.js"></script>
    
    <script src="/pages/tracking/tracking-complete-fix.js"></script>

    <!-- Fallback functions -->
    <script>
        // Fallback functions in case modules don't load
        if (!window.refreshTracking) {
            window.refreshTracking = function(id) {
                console.log('Refreshing tracking:', id);
                alert('Funzione non disponibile al momento');
            };
        }
        
        if (!window.viewDetails) {
            window.viewDetails = function(id) {
                console.log('Viewing details:', id);
                alert('Funzione non disponibile al momento');
            };
        }
        
        if (!window.deleteTracking) {
            window.deleteTracking = function(id) {
                console.log('Deleting tracking:', id);
                if (confirm('Eliminare questo tracking?')) {
                    // Remove from localStorage
                    const stored = localStorage.getItem('trackings');
                    if (stored) {
                        const trackings = JSON.parse(stored);
                        const filtered = trackings.filter(t => t.id !== id);
                        localStorage.setItem('trackings', JSON.stringify(filtered));
                        location.reload();
                    }
                }
            };
        }
        
        if (!window.resetFilters) {
            window.resetFilters = function() {
                document.getElementById('searchInput').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('carrierFilter').value = '';
                if (window.applyFilters) window.applyFilters();
            };
        }
    </script>

<script>
// FIX COMBINATO COMPLETO - TUTTI I FIX IN UNO
(function() {
    'use strict';
    
    console.log('üéØ SINGLE FIX: Starting definitive tracking table fix...');
    
    // 1. DISABILITA TABLEMANAGER
    // Il problema principale √® che TableManager sta sovrascrivendo il contenuto
    if (window.trackingTable && window.trackingTable.render) {
        console.log('üõë Disabling TableManager render...');
        window.trackingTable.render = function() {
            console.log('TableManager render blocked');
        };
    }
    
    // 2. FUNZIONE DI RENDER DEFINITIVA
    function renderTrackingTableDefinitive() {
        console.log('üé® Rendering tracking table (definitive)...');
        
        // Trova o crea struttura tabella
        let table = document.getElementById('trackingTable');
        if (!table) {
            console.error('‚ùå Table not found!');
            return;
        }
        
        // Assicurati che ci sia il tbody
        let tbody = table.querySelector('tbody');
        if (!tbody) {
            tbody = document.createElement('tbody');
            tbody.id = 'trackingTableBody';
            table.appendChild(tbody);
        }
        
        // Verifica dati
        const data = window.filteredTrackings || window.trackings || [];
        console.log(`üìä Rendering ${data.length} trackings`);
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nessun tracking trovato</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Render header se non esiste
        let thead = table.querySelector('thead');
        if (!thead || thead.children.length === 0) {
            thead = thead || document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="selectAll"></th>
                    <th>Tracking Number</th>
                    <th>Tipo</th>
                    <th>Stato</th>
                    <th>Carrier</th>
                    <th>Origine</th>
                    <th>Destinazione</th>
                    <th>Azioni</th>
                </tr>
            `;
            if (!table.querySelector('thead')) {
                table.insertBefore(thead, tbody);
            }
        }
        
        // Render righe
        tbody.innerHTML = data.map(tracking => {
            const statusClass = {
                'delivered': 'success',
                'in_transit': 'primary',
                'pending': 'warning',
                'exception': 'danger'
            }[tracking.status?.toLowerCase()] || 'secondary';
            
            return `
                <tr data-id="${tracking.id}">
                    <td>
                        <input type="checkbox" class="form-check-input row-select" data-id="${tracking.id}">
                    </td>
                    <td>
                        <strong>${tracking.tracking_number || '-'}</strong>
                        ${tracking.reference ? `<br><small class="text-muted">${tracking.reference}</small>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-secondary">${tracking.tracking_type || 'container'}</span>
                    </td>
                    <td>
                        <span class="badge bg-${statusClass}">${tracking.status || 'pending'}</span>
                    </td>
                    <td>${tracking.carrier || '-'}</td>
                    <td>${tracking.origin_name || '-'}</td>
                    <td>${tracking.destination_name || '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-primary" onclick="refreshTracking('${tracking.id}')" title="Aggiorna">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button type="button" class="btn btn-info" onclick="viewDetails('${tracking.id}')" title="Dettagli">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-danger" onclick="actualDeleteTracking('${tracking.id}')" title="Elimina">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Assicurati che la tabella sia visibile
        table.style.display = '';
        tbody.style.display = '';
        
        // Nascondi empty state se esiste
        const emptyState = document.getElementById('emptyState');
        if (emptyState) emptyState.style.display = 'none';
        
        console.log('‚úÖ Table rendered successfully with', data.length, 'rows');
    }
    
    // 3. DELETE FUNCTION CHE FUNZIONA
    window.actualDeleteTracking = async function(id) {
        if (!confirm('Eliminare questo tracking?')) return;
        
        try {
            // Elimina da Supabase
            if (window.supabaseTrackingService?.deleteTracking) {
                await window.supabaseTrackingService.deleteTracking(id);
            }
            
            // Rimuovi dai dati locali
            window.trackings = window.trackings.filter(t => t.id !== id);
            window.filteredTrackings = window.filteredTrackings.filter(t => t.id !== id);
            
            // Re-render
            renderTrackingTableDefinitive();
            
            // Notifica
            if (window.NotificationSystem) {
                window.NotificationSystem.success('Tracking eliminato');
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('Errore durante l\'eliminazione');
        }
    };
    
    // 4. AGGIUNGI PULSANTE COLONNE
    function addColumnSelectorButton() {
        const container = document.querySelector('.d-flex.gap-2.mb-3');
        if (!container || document.getElementById('columnSelectorBtn')) return;
        
        const btn = document.createElement('button');
        btn.id = 'columnSelectorBtn';
        btn.className = 'btn btn-outline-secondary';
        btn.innerHTML = '<i class="fas fa-columns"></i> Gestisci Colonne';
        btn.onclick = () => alert('Gestione colonne in arrivo!');
        
        // Inserisci prima del pulsante Importa
        const importBtn = container.querySelector('[onclick*="showImportDialog"]');
        if (importBtn) {
            container.insertBefore(btn, importBtn);
        } else {
            container.insertBefore(btn, container.firstChild);
        }
        
        console.log('‚úÖ Column selector button added');
    }
    
    // 5. OVERRIDE TUTTI I RENDER
    window.renderTable = renderTrackingTableDefinitive;
    
    // Se esiste il render originale, sostituiscilo
    if (window.originalRenderTable) {
        window.originalRenderTable = renderTrackingTableDefinitive;
    }
    
    // 6. STILI PER VISIBILIT√Ä
    const style = document.createElement('style');
    style.textContent = `
        #trackingTable {
            display: table !important;
            width: 100% !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #trackingTableBody {
            display: table-row-group !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #trackingTable thead {
            background-color: #f8f9fa;
        }
        
        #trackingTable th {
            padding: 12px;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        #trackingTable td {
            padding: 12px;
            vertical-align: middle;
        }
        
        #trackingTable tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        
        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    `;
    document.head.appendChild(style);
    
    // 7. INIZIALIZZAZIONE FORZATA
    async function forceInit() {
        console.log('üöÄ Force initializing...');
        
        // Aggiungi pulsante colonne
        addColumnSelectorButton();
        
        // Attendi che i dati siano caricati
        let attempts = 0;
        const checkData = setInterval(() => {
            if (window.trackings && window.trackings.length > 0) {
                clearInterval(checkData);
                console.log('‚úÖ Data found, rendering...');
                
                // Imposta filteredTrackings se vuoto
                if (!window.filteredTrackings || window.filteredTrackings.length === 0) {
                    window.filteredTrackings = window.trackings;
                }
                
                // Render forzato
                renderTrackingTableDefinitive();
                
                // Previeni future modifiche
                setTimeout(() => {
                    const tbody = document.getElementById('trackingTableBody');
                    if (tbody && tbody.children.length === 0 && window.trackings.length > 0) {
                        console.log('‚ö†Ô∏è Table was cleared, re-rendering...');
                        renderTrackingTableDefinitive();
                    }
                }, 1000);
                
            } else if (attempts > 30) {
                clearInterval(checkData);
                console.log('‚ùå No data after 15 seconds');
            }
            attempts++;
        }, 500);
    }
    
    // 8. COMANDI DEBUG
    window.singleFix = {
        render: renderTrackingTableDefinitive,
        showData: () => {
            console.log('Trackings:', window.trackings);
            console.log('Filtered:', window.filteredTrackings);
            console.log('Tbody rows:', document.querySelectorAll('#trackingTableBody tr').length);
        },
        forceVisible: () => {
            const table = document.getElementById('trackingTable');
            const tbody = document.getElementById('trackingTableBody');
            if (table) {
                table.style.cssText = 'display: table !important; visibility: visible !important; opacity: 1 !important;';
            }
            if (tbody) {
                tbody.style.cssText = 'display: table-row-group !important; visibility: visible !important; opacity: 1 !important;';
            }
            console.log('‚úÖ Forced visibility');
        }
    };
    
    // Avvia inizializzazione
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceInit);
    } else {
        forceInit();
    }
    
    console.log('‚úÖ SINGLE FIX LOADED');
    console.log('Commands: singleFix.render(), singleFix.showData(), singleFix.forceVisible()');
    
})();
</script>

<script>
// Fix permanente per tabella tracking - evita duplicati headers e empty states
(function() {
    'use strict';
    
    // Attendi che il DOM sia pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyPermanentFix);
    } else {
        applyPermanentFix();
    }
    
    function applyPermanentFix() {
        console.log('üõ°Ô∏è Applying permanent tracking table fix...');
        
        // 1. CSS Fix permanente
        const styleId = 'tracking-permanent-fix-styles';
        if (!document.getElementById(styleId)) {
            const style = document.createElement('style');
            style.id = styleId;
            style.textContent = `
                /* Fix permanente stili tabella */
                
                /* Nascondi empty states */
                .sol-table-empty,
                .empty-state,
                .no-data {
                    display: none !important;
                }
                
                /* Forza visibilit√† tabella */
                #trackingTable {
                    display: table !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    width: 100% !important;
                    border-collapse: collapse;
                }
                
                /* Headers corretti */
                #trackingTable > thead {
                    display: table-header-group !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    background: #f9fafb !important;
                }
                
                #trackingTable > thead > tr > th {
                    padding: 14px 20px !important;
                    font-weight: 700 !important;
                    color: #111827 !important;
                    font-size: 0.75rem !important;
                    text-transform: uppercase !important;
                    letter-spacing: 0.05em !important;
                    border-bottom: 2px solid #e5e7eb !important;
                }
                
                /* Nascondi header ultima colonna */
                #trackingTable > thead > tr > th:last-child {
                    visibility: hidden !important;
                }
                
                /* Card filtri laterali */
                .tracking-filters {
                    background: white !important;
                    border-radius: 12px !important;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
                    padding: 1.5rem !important;
                    margin-bottom: 1.5rem !important;
                }
                
                /* Titolo CERCA maiuscolo */
                .tracking-filters > *:first-child:not(input):not(select) {
                    font-size: 0.875rem !important;
                    font-weight: 700 !important;
                    text-transform: uppercase !important;
                    letter-spacing: 0.05em !important;
                    color: #111827 !important;
                }
                
                /* Nascondi controlli sotto tabella */
                .sol-table-controls,
                .sol-table-pagination {
                    display: none !important;
                }
                
                /* Nascondi possibili headers duplicati */
                thead:not(#trackingTable > thead) {
                    display: none !important;
                }
            `;
            document.head.appendChild(style);
        }
        
        // 2. Blocca renderEmpty del TableManager
        if (window.trackingTable) {
            window.trackingTable.renderEmpty = function() {
                console.log('‚ùå renderEmpty blocked');
                return '';
            };
            window.trackingTable.renderLoading = function() {
                console.log('‚ùå renderLoading blocked');
                return '';
            };
        }
        
        // 3. Pulisci headers duplicati
        function cleanupDuplicateHeaders() {
            const allTheads = document.querySelectorAll('thead');
            const mainTable = document.getElementById('trackingTable');
            let mainThead = null;
            
            allTheads.forEach(thead => {
                if (mainTable && mainTable.contains(thead)) {
                    if (!mainThead) {
                        mainThead = thead;
                    } else {
                        thead.remove();
                    }
                } else {
                    thead.remove();
                }
            });
        }
        
        // 4. Assicura headers corretti
        function ensureCorrectHeaders() {
            const table = document.getElementById('trackingTable');
            if (!table) return;
            
            cleanupDuplicateHeaders();
            
            let thead = table.querySelector('thead');
            if (!thead || thead.children.length === 0) {
                if (!thead) {
                    thead = document.createElement('thead');
                    table.insertBefore(thead, table.firstChild);
                }
                
                thead.innerHTML = `
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAllTracking">
                        </th>
                        <th>TRACKING NUMBER</th>
                        <th>CORRIERE</th>
                        <th>STATO</th>
                        <th>ORIGINE</th>
                        <th>DESTINAZIONE</th>
                        <th>DATA CREAZIONE</th>
                        <th style="width: 120px;"></th>
                    </tr>
                `;
            }
        }
        
        // 5. Rimuovi empty states
        function removeEmptyStates() {
            document.querySelectorAll('.sol-table-empty, .empty-state, .no-data').forEach(el => {
                el.remove();
            });
        }
        
        // 6. Fix titolo CERCA
        function fixCercaTitle() {
            const cercaElements = Array.from(document.querySelectorAll('*')).filter(el => 
                el.textContent.trim() === 'Cerca' && 
                !el.querySelector('*') && 
                el.tagName !== 'BUTTON'
            );
            
            cercaElements.forEach(el => {
                el.textContent = 'CERCA';
            });
        }
        
        // 7. Observer per prevenire modifiche future
        const observer = new MutationObserver((mutations) => {
            let needsCleanup = false;
            
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) {
                        if (node.tagName === 'THEAD' || 
                            (node.classList && (node.classList.contains('sol-table-empty') || 
                                              node.classList.contains('empty-state')))) {
                            needsCleanup = true;
                        }
                    }
                });
            });
            
            if (needsCleanup) {
                setTimeout(() => {
                    cleanupDuplicateHeaders();
                    removeEmptyStates();
                }, 10);
            }
        });
        
        // Osserva il body per modifiche
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // 8. Applica fix iniziale
        setTimeout(() => {
            ensureCorrectHeaders();
            removeEmptyStates();
            fixCercaTitle();
        }, 500);
        
        // 9. Riapplica periodicamente per i primi 5 secondi
        let fixCount = 0;
        const fixInterval = setInterval(() => {
            ensureCorrectHeaders();
            removeEmptyStates();
            fixCount++;
            
            if (fixCount > 10) {
                clearInterval(fixInterval);
            }
        }, 500);
        
        console.log('‚úÖ Permanent tracking table fix applied');
    }
})();
</script>

</body>
</html>