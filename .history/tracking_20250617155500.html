<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Tracking Spedizioni</title>
    
    <!-- ===== FIX 1: MODAL SYSTEM DEFINITIVO - CARICAMENTO PRIORITARIO ===== -->
    <script>
    // üîß FORCE CLEANUP MODAL SYSTEMS - PRIMA DI TUTTO
    (function() {
        console.log('üßπ [PreInit] Cleaning up existing modal systems...');
        
        // Remove existing modal elements
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.sol-modal-overlay, [id^="modal-"]').forEach(el => el.remove());
        });
        
        // Clear existing global references
        if (window.ModalSystem) delete window.ModalSystem;
        if (window.modalSystem) delete window.modalSystem;
        
        console.log('‚úÖ [PreInit] Modal cleanup completed');
    })();
    </script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    
    <!-- Core CSS -->
    <link rel="stylesheet" href="/assets/css/solarium.css">
    <link rel="stylesheet" href="/assets/css/timeline.css">
    <link rel="stylesheet" href="/pages/tracking/tracking-table.css">
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ===== STEP 1: EXTERNAL LIBRARIES (MUST BE FIRST) ===== -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- ===== STEP 2: CORE MODAL SYSTEM (LEGACY LOADING) ===== -->
    <script src="/core/modal-system.js"></script>
    
    <!-- ===== STEP 3: MOCK API SETUP (THIRD) ===== -->
    <script>
    // Override fetch globalmente PRIMA che venga usato
    window.FORCE_MOCK_API = true;
    
    if (window.FORCE_MOCK_API) {
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            
            // Intercetta chiamate a Netlify functions
            if (url.includes('/.netlify/functions/')) {
                console.log('[ForceMock] Intercepting:', url);
                
                // Mock per notifications
                if (url.includes('notifications')) {
                    return Promise.resolve({
                        ok: true,
                        status: 200,
                        headers: new Headers({'content-type': 'application/json'}),
                        json: () => Promise.resolve({
                            notifications: [
                                {
                                    id: 1,
                                    type: 'shipment',
                                    title: 'Spedizione in arrivo',
                                    message: 'Container MSKU1234567 arriver√† domani',
                                    read: false,
                                    created_at: new Date().toISOString()
                                },
                                {
                                    id: 2,
                                    type: 'warning',
                                    title: 'Ritardo spedizione',
                                    message: 'BL MSCU7654321 √® in ritardo di 2 giorni',
                                    read: false,
                                    created_at: new Date(Date.now() - 86400000).toISOString()
                                }
                            ],
                            unread_count: 2,
                            total: 2
                        })
                    });
                }
                
                // Mock per GET trackings
                if (url.includes('get-trackings') && args[1]?.method !== 'POST') {
                    return Promise.resolve({
                        ok: true,
                        status: 200,
                        headers: new Headers({'content-type': 'application/json'}),
                        json: () => {
                            // Combina mock data con localStorage
                            const savedTrackings = JSON.parse(localStorage.getItem('mockTrackings') || '[]');
                            const mockTrackings = window.MockData?.generateTrackings()?.trackings || [];
                            
                            // Merge: saved + mock (evita duplicati per ID)
                            const seenIds = new Set(savedTrackings.map(t => t.id));
                            const allTrackings = [
                                ...savedTrackings,
                                ...mockTrackings.filter(t => !seenIds.has(t.id))
                            ];
                            
                            return Promise.resolve({
                                trackings: allTrackings,
                                stats: {
                                    total: allTrackings.length,
                                    in_transit: allTrackings.filter(t => t.status === 'in_transit').length,
                                    out_for_delivery: allTrackings.filter(t => t.status === 'out_for_delivery').length,
                                    delivered: allTrackings.filter(t => t.status === 'delivered').length,
                                    delayed: allTrackings.filter(t => t.status === 'delayed').length,
                                    registered: allTrackings.filter(t => t.status === 'registered').length
                                }
                            });
                        }
                    });
                }
                
                // Mock per POST add-tracking
                if (url.includes('add-tracking')) {
                    // Parse body
                    let bodyData;
                    try {
                        bodyData = JSON.parse(args[1].body);
                    } catch (e) {
                        bodyData = {};
                    }
                    
                    // Recupera trackings esistenti
                    const mockTrackings = JSON.parse(localStorage.getItem('mockTrackings') || '[]');
                    
                    // Crea nuovo tracking
                    const newTracking = {
                        id: Date.now(),
                        ...bodyData,
                        status: bodyData.status || 'registered',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString(),
                        last_event_date: new Date().toISOString(),
                        last_event_location: 'Registered',
                        user_id: 'mock-user'
                    };
                    
                    // Salva
                    mockTrackings.push(newTracking);
                    localStorage.setItem('mockTrackings', JSON.stringify(mockTrackings));
                    
                    console.log('[Mock] Tracking added:', newTracking);
                    
                    return Promise.resolve({
                        ok: true,
                        status: 200,
                        headers: new Headers({'content-type': 'application/json'}),
                        json: () => Promise.resolve({ 
                            success: true, 
                            data: newTracking 
                        })
                    });
                }
                
                // Mock per POST import-trackings (batch)
                if (url.includes('import-trackings')) {
                    let bodyData;
                    try {
                        bodyData = JSON.parse(args[1].body);
                    } catch (e) {
                        bodyData = { trackings: [] };
                    }
                    
                    const mockTrackings = JSON.parse(localStorage.getItem('mockTrackings') || '[]');
                    const imported = [];
                    
                    // Import tutti i tracking
                    bodyData.trackings?.forEach(tracking => {
                        const newTracking = {
                            id: Date.now() + Math.random(),
                            ...tracking,
                            status: tracking.status || 'registered',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString(),
                            user_id: 'mock-user'
                        };
                        mockTrackings.push(newTracking);
                        imported.push(newTracking);
                    });
                    
                    localStorage.setItem('mockTrackings', JSON.stringify(mockTrackings));
                    
                    console.log('[Mock] Batch import:', imported.length, 'trackings');
                    
                    return Promise.resolve({
                        ok: true,
                        status: 200,
                        headers: new Headers({'content-type': 'application/json'}),
                        json: () => Promise.resolve({ 
                            success: true,
                            result: {
                                imported: imported.length,
                                updated: 0,
                                skipped: 0,
                                errors: 0
                            },
                            data: imported
                        })
                    });
                }
                
                // Mock per POST update-tracking
                if (url.includes('update-tracking')) {
                    return Promise.resolve({
                        ok: true,
                        status: 200,
                        headers: new Headers({'content-type': 'application/json'}),
                        json: () => Promise.resolve({ success: true, message: 'Updated' })
                    });
                }
                
                // Mock per POST delete-tracking
                if (url.includes('delete-tracking')) {
                    let bodyData;
                    try {
                        bodyData = JSON.parse(args[1].body);
                    } catch (e) {
                        bodyData = {};
                    }
                    
                    if (bodyData.trackingId) {
                        const mockTrackings = JSON.parse(localStorage.getItem('mockTrackings') || '[]');
                        const filtered = mockTrackings.filter(t => t.id !== bodyData.trackingId);
                        localStorage.setItem('mockTrackings', JSON.stringify(filtered));
                        
                        console.log('[Mock] Tracking deleted:', bodyData.trackingId);
                    }
                    
                    return Promise.resolve({
                        ok: true,
                        status: 200,
                        headers: new Headers({'content-type': 'application/json'}),
                        json: () => Promise.resolve({ success: true })
                    });
                }
                
                // Default response per altre chiamate
                return Promise.resolve({
                    ok: true,
                    status: 200,
                    headers: new Headers({'content-type': 'application/json'}),
                    json: () => Promise.resolve({ success: true, data: {} })
                });
            }
            
            // Passa attraverso per URL non-Netlify
            return originalFetch.apply(this, args);
        };
        
        console.log('[ForceMock] Complete mock interceptor installed');
    }
    </script>
    
    <!-- ===== STEP 4: LEGACY CORE SCRIPTS (BEFORE ES6) ===== -->
    <script src="/core/auth.js"></script>
    <script src="/core/auth-init.js"></script>
    <script src="/core/mock-data.js"></script>
    <script src="/core/import-manager.js"></script>
    <script src="/core/export-manager.js"></script>
    
    <!-- ===== STEP 5: SIMPLIFIED LOADING (NO ES6 CONFLICTS) ===== -->
    <script>
    // Simplified approach - avoid all ES6 module conflicts
    function initializeBasicComponents() {
        console.log('üîß [BASIC] Initializing basic components...');
        
        // Create basic API client
        window.api = window.api || {
            get: (url) => fetch(url).then(r => r.json()).catch(() => ({})),
            post: (url, data) => fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).catch(() => ({}))
        };
        
        // Create basic header component
        window.headerComponent = window.headerComponent || {
            init: async () => {
                console.log('üîß [BASIC] Header init (basic version)');
                const header = document.createElement('header');
                header.className = 'sol-header';
                header.innerHTML = `
                    <div class="sol-header-content">
                        <div class="sol-header-left">
                            <a href="/" class="sol-logo">
                                <div class="sol-logo-icon">SCH</div>
                                <span class="sol-logo-text">Supply Chain Hub</span>
                            </a>
                        </div>
                        <div class="sol-header-right">
                            <span class="user-avatar">U</span>
                        </div>
                    </div>
                `;
                document.body.insertBefore(header, document.body.firstChild);
                console.log('‚úÖ [BASIC] Basic header created');
            }
        };
        
        // Create notification system if not exists
        if (!window.NotificationSystem) {
            const showNotification = (message, type) => {
                // Create notification container if it doesn't exist
                let container = document.getElementById('notification-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'notification-container';
                    container.className = 'sol-notifications';
                    document.body.appendChild(container);
                }
                
                // Create notification
                const notification = document.createElement('div');
                notification.className = `sol-notification ${type} show`;
                notification.innerHTML = `
                    <div class="sol-notification-icon">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                    </div>
                    <div class="sol-notification-content">
                        <div class="sol-notification-message">${message}</div>
                    </div>
                    <button class="sol-notification-close" onclick="this.parentElement.remove()">√ó</button>
                `;
                
                container.appendChild(notification);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            };
            
            window.NotificationSystem = {
                success: (msg, opts = {}) => {
                    console.log('‚úÖ Success:', msg);
                    if (opts.subtitle) console.log('  ', opts.subtitle);
                    showNotification(msg, 'success');
                },
                error: (msg) => {
                    console.error('‚ùå Error:', msg);
                    showNotification(msg, 'error');
                },
                info: (msg, opts = {}) => {
                    console.info('‚ÑπÔ∏è Info:', msg);
                    showNotification(msg, 'info');
                },
                warning: (msg) => {
                    console.warn('‚ö†Ô∏è Warning:', msg);
                    showNotification(msg, 'warning');
                },
                dismiss: (id) => {
                    const notification = document.getElementById(id);
                    if (notification) notification.remove();
                }
            };
        }
        
        // Create basic Table Manager if not exists
        if (!window.TableManager) {
            window.TableManager = class BasicTableManager {
                constructor(containerId, options = {}) {
                    this.container = document.getElementById(containerId);
                    this.options = options;
                    this.data = [];
                    this.isLoading = false;
                    
                    console.log('üîß [BASIC] Basic TableManager created for:', containerId);
                }
                
                setData(data) {
                    this.data = data || [];
                    console.log('üìä [BASIC] Table data set:', this.data.length, 'items');
                    this.render();
                }
                
                loading(state) {
                    this.isLoading = state;
                    if (state) {
                        console.log('‚è≥ [BASIC] Table loading...');
                    } else {
                        console.log('‚úÖ [BASIC] Table loading complete');
                    }
                    this.render();
                }
                
                render() {
                    if (!this.container) {
                        console.warn('‚ö†Ô∏è [BASIC] Table container not found');
                        return;
                    }
                    
                    if (this.isLoading) {
                        this.container.innerHTML = '<div class="loading">Caricamento...</div>';
                        return;
                    }
                    
                    if (this.data.length === 0) {
                        this.container.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <i class="fas fa-box" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                <p>Nessun tracking attivo</p>
                                <p style="font-size: 0.875rem;">Aggiungi il tuo primo tracking per iniziare</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Create basic table
                    let html = `
                        <table class="data-table sol-table">
                            <thead>
                                <tr>
                                    <th>Tracking Number</th>
                                    <th>Tipo</th>
                                    <th>Vettore</th>
                                    <th>Stato</th>
                                    <th>Origine</th>
                                    <th>Destinazione</th>
                                    <th>ETA</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    this.data.forEach(row => {
                        const trackingNumber = row.tracking_number || '-';
                        const type = row.tracking_type || 'container';
                        const carrier = row.carrier_code || '-';
                        const status = row.status || 'registered';
                        const origin = row.origin_port || '-';
                        const destination = row.destination_port || '-';
                        const eta = row.eta ? new Date(row.eta).toLocaleDateString('it-IT') : '-';
                        
                        html += `
                            <tr>
                                <td><strong>${trackingNumber}</strong></td>
                                <td><span class="sol-badge badge-info">${type.toUpperCase()}</span></td>
                                <td>${carrier}</td>
                                <td><span class="sol-badge badge-secondary">${status}</span></td>
                                <td>${origin}</td>
                                <td>${destination}</td>
                                <td>${eta}</td>
                                <td>
                                    <button class="sol-btn-icon" onclick="refreshTracking('${row.id}')" title="Aggiorna">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="sol-btn-icon" onclick="viewTimeline('${row.id}')" title="Timeline">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    <button class="sol-btn-icon sol-text-danger" onclick="deleteTracking('${row.id}')" title="Elimina">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    this.container.innerHTML = html;
                }
            };
        }
        
        // Create basic tracking service
        window.trackingService = window.trackingService || {
            initialize: () => {
                console.log('üîß [BASIC] Tracking service initialized (basic version)');
                return Promise.resolve();
            },
            track: () => Promise.resolve({ success: false }),
            refresh: () => Promise.resolve({ success: false })
        };
        
        // Initialize header
        setTimeout(() => {
            if (window.headerComponent && !document.querySelector('.sol-header')) {
                window.headerComponent.init();
            }
        }, 100);
        
        console.log('‚úÖ [BASIC] All basic components initialized');
        return true;
    }
    
    // Initialize immediately
    initializeBasicComponents();
    </script>
    
    <!-- ===== STEP 6: PAGE SPECIFIC SCRIPT (AFTER MODULES) ===== -->
    <script src="/pages/tracking/index.js"></script>
    
    <!-- ===== STEP 7: INITIALIZATION WITH BASIC COMPONENTS ===== -->
    <script>
    // Initialization with basic components only
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ [Tracking HTML] DOMContentLoaded fired');
        
        // Wait for basic dependencies to load
        let attempts = 0;
        const maxAttempts = 20; // 2 secondi
        
        const waitForDependencies = setInterval(async () => {
            attempts++;
            
            // Check EXTERNAL libraries
            const hasPapa = typeof Papa !== 'undefined';
            const hasXLSX = typeof XLSX !== 'undefined';
            
            // Check CORE modules (now basic versions)
            const hasTableManager = !!window.TableManager;
            const hasModalSystem = !!window.ModalSystem;
            const hasNotificationSystem = !!window.NotificationSystem;
            const hasImportManager = !!window.ImportManager;
            
            // Check PAGE modules
            const hasTrackingInit = !!window.trackingInit;
            
            console.log(`üì¶ [Tracking] Dependency check ${attempts}/${maxAttempts}:`, {
                Papa: hasPapa,
                XLSX: hasXLSX,
                TableManager: hasTableManager,
                ModalSystem: hasModalSystem,
                NotificationSystem: hasNotificationSystem,
                ImportManager: hasImportManager,
                trackingInit: hasTrackingInit
            });
            
            // ALL dependencies must be ready
            const allReady = hasPapa && hasXLSX && hasTableManager && hasModalSystem && 
                           hasNotificationSystem && hasImportManager && hasTrackingInit;
            
            if (allReady) {
                clearInterval(waitForDependencies);
                
                console.log('‚úÖ [Tracking] ALL dependencies ready, starting trackingInit...');
                
                try {
                    await window.trackingInit();
                    console.log('‚úÖ [Tracking] Page initialization complete!');
                    
                    // Show success notification
                    if (window.NotificationSystem) {
                        window.NotificationSystem.success('Sistema di tracking inizializzato correttamente!');
                    }
                    
                } catch (error) {
                    console.error('‚ùå [Tracking] Initialization failed:', error);
                    if (window.NotificationSystem) {
                        window.NotificationSystem.error('Errore inizializzazione: ' + error.message);
                    }
                }
                
            } else if (attempts >= maxAttempts) {
                clearInterval(waitForDependencies);
                console.error('‚ùå [Tracking] Dependency loading timeout after', maxAttempts * 100, 'ms');
                console.log('Missing dependencies:', {
                    Papa: !hasPapa,
                    XLSX: !hasXLSX,
                    TableManager: !hasTableManager,
                    ModalSystem: !hasModalSystem, 
                    NotificationSystem: !hasNotificationSystem,
                    ImportManager: !hasImportManager,
                    trackingInit: !hasTrackingInit
                });
                
                // Try to continue anyway with what we have
                if (window.trackingInit) {
                    console.log('‚ö†Ô∏è [Tracking] Attempting partial initialization...');
                    try {
                        await window.trackingInit();
                        if (window.NotificationSystem) {
                            window.NotificationSystem.warning('Sistema inizializzato in modalit√† limitata');
                        }
                    } catch (error) {
                        console.error('‚ùå [Tracking] Partial initialization failed:', error);
                        if (window.NotificationSystem) {
                            window.NotificationSystem.error('Errore inizializzazione: ' + error.message);
                        }
                    }
                } else {
                    if (window.NotificationSystem) {
                        window.NotificationSystem.error('Impossibile inizializzare il sistema di tracking');
                    }
                }
            }
        }, 100); // Check every 100ms
    });
    </script>
</head>
<body>
    <!-- Header verr√† montato automaticamente da header-component.js -->
    
    <!-- Main Content -->
    <main class="sol-main-content" id="mainContent">
        <!-- Page Header -->
        <div class="sol-page-header">
            <div>
                <h1 class="sol-page-title">Tracking Spedizioni</h1>
                <p class="sol-page-subtitle">Monitora in tempo reale container, BL e spedizioni aeree</p>
            </div>
            <div class="sol-page-actions">
                <button class="sol-btn sol-btn-glass" id="refreshAllBtn">
                    <i class="fas fa-sync-alt"></i>
                    <span>Aggiorna Tutto</span>
                </button>
                <button class="sol-btn sol-btn-glass" id="exportPdfBtn">
                    <i class="fas fa-file-pdf"></i>
                    <span>Export PDF</span>
                </button>
                <button class="sol-btn sol-btn-glass" id="exportExcelBtn">
                    <i class="fas fa-file-excel"></i>
                    <span>Export Excel</span>
                </button>
                <button class="sol-btn sol-btn-glass" onclick="clearMockData()">
                    <i class="fas fa-trash"></i>
                    <span>Clear Data</span>
                </button>
                <!-- ===== FIX 4: TEST MODAL BUTTON ===== -->
                <button class="sol-btn sol-btn-glass" onclick="testModalSystem()">
                    <i class="fas fa-flask"></i>
                    <span>Test Modals</span>
                </button>
                <!-- ===== DEBUG BUTTONS ===== -->
                <button class="sol-btn sol-btn-glass" onclick="debugTrackingSystem()" title="Debug System">
                    <i class="fas fa-bug"></i>
                    <span>Debug</span>
                </button>
                <button class="sol-btn sol-btn-primary" id="addTrackingBtn">
                    <i class="fas fa-plus"></i>
                    <span>Aggiungi Tracking</span>
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="sol-stats-grid" id="statsGrid">
            <!-- Populated by JS -->
        </div>

        <!-- Tracking List -->
        <div class="sol-card">
            <div class="sol-card-header">
                <h3 class="sol-card-title">Lista Tracking Attivi</h3>
                <div class="sol-card-filters">
                    <select class="sol-select" id="statusFilter">
                        <option value="">Tutti gli stati</option>
                        <option value="registered">Registrato</option>
                        <option value="in_transit">In Transito</option>
                        <option value="arrived">Arrivato</option>
                        <option value="customs_cleared">Sdoganato</option>
                        <option value="out_for_delivery">In Consegna</option>
                        <option value="delivered">Consegnato</option>
                        <option value="delayed">In Ritardo</option>
                        <option value="exception">Eccezione</option>
                    </select>
                    <select class="sol-select" id="typeFilter">
                        <option value="">Tutti i tipi</option>
                        <option value="container">Container</option>
                        <option value="bl">Bill of Lading</option>
                        <option value="awb">Air Waybill</option>
                        <option value="parcel">Parcel</option>
                    </select>
                    
                    <button class="sol-btn sol-btn-glass" onclick="showColumnManager()">
                        <i class="fas fa-columns"></i> Gestione Colonne
                    </button>
                    
                    <!-- View Toggle Button -->
                    <button type="button" class="sol-btn-toggle-view" id="toggleView" data-view="table">
                        <i class="fas fa-table"></i>
                        <span class="toggle-text">Vista Tabella</span>
                    </button>
                </div>
            </div>
            
            <div id="trackingTableContainer">
                <!-- Table Manager will render here -->
            </div>
            
            <!-- Timeline Container (nascosto di default) -->
            <div id="timelineContainer" class="sol-timeline-container" style="display: none;">
                <div class="sol-timeline-header">
                    <div class="sol-timeline-legend">
                        <span class="legend-item">
                            <i class="fas fa-circle text-info"></i> In Transit
                        </span>
                        <span class="legend-item">
                            <i class="fas fa-circle text-success"></i> Consegnato
                        </span>
                        <span class="legend-item">
                            <i class="fas fa-circle text-warning"></i> In Ritardo
                        </span>
                        <span class="legend-item">
                            <i class="fas fa-circle text-danger"></i> Problema
                        </span>
                    </div>
                </div>
                
                <div id="timelineContent" class="sol-timeline-content">
                    <!-- Timeline items verranno inseriti qui dinamicamente -->
                </div>
            </div>
        </div>
    </main>

    <!-- Timeline Enhancement Script -->
    <script>
    // Timeline View Functions
    (function() {
        let currentView = 'table';
        
        // Initialize view toggle
        function initViewToggle() {
            const toggleBtn = document.getElementById('toggleView');
            const tableContainer = document.getElementById('trackingTableContainer');
            const timelineContainer = document.getElementById('timelineContainer');
            
            if (!toggleBtn) return;
            
            toggleBtn.addEventListener('click', function() {
                currentView = this.dataset.view === 'table' ? 'timeline' : 'table';
                
                if (currentView === 'timeline') {
                    // Switch to Timeline View
                    tableContainer.style.display = 'none';
                    timelineContainer.style.display = 'block';
                    
                    this.dataset.view = 'timeline';
                    this.classList.add('timeline-active');
                    this.innerHTML = '<i class="fas fa-stream"></i> <span class="toggle-text">Vista Timeline</span>';
                    
                    // Load timeline view
                    loadTimelineView();
                    
                } else {
                    // Switch back to Table View
                    tableContainer.style.display = 'block';
                    timelineContainer.style.display = 'none';
                    
                    this.dataset.view = 'table';
                    this.classList.remove('timeline-active');
                    this.innerHTML = '<i class="fas fa-table"></i> <span class="toggle-text">Vista Tabella</span>';
                }
                
                // Save preference
                localStorage.setItem('trackingViewMode', currentView);
            });
            
            // Restore saved view
            const savedView = localStorage.getItem('trackingViewMode');
            if (savedView === 'timeline') {
                toggleBtn.click();
            }
        }
        
        // Load Timeline View
        async function loadTimelineView() {
            const timelineContent = document.getElementById('timelineContent');
            timelineContent.innerHTML = '<div class="sol-timeline-loading"><i class="fas fa-spinner fa-spin"></i> Caricamento timeline...</div>';
            
            try {
                // Use data from the existing trackings loaded by tracking/index.js
                const trackings = window.currentTrackings || [];
                
                if (trackings.length === 0) {
                    timelineContent.innerHTML = `
                        <div class="sol-timeline-empty">
                            <i class="fas fa-ship"></i>
                            <p>Nessun tracking da visualizzare</p>
                        </div>
                    `;
                    return;
                }
                
                // Generate timeline HTML
                let timelineHTML = '';
                
                // Group trackings by status for better visualization
                const groupedTrackings = groupTrackingsByStatus(trackings);
                
                for (const [status, statusTrackings] of Object.entries(groupedTrackings)) {
                    if (statusTrackings.length > 0) {
                        timelineHTML += `<div class="sol-timeline-group">
                            <h4 class="sol-timeline-group-title">${getStatusLabel(status)} (${statusTrackings.length})</h4>`;
                        
                        statusTrackings.forEach(tracking => {
                            timelineHTML += generateTrackingTimeline(tracking);
                        });
                        
                        timelineHTML += '</div>';
                    }
                }
                
                timelineContent.innerHTML = timelineHTML;
                
            } catch (error) {
                console.error('Error loading timeline:', error);
                timelineContent.innerHTML = '<div class="sol-timeline-empty">Errore nel caricamento della timeline</div>';
            }
        }
        
        // Group trackings by status
        function groupTrackingsByStatus(trackings) {
            const groups = {
                'delivered': [],
                'in_transit': [],
                'delayed': [],
                'registered': [],
                'exception': []
            };
            
            trackings.forEach(tracking => {
                const status = tracking.status || 'registered';
                if (groups[status]) {
                    groups[status].push(tracking);
                } else {
                    groups['exception'].push(tracking);
                }
            });
            
            return groups;
        }
        
        // Get status label in Italian
        function getStatusLabel(status) {
            const labels = {
                'delivered': 'Consegnati',
                'in_transit': 'In Transito',
                'delayed': 'In Ritardo',
                'registered': 'Registrati',
                'exception': 'Con Problemi'
            };
            return labels[status] || status;
        }
        
        // Generate HTML for tracking timeline
        function generateTrackingTimeline(tracking) {
            let html = `
                <div class="sol-timeline-tracking-card">
                    <div class="sol-tracking-card-header">
                        <div class="sol-tracking-info">
                            <span class="sol-tracking-number">${tracking.tracking_number}</span>
                            <span class="sol-tracking-type">${tracking.tracking_type || 'container'}</span>
                        </div>
                        <span class="sol-tracking-status status-${tracking.status}">${getStatusLabel(tracking.status)}</span>
                    </div>
                    <div class="sol-tracking-details">
                        <div class="sol-tracking-detail">
                            <span class="sol-tracking-detail-label">Vettore</span>
                            <span class="sol-tracking-detail-value">${tracking.carrier_code || 'N/A'}</span>
                        </div>
                        <div class="sol-tracking-detail">
                            <span class="sol-tracking-detail-label">Origine</span>
                            <span class="sol-tracking-detail-value">${tracking.metadata?.origin_name || tracking.metadata?.pol || 'N/A'}</span>
                        </div>
                        <div class="sol-tracking-detail">
                            <span class="sol-tracking-detail-label">Destinazione</span>
                            <span class="sol-tracking-detail-value">${tracking.metadata?.destination_name || tracking.metadata?.pod || 'N/A'}</span>
                        </div>
                        <div class="sol-tracking-detail">
                            <span class="sol-tracking-detail-label">ETA</span>
                            <span class="sol-tracking-detail-value">${tracking.eta ? new Date(tracking.eta).toLocaleDateString('it-IT') : 'N/A'}</span>
                        </div>
                    </div>
            `;
            
            // Check for timeline events in metadata
            const timelineEvents = tracking.metadata?.timeline_events || [];
            
            if (timelineEvents.length > 0) {
                // Use real events from metadata
                html += '<div class="sol-timeline-events">';
                
                timelineEvents.forEach((event, index) => {
                    const isLast = index === timelineEvents.length - 1;
                    html += generateTimelineEvent(event, isLast);
                });
                
                html += '</div>';
            } else {
                // Generate demo events based on status
                html += generateDemoTimeline(tracking);
            }
            
            html += '</div>';
            
            return html;
        }
        
        // Generate timeline event HTML
        function generateTimelineEvent(event, isLast) {
            const eventDate = new Date(event.date || event.event_date);
            const eventClass = getEventClass(event.type || event.event_type);
            
            return `
                <div class="sol-timeline-item ${eventClass} ${isLast ? 'last' : ''}">
                    <div class="sol-timeline-event">
                        <div class="sol-timeline-event-header">
                            <span class="sol-timeline-event-title">${event.title || event.description}</span>
                            <span class="sol-timeline-event-date">${eventDate.toLocaleDateString('it-IT')} ${eventDate.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        ${event.location || event.location_name ? `
                            <div class="sol-timeline-event-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${event.location || event.location_name}
                            </div>
                        ` : ''}
                        ${event.details ? `<div class="sol-timeline-event-description">${event.details}</div>` : ''}
                    </div>
                </div>
            `;
        }
        
        // Get event class based on type
        function getEventClass(eventType) {
            const typeMap = {
                'DELIVERED': 'delivered',
                'DISCHARGED': 'delivered',
                'DISCHARGED_FROM_VESSEL': 'delivered',
                'LOADED': 'in-transit',
                'LOADED_ON_VESSEL': 'in-transit',
                'DEPARTED': 'in-transit',
                'DEP': 'in-transit',
                'ARRIVED': 'in-transit',
                'ARR': 'in-transit',
                'DELAYED': 'delayed',
                'EXCEPTION': 'exception'
            };
            return typeMap[eventType] || '';
        }
        
        // Generate demo timeline (fallback when no real events)
        function generateDemoTimeline(tracking) {
            const events = [];
            const now = new Date();
            
            // Base events on status
            if (tracking.status === 'registered') {
                events.push({
                    title: 'Spedizione Registrata',
                    date: new Date(now - 1 * 24 * 60 * 60 * 1000),
                    location: tracking.origin_name,
                    description: 'Informazioni spedizione ricevute'
                });
            }
            
            if (tracking.status === 'in_transit' || tracking.status === 'delivered') {
                events.push({
                    title: 'Partenza dall\'Origine',
                    date: new Date(now - 5 * 24 * 60 * 60 * 1000),
                    location: tracking.origin_name,
                    description: 'Container caricato e nave partita'
                });
                
                events.push({
                    title: 'In Transito',
                    date: new Date(now - 3 * 24 * 60 * 60 * 1000),
                    location: 'Mare Mediterraneo',
                    description: 'Navigazione in corso'
                });
            }
            
            if (tracking.status === 'delivered') {
                events.push({
                    title: 'Arrivo a Destinazione',
                    date: new Date(now - 2 * 24 * 60 * 60 * 1000),
                    location: tracking.destination_name,
                    description: 'Nave arrivata e container scaricato'
                });
                
                events.push({
                    title: 'Consegnato',
                    date: new Date(now - 1 * 24 * 60 * 60 * 1000),
                    location: tracking.destination_name,
                    description: 'Container consegnato al destinatario',
                    class: 'delivered'
                });
            }
            
            let html = '<div class="sol-timeline-events">';
            
            events.forEach((event, index) => {
                const isLast = index === events.length - 1;
                html += `
                    <div class="sol-timeline-item ${event.class || ''} ${isLast ? 'last' : ''}">
                        <div class="sol-timeline-event">
                            <div class="sol-timeline-event-header">
                                <span class="sol-timeline-event-title">${event.title}</span>
                                <span class="sol-timeline-event-date">${event.date.toLocaleDateString('it-IT')}</span>
                            </div>
                            <div class="sol-timeline-event-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${event.location}
                            </div>
                            <div class="sol-timeline-event-description">${event.description}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            return html;
        }
        
        // Export functions to window for integration
        window.timelineView = {
            init: initViewToggle,
            refresh: loadTimelineView,
            isActive: () => currentView === 'timeline'
        };
        
        // Auto-init on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initViewToggle);
        } else {
            initViewToggle();
        }
    })();
    </script>

    <!-- ===== FIX 5: TEST MODAL SYSTEM FUNCTION ===== -->
    <script>
    // Test Modal System function
    window.testModalSystem = async function() {
        console.log('üß™ Testing Modal System...');
        
        // Wait for ModalSystem to be ready
        let attempts = 0;
        while (!window.ModalSystem && attempts < 10) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }
        
        if (!window.ModalSystem) {
            alert('‚ùå ModalSystem not available');
            return;
        }
        
        try {
            // Test 1: Simple Alert
            console.log('Test 1: Alert');
            await window.ModalSystem.alert({
                type: 'info',
                title: 'üß™ Test Alert',
                message: 'Modal system is working! Click OK to continue testing.'
            });
            
            // Test 2: Confirm Dialog
            console.log('Test 2: Confirm');
            const confirmResult = await window.ModalSystem.confirm({
                title: 'üß™ Test Confirm',
                message: 'Do you want to continue with more tests?',
                confirmText: 'Yes, Continue',
                cancelText: 'No, Stop'
            });
            
            if (!confirmResult) {
                console.log('‚úÖ Modal tests stopped by user');
                return;
            }
            
            // Test 3: Progress Modal
            console.log('Test 3: Progress');
            const progress = window.ModalSystem.progress({
                title: 'üß™ Test Progress',
                message: 'Testing progress modal...'
            });
            
            for (let i = 0; i <= 100; i += 10) {
                progress.update(i, `Processing... ${i}%`);
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            progress.close();
            
            // Test 4: Custom Modal with Buttons
            console.log('Test 4: Custom Modal');
            await new Promise(resolve => {
                window.ModalSystem.show({
                    title: 'üß™ Test Custom Modal',
                    content: `
                        <div style="text-align: center; padding: 20px;">
                            <p>This is a custom modal with multiple buttons.</p>
                            <p style="color: var(--sol-success); font-weight: bold;">‚úÖ All modal tests passed!</p>
                        </div>
                    `,
                    buttons: [
                        {
                            text: 'Test Notification',
                            class: 'sol-btn-glass',
                            onclick: () => {
                                if (window.NotificationSystem) {
                                    window.NotificationSystem.success('Notification test successful!');
                                }
                                return false; // Don't close modal
                            }
                        },
                        {
                            text: 'Finish Tests',
                            class: 'sol-btn-primary',
                            onclick: () => {
                                resolve();
                                return true; // Close modal
                            }
                        }
                    ]
                });
            });
            
            console.log('‚úÖ All modal tests completed successfully!');
            
            if (window.NotificationSystem) {
                window.NotificationSystem.success('üéâ Modal System Test Complete', {
                    subtitle: 'All modal types working correctly'
                });
            }
            
        } catch (error) {
            console.error('‚ùå Modal test failed:', error);
            alert('‚ùå Modal test failed: ' + error.message);
        }
    };

    // Clear Mock Data Function
    function clearMockData() {
        if (confirm('Cancellare tutti i dati di tracking? Questa azione non pu√≤ essere annullata.')) {
            localStorage.removeItem('trackings');
            localStorage.removeItem('mockTrackings');
            localStorage.removeItem('trackingColumns');
            localStorage.removeItem('trackingStatsOrder');
            localStorage.removeItem('trackingFilters');
            localStorage.removeItem('trackingViewMode');
            
            if (window.NotificationSystem?.success) {
                window.NotificationSystem.success('Dati cancellati con successo');
            }
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    }
    
    // Global assignment for onclick
    window.clearMockData = clearMockData;
    
    // Debug function for tracking system
    window.debugTrackingSystem = function() {
        console.log('üîç [DEBUG] TRACKING SYSTEM STATUS:');
        console.log('Papa:', typeof Papa !== 'undefined');
        console.log('XLSX:', typeof XLSX !== 'undefined');
        console.log('Header Component:', !!window.headerComponent);
        console.log('Table Manager:', !!window.TableManager);
        console.log('Modal System:', !!window.ModalSystem);
        console.log('Notification System:', !!window.NotificationSystem);
        console.log('Import Manager:', !!window.ImportManager);
        console.log('Tracking Init:', !!window.trackingInit);
        console.log('Current Trackings:', window.currentTrackings?.length || 0);
        
        // Check DOM elements
        console.log('Header in DOM:', !!document.querySelector('.sol-header'));
        console.log('Table Container:', !!document.getElementById('trackingTableContainer'));
        console.log('Add Button:', !!document.getElementById('addTrackingBtn'));
        console.log('Stats Grid:', !!document.getElementById('statsGrid'));
        
        // Check localStorage
        const stored = localStorage.getItem('trackings');
        console.log('LocalStorage trackings:', stored ? JSON.parse(stored).length : 0);
        
        // Try to force reload trackings
        if (window.loadTrackings) {
            console.log('üîÑ Forcing trackings reload...');
            window.loadTrackings();
        }
        
        if (window.NotificationSystem) {
            window.NotificationSystem.info('Debug info logged to console');
        }
    };
    </script>

    <!-- ===== FIX 6: MODAL SYSTEM DIAGNOSTICS ===== -->
    <script>
    // Modal system diagnostics
    window.debugModalSystem = function() {
        console.log('üîç Modal System Diagnostics:');
        console.log('- ModalSystem available:', !!window.ModalSystem);
        console.log('- NotificationSystem available:', !!window.NotificationSystem);
        
        if (window.ModalSystem) {
            if (typeof window.ModalSystem.debugInfo === 'function') {
                console.log('- Modal System Debug:', window.ModalSystem.debugInfo());
            } else {
                console.log('- Active Modals:', document.querySelectorAll('.sol-modal-overlay').length);
            }
        }
        
        if (window.NotificationSystem) {
            if (typeof window.NotificationSystem.getActiveNotifications === 'function') {
                console.log('- Active Notifications:', window.NotificationSystem.getActiveNotifications());
            } else {
                console.log('- Notification Container:', !!document.getElementById('notification-container'));
            }
        }
        
        console.log('- Import Manager:', !!window.ImportManager);
        console.log('- Tracking Service:', !!window.trackingService);
    };
    
    // Auto-run diagnostics in dev mode
    if (window.location.hostname === 'localhost' || window.location.search.includes('debug=true')) {
        setTimeout(() => {
            window.debugModalSystem();
        }, 3000);
    }
    </script>

</body>
</html>